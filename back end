
{
  "entities": {
    "Family": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Family",
      "type": "object",
      "description": "Represents a family unit within the application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Family entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the family."
        }
      },
      "required": [
        "id",
        "name"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user within the application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "familyId": {
          "type": "string",
          "description": "Reference to Family. (Relationship: Family 1:N User)"
        },
        "role": {
          "type": "string",
          "description": "Role of the user within the family (e.g., Adult, Kid, Admin)."
        },
        "email": {
          "type": "string",
          "description": "Email address of the user.",
          "format": "email"
        },
        "name": {
          "type": "string",
          "description": "Name of the user."
        }
      },
      "required": [
        "id",
        "familyId",
        "role",
        "email",
        "name"
      ]
    },
    "CalendarEvent": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "CalendarEvent",
      "type": "object",
      "description": "Represents an event on the family calendar.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the CalendarEvent entity."
        },
        "familyId": {
          "type": "string",
          "description": "Reference to Family. (Relationship: Family 1:N CalendarEvent)"
        },
        "title": {
          "type": "string",
          "description": "Title of the event."
        },
        "description": {
          "type": "string",
          "description": "Description of the event (generated by AI)."
        },
        "startTime": {
          "type": "string",
          "description": "Start time of the event.",
          "format": "date-time"
        },
        "endTime": {
          "type": "string",
          "description": "End time of the event.",
          "format": "date-time"
        },
        "assignedTo": {
          "type": "array",
          "description": "References to Users assigned to the event. (Relationship: User N:N CalendarEvent)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "familyId",
        "title",
        "description",
        "startTime",
        "endTime"
      ]
    },
    "Chore": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Chore",
      "type": "object",
      "description": "Represents a chore assigned to a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Chore entity."
        },
        "familyId": {
          "type": "string",
          "description": "Reference to Family. (Relationship: Family 1:N Chore)"
        },
        "name": {
          "type": "string",
          "description": "Name of the chore."
        },
        "description": {
          "type": "string",
          "description": "Description of the chore."
        },
        "points": {
          "type": "number",
          "description": "Points awarded for completing the chore."
        },
        "assignedTo": {
          "type": "string",
          "description": "Reference to User assigned to the chore. (Relationship: User 1:N Chore)"
        },
        "dueDate": {
          "type": "string",
          "description": "Due date for the chore.",
          "format": "date-time"
        },
        "calendarEventId": {
          "type": "string",
          "description": "Reference to CalendarEvent. (Relationship: CalendarEvent 1:N Chore)"
        }
      },
      "required": [
        "id",
        "familyId",
        "name",
        "description",
        "points",
        "assignedTo",
        "dueDate",
        "calendarEventId"
      ]
    },
    "SocialPost": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "SocialPost",
      "type": "object",
      "description": "Represents a social media post within the isolated social zone.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the SocialPost entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User who created the post. (Relationship: User 1:N SocialPost)"
        },
        "familyId": {
          "type": "string",
          "description": "Reference to Family. (Relationship: Family 1:N SocialPost)"
        },
        "content": {
          "type": "string",
          "description": "Content of the social media post."
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of when the post was created.",
          "format": "date-time"
        },
        "moderationStatus": {
          "type": "string",
          "description": "Status of the post after moderation (e.g., approved, rejected, pending)."
        }
      },
      "required": [
        "id",
        "userId",
        "familyId",
        "content",
        "timestamp",
        "moderationStatus"
      ]
    },
    "Recommendation": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Recommendation",
      "type": "object",
      "description": "Represents an AI-powered recommendation for the user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Recommendation entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User the recommendation is for. (Relationship: User 1:N Recommendation)"
        },
        "familyId": {
          "type": "string",
          "description": "Reference to Family. (Relationship: Family 1:N Recommendation)"
        },
        "type": {
          "type": "string",
          "description": "Type of recommendation (e.g., activity, event, chore)."
        },
        "description": {
          "type": "string",
          "description": "Description of the recommendation (generated by AI)."
        },
        "relevanceScore": {
          "type": "number",
          "description": "Score indicating the relevance of the recommendation to the user."
        }
      },
      "required": [
        "id",
        "userId",
        "familyId",
        "type",
        "description",
        "relevanceScore"
      ]
    },
    "BufferedThought": {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "title": "BufferedThought",
        "type": "object",
        "description": "Represents a thought or message that the AI has generated but is holding until an appropriate time to deliver.",
        "properties": {
            "id": { "type": "string", "description": "Unique identifier for the buffered thought." },
            "userId": { "type": "string", "description": "The user this thought is for." },
            "speech": { "type": "string", "description": "The textual content of the thought." },
            "mood": { "type": "string", "description": "The emotional context of the thought (e.g., 'helpful', 'witty', 'urgent')." },
            "urgency": { "type": "number", "description": "A score from 1-10 indicating the thought's importance." },
            "createdAt": { "type": "string", "format": "date-time", "description": "Timestamp of when the thought was generated." }
        },
        "required": ["id", "userId", "speech", "urgency", "createdAt"]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/families/{familyId}",
        "definition": {
          "entityName": "Family",
          "schema": {
            "$ref": "#/backend/entities/Family"
          },
          "description": "Stores family information. Root collection for all family-related data.",
          "params": [
            {
              "name": "familyId",
              "description": "Unique identifier for the family."
            }
          ]
        }
      },
      {
        "path": "/families/{familyId}/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user data within a family. Includes the denormalized 'familyId' and 'role' for authorization independence.",
          "params": [
            {
              "name": "familyId",
              "description": "Unique identifier for the family."
            },
            {
              "name": "userId",
              "description": "Unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "/families/{familyId}/calendar_events/{calendarEventId}",
        "definition": {
          "entityName": "CalendarEvent",
          "schema": {
            "$ref": "#/backend/entities/CalendarEvent"
          },
          "description": "Stores calendar events for a family. Includes the denormalized 'familyId' for authorization independence.",
          "params": [
            {
              "name": "familyId",
              "description": "Unique identifier for the family."
            },
            {
              "name": "calendarEventId",
              "description": "Unique identifier for the calendar event."
            }
          ]
        }
      },
      {
        "path": "/families/{familyId}/chores/{choreId}",
        "definition": {
          "entityName": "Chore",
          "schema": {
            "$ref": "#/backend/entities/Chore"
          },
          "description": "Stores chore data for a family. Includes the denormalized 'familyId' for authorization independence.",
          "params": [
            {
              "name": "familyId",
              "description": "Unique identifier for the family."
            },
            {
              "name": "choreId",
              "description": "Unique identifier for the chore."
            }
          ]
        }
      },
      {
        "path": "/families/{familyId}/social_posts/{postId}",
        "definition": {
          "entityName": "SocialPost",
          "schema": {
            "$ref": "#/backend/entities/SocialPost"
          },
          "description": "Stores social posts for a family. Includes denormalized 'userId' and 'familyId' for authorization independence and filtering.",
          "params": [
            {
              "name": "familyId",
              "description": "Unique identifier for the family."
            },
            {
              "name": "postId",
              "description": "Unique identifier for the social post."
            }
          ]
        }
      },
      {
        "path": "/families/{familyId}/users/{userId}/recommendations/{recommendationId}",
        "definition": {
          "entityName": "Recommendation",
          "schema": {
            "$ref": "#/backend/entities/Recommendation"
          },
          "description": "Stores recommendations for a specific user within a family. Includes the denormalized 'familyId' and 'userId' for authorization independence.",
          "params": [
            {
              "name": "familyId",
              "description": "Unique identifier for the family."
            },
            {
              "name": "userId",
              "description": "Unique identifier for the user."
            },
            {
              "name": "recommendationId",
              "description": "Unique identifier for the recommendation."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to address the application requirements for FamilyOS, emphasizing security, scalability, and ease of debugging. It leverages denormalization and structural segregation to achieve authorization independence, simplifying security rules and supporting robust list operations.\n\n**Authorization Independence:**\n\n*   Family data (users, calendar events, chores, social posts, recommendations) is stored under the `/families/{familyId}` path. This approach ensures all data related to a family is logically grouped. Each document within a family's subcollections (e.g., `/families/{familyId}/users/{userId}`) includes the `familyId` field. This denormalization enables security rules to verify family membership without requiring `get()` calls to parent documents, crucial for maintaining atomic operations and preventing race conditions.\n*   The `SocialPost` documents contain both `userId` and `familyId` to allow filtering posts by user or family, again without `get()` calls.\n\n**Structural Segregation:**\n\n*   User-specific data like recommendations are nested under `/families/{familyId}/users/{userId}/recommendations/{recommendationId}`, clearly associating recommendations with individual users within a family.\n*   The `/families/{familyId}/social_posts/{postId}` collection is dedicated to social posts. This segregation allows for specific moderation rules to be applied to social content, separate from other family data.\n\n**Access Modeling:**\n\n*   Path-based ownership is used for user-owned data within a family. For example, recommendations are stored under the user's document, enabling easy enforcement of rules like `request.auth.uid == resource.data.userId`.\n*   Roles are stored directly within the `/families/{familyId}/users/{userId}` documents, enabling role-based access control via rules like `resource.data.role == 'admin'`.\n\n**QAPs (Rules are not Filters):**\n\n*   The structure supports secure list operations. For example, listing calendar events for a family can be done securely by querying the `/families/{familyId}/calendar_events` collection, and security rules can ensure the requesting user is a member of that family.\n\nBy adhering to these principles, the Firestore structure provides a solid foundation for a scalable, secure, and maintainable application."
  }
}
