
'use client';

import React, { useEffect, useState, useRef, Suspense } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { doc, onSnapshot, getDoc, deleteDoc, setDoc, serverTimestamp, collection, query, where, orderBy, updateDoc, addDoc } from 'firebase/firestore';
import { useFirebase } from '@/firebase';
import { useRouter, useSearchParams } from 'next/navigation';
import { ShieldAlert, ZapOff, CheckCircle, Terminal } from 'lucide-react';

const CODE_LIFETIME_SECONDS = 60;

// --- Safety Overlay Component ---
const SafetyOverlay = ({ status }: { status: string | undefined }) => {
    const isOverheat = status === 'OVERHEAT_CRITICAL';
    const isHighCurrent = status === 'FIELD_INTENSITY_HIGH';
  
    return (
      <AnimatePresence>
        {(isOverheat || isHighCurrent) && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ 
              opacity: 1,
              backgroundColor: isOverheat ? "rgba(220, 38, 38, 0.25)" : "rgba(245, 158, 11, 0.15)"
            }}
            exit={{ opacity: 0 }}
            className="absolute inset-0 z-50 pointer-events-none border-[20px]"
            style={{ borderColor: isOverheat ? '#dc2626' : '#f59e0b' }}
          >
            <div className="flex flex-col items-center justify-center h-full">
              <motion.div
                animate={{ scale: [1, 1.05, 1] }}
                transition={{ repeat: Infinity, duration: 1 }}
                className="bg-black/80 p-8 rounded-2xl border-4 border-current flex flex-col items-center justify-center"
                style={{ color: isOverheat ? '#dc2626' : '#f59e0b' }}
              >
                {isOverheat ? <ZapOff size={64} /> : <ShieldAlert size={64} />}
                <h2 className="text-4xl font-black mt-4 uppercase tracking-tight text-center">
                  {isOverheat ? "Safety Shutdown" : "Field Throttling"}
                </h2>
                <p className="text-white/70 mt-2 text-sm font-mono text-center uppercase tracking-wide max-w-xs">
                  {isOverheat
                    ? "Critical Thermal Threshold Reached"
                    : "Current Spike Detected â€” Duty Cycle Auto-Scaled"}
                </p>
              </motion.div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    );
};

// --- Command Listener Hook ---
const useCommandListener = (firestore) => {
    const [commandLog, setCommandLog] = useState([]);

    useEffect(() => {
        if (!firestore) return;

        const commandsRef = collection(firestore, 'sov_commands');
        const q = query(commandsRef, where('status', '==', 'pending'), orderBy('timestamp', 'asc'));

        const unsubscribe = onSnapshot(q, (snapshot) => {
            snapshot.docChanges().forEach(async (change) => {
                if (change.type === 'added') {
                    const commandData = change.doc.data();
                    const commandId = change.doc.id;

                    const logEntry = `[${new Date().toLocaleTimeString()}] Received command: ${commandData.action}`;
                    setCommandLog(prev => [logEntry, ...prev.slice(0, 10)]);

                    let responseMessage = '';
                    if (commandData.action.includes('CHARGE') || commandData.action.includes('POWER')) {
                        responseMessage = 'Forge Active. Power transfer initiated.';
                    } else if (commandData.action.includes('LOCATE')) {
                        responseMessage = 'Home Universe Located. Session is stable.';
                    } else {
                        responseMessage = `Unknown command processed: ${commandData.action}`;
                    }

                    await updateDoc(doc(firestore, 'sov_commands', commandId), { status: 'executed' });

                    await addDoc(collection(firestore, 'sov_responses'), {
                        commandId,
                        status: 'executed',
                        message: responseMessage,
                        timestamp: serverTimestamp(),
                        origin: 'HOME_HUB'
                    });
                }
            });
        });

        return () => unsubscribe();
    }, [firestore]);

    return commandLog;
};


function TVSpectrogramContent({ pairCode, isSimulated = false }) {
  const { firestore } = useFirebase();
  const [sessionData, setSessionData] = useState<any>(null);
  const [isLocked, setIsLocked] = useState(false);
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const pointsRef = useRef<{ x: number, y: number }[]>([]);
  const commandLog = useCommandListener(firestore); // Use the command listener hook

  // Listen for the "Jump" from the Phone (or simulator)
  useEffect(() => {
    if (!firestore || !pairCode) return;
    const docRef = doc(firestore, 'pairCodes', pairCode);

    const unsubscribe = onSnapshot(docRef, (snap) => {
      if (snap.exists()) {
        const data = snap.data();
        setSessionData(data);
        
        if (data.status === 'locked' && !isLocked) {
          setIsLocked(true);
          setTimeout(() => setIsLocked(false), 2000);
        }
      }
    });
    return () => unsubscribe();
  }, [firestore, pairCode, isLocked]);

  // High-Performance Canvas Rendering (Spectrogram)
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas || !sessionData?.amplitude) return;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    let animationFrameId: number;

    const render = () => {
      ctx.fillStyle = 'rgba(0, 0, 0, 0.1)'; 
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      const height = (sessionData.amplitude / 100) * canvas.height;
      const x = (sessionData.currentFreq / 25000) * canvas.width;
      
      pointsRef.current.push({ x, y: canvas.height - height });
      if (pointsRef.current.length > 200) pointsRef.current.shift();

      ctx.beginPath();
      ctx.strokeStyle = '#6366f1';
      ctx.lineWidth = 3;
      ctx.shadowBlur = 15;
      ctx.shadowColor = '#6366f1';
      
      if(pointsRef.current.length > 0){
        ctx.moveTo(pointsRef.current[0]?.x, pointsRef.current[0]?.y);
        pointsRef.current.forEach((p) => {
          ctx.lineTo(p.x, p.y);
        });
        ctx.stroke();
      }

      animationFrameId = requestAnimationFrame(render);
    };

    animationFrameId = requestAnimationFrame(render);
    return () => cancelAnimationFrame(animationFrameId);
  }, [sessionData]);

  return (
    <div className="flex flex-col items-center justify-center h-screen w-screen bg-black text-white p-8">
      <SafetyOverlay status={sessionData?.safetyStatus} />
      <canvas ref={canvasRef} width={1920} height={1080} className="border border-indigo-500/20 rounded-lg shadow-lg w-full h-[60vh] object-contain" />
      <div className="mt-8 text-center w-full max-w-4xl bg-black/50 p-4 rounded-xl backdrop-blur-md grid grid-cols-3 gap-4">
        <div>
            <h2 className="text-sm font-bold text-slate-400">Current Frequency</h2>
            <p className="text-xl font-black tracking-wider text-white">{sessionData?.currentFreq || 0} Hz</p>
        </div>
        <div>
            <h2 className="text-sm font-bold text-slate-400">Signal Status</h2>
            <p className={`text-xl font-black tracking-wider ${sessionData?.status === 'locked' ? 'text-green-400' : 'text-yellow-400'}`}>{sessionData?.status || 'PENDING'}</p>
        </div>
        <div className="bg-slate-900/50 rounded-lg p-2 max-h-24 overflow-y-auto">
            <p className="text-[10px] font-mono text-cyan-400 text-left">
                {commandLog.map((log, i) => <span key={i} className="block">{log}</span>)}
            </p>
        </div>
      </div>
    </div>
  );
}

function TVPairingPage() {
  const { firestore } = useFirebase();
  const router = useRouter();

  const [pairCode, setPairCode] = useState('');
  const [countdown, setCountdown] = useState(CODE_LIFETIME_SECONDS);
  const codeLifetimeIntervalRef = useRef<NodeJS.Timeout | null>(null);

  const generateCode = useCallback(() => {
    return Math.random().toString(36).substring(2, 8).toUpperCase();
  }, []);

  useEffect(() => {
    const newCode = generateCode();
    setPairCode(newCode);
    setCountdown(CODE_LIFETIME_SECONDS);

    if (codeLifetimeIntervalRef.current) clearInterval(codeLifetimeIntervalRef.current);

    codeLifetimeIntervalRef.current = setInterval(() => {
      setCountdown(prev => {
        if (prev <= 1) {
          const freshCode = generateCode();
          setPairCode(freshCode);
          return CODE_LIFETIME_SECONDS;
        }
        return prev - 1;
      });
    }, 1000);

    return () => {
      if (codeLifetimeIntervalRef.current) clearInterval(codeLifetimeIntervalRef.current);
    };
  }, [generateCode]);
  
  useEffect(() => {
    if (!firestore || !pairCode) return;
    const docRef = doc(firestore, 'pairCodes', pairCode);
    
    setDoc(docRef, { 
        createdAt: serverTimestamp(),
        status: 'pending',
        claimedBy: null
    }).catch(err => console.error("Error creating pairing code doc:", err));

    const unsubscribe = onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) {
            const data = docSnap.data();
            if (data.status === 'claimed' && data.claimedBy) {
                router.push(`/tv?pairCode=${pairCode}`);
            }
        }
    });

    return () => {
      unsubscribe();
      const tempDocRef = doc(firestore, 'pairCodes', pairCode);
      getDoc(tempDocRef).then(snap => {
          if (snap.exists() && snap.data()?.status !== 'claimed') {
              deleteDoc(tempDocRef).catch(()=>{});
          }
      }).catch(()=>{});
    };
  }, [firestore, pairCode, router]);

  return (
    <div className="flex h-screen w-screen flex-col items-center justify-center bg-black text-white antialiased">
      <div className="absolute inset-0 -z-10 overflow-hidden">
        <div className="absolute inset-0 bg-[radial-gradient(ellipse_80%_80%_at_50%_-20%,rgba(79,70,229,0.3),rgba(255,255,255,0))] opacity-40" />
      </div>
      <motion.div initial={{ opacity: 0, scale: 0.8 }} animate={{ opacity: 1, scale: 1 }} className="relative flex h-80 w-80 items-center justify-center rounded-full">
        <div className="absolute rounded-full border-8 border-indigo-500/40 animate-pulse w-80 h-80 sm:w-96 sm:h-96" />
        <div className="absolute rounded-full border-4 border-indigo-400/60 w-64 h-64 sm:w-80 sm:h-80 animate-ping" />
        <div className="relative z-10 flex flex-col items-center justify-center rounded-full border border-indigo-500/50 bg-slate-900/80 p-8 text-center shadow-2xl backdrop-blur-xl">
          <h1 className="text-5xl sm:text-7xl font-black tracking-widest text-indigo-400">
            {pairCode.split('').map((char, i) => (
              <motion.span key={i} initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.5 + i * 0.1 }}>{char}</motion.span>
            ))}
          </h1>
          <p className="mt-4 text-lg text-indigo-300 font-mono">
            Expires in {countdown}s
          </p>
        </div>
      </motion.div>
      <div className="mt-20 text-center">
          <h2 className="text-xl font-bold tracking-tight">Open the Pebble App on your phone</h2>
          <p className="mt-2 text-slate-400">Enter the code above to summon the OS to this screen.</p>
      </div>
    </div>
  );
}

function PageContent() {
  const searchParams = useSearchParams();
  const pairCode = searchParams.get('pairCode');
  const isSimulated = searchParams.get('sim') === 'true';

  if (pairCode || isSimulated) {
    return <TVSpectrogramContent pairCode={pairCode} isSimulated={isSimulated} />;
  }

  return <TVPairingPage />;
}

export default function TVPageWrapper() {
  return (
    <Suspense fallback={<div className="bg-black text-white flex items-center justify-center h-screen">Initializing TV Hub...</div>}>
      <PageContent />
    </Suspense>
  )
}


@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    --background: 234 67% 94%;
    --foreground: 231 20% 15%;
    --card: 0 0% 100%;
    --card-foreground: 231 20% 15%;
    --popover: 0 0% 100%;
    --popover-foreground: 231 20% 15%;
    --primary: 231 48% 48%;
    --primary-foreground: 0 0% 98%;
    --secondary: 231 40% 90%;
    --secondary-foreground: 231 20% 10%;
    --muted: 231 40% 90%;
    --muted-foreground: 231 20% 45%;
    --accent: 37 100% 62%;
    --accent-foreground: 231 20% 10%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 0 0% 98%;
    --border: 231 20% 88%;
    --input: 231 20% 91%;
    --ring: 231 48% 48%;
    --chart-1: 12 76% 61%;
    --chart-2: 173 58% 39%;
    --chart-3: 197 37% 24%;
    --chart-4: 43 74% 66%;
    --chart-5: 27 87% 67%;
    --radius: 0.5rem;
  }

  .dark {
    --background: 231 20% 10%;
    --foreground: 0 0% 98%;
    --card: 231 20% 10%;
    --card-foreground: 0 0% 98%;
    --popover: 231 20% 10%;
    --popover-foreground: 0 0% 98%;
    --primary: 231 48% 55%;
    --primary-foreground: 0 0% 98%;
    --secondary: 231 20% 20%;
    --secondary-foreground: 0 0% 98%;
    --muted: 231 20% 20%;
    --muted-foreground: 0 0% 63.9%;
    --accent: 37 100% 62%;
    --accent-foreground: 231 20% 10%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 0 0% 98%;
    --border: 231 20% 25%;
    --input: 231 20% 25%;
    --ring: 231 48% 55%;
    --chart-1: 220 70% 50%;
    --chart-2: 160 60% 45%;
    --chart-3: 30 80% 55%;
    --chart-4: 280 65% 60%;
    --chart-5: 340 75% 55%;
  }
}

@layer base {
  * {
    @apply border-border;
  }
  html, body {
    @apply h-full overflow-hidden;
  }
  body {
    @apply bg-background text-foreground;
  }
}

/* Disable long-press context menus so they don't break your Pebble timers */
* {
  -webkit-touch-callout: none; /* iOS Safari */
  -webkit-user-select: none;   /* Safari */
  user-select: none;           /* Standard syntax */
  -webkit-tap-highlight-color: transparent; /* Remove the grey flash on tap */
}

/* Re-enable selection for inputs if you have any in your modals */
input, textarea {
  -webkit-user-select: text;
  user-select: text;
}


import type { Metadata } from 'next';
import './globals.css';
import { FirebaseClientProvider } from '@/firebase';
import { FamilyDataProvider } from '@/contexts/FamilyDataContext';
import { Suspense } from 'react';
import { ToastProvider } from '@/components/ui/toast-provider';

export const metadata: Metadata = {
  title: 'Sovereign OS',
  description: 'The operating system for your family, and your life.',
  manifest: '/manifest.json',
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en" suppressHydrationWarning>
      <head>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossOrigin="anonymous" />
        <link
          href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap"
          rel="stylesheet"
        />
        <meta name="application-name" content="Sovereign OS" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <meta name="apple-mobile-web-app-title" content="Sovereign OS" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="mobile-web-app-capable" content="yes" />
        <meta name="theme-color" content="#030308" />
        <link rel="manifest" href="/manifest.json" />
        <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />
      </head>
      <body className="font-body antialiased">
        <FirebaseClientProvider>
          <FamilyDataProvider>
            <ToastProvider>
              {children}
            </ToastProvider>
          </FamilyDataProvider>
        </FirebaseClientProvider>
      </body>
    </html>
  );
}

import Image from 'next/image';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
} from '@/components/ui/card';
import {
  Users,
  CalendarDays,
  HeartHandshake,
  Sparkles,
  ArrowRight,
} from 'lucide-react';
import { placeholderImages } from '@/lib/placeholder-images';

const features = [
  {
    icon: <CalendarDays className="size-8 text-primary" />,
    title: 'Shared Calendar',
    description:
      "Organize your family's life with an intelligent calendar that adapts to everyone's needs.",
  },
  {
    icon: <Users className="size-8 text-primary" />,
    title: 'Kids Social Zone',
    description:
      'A safe and private social space for kids, with AI-powered content moderation to ensure a positive environment.',
  },
  {
    icon: <HeartHandshake className="size-8 text-primary" />,
    title: 'Family CRM',
    description:
      'Manage chores, rewards, and family goals in one place, fostering responsibility and teamwork.',
  },
  {
    icon: <Sparkles className="size-8 text-primary" />,
    title: 'AI Recommendations',
    description:
      'Discover new family activities and events with personalized suggestions powered by AI.',
  },
];

export default function LandingPage() {
  const heroImage = placeholderImages.find((p) => p.id === 'landing-hero');

  return (
    <div className="flex flex-col min-h-screen bg-background">
      <header className="sticky top-0 z-50 w-full border-b border-border/40 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
        <div className="container flex h-14 items-center">
          <Link href="/" className="flex items-center gap-2 font-bold text-lg">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              strokeWidth="2"
              strokeLinecap="round"
              strokeLinejoin="round"
              className="size-6 text-primary"
            >
              <path d="M12 2L2 7l10 5 10-5-10-5z" />
              <path d="M2 17l10 5 10-5" />
              <path d="M2 12l10 5 10-5" />
            </svg>
            <span className="font-headline">FamilyOS</span>
          </Link>
          <nav className="ml-auto flex items-center gap-4">
            <Button variant="ghost" asChild>
              <Link href="/login">Log In</Link>
            </Button>
            <Button asChild>
              <Link href="/login">
                Get Started <ArrowRight className="ml-2 size-4" />
              </Link>
            </Button>
          </nav>
        </div>
      </header>

      <main className="flex-1">
        <section className="py-16 md:py-24 lg:py-32">
          <div className="container grid md:grid-cols-2 gap-12 items-center">
            <div className="space-y-6">
              <h1 className="text-4xl md:text-5xl lg:text-6xl font-bold font-headline tracking-tighter">
                The operating system for modern family life.
              </h1>
              <p className="text-lg text-muted-foreground">
                FamilyOS brings harmony to your home with a shared calendar,
                safe social spaces for kids, and AI-powered tools to simplify your
                daily routines.
              </p>
              <Button size="lg" asChild>
                <Link href="/login">
                  Start Organizing Your Family
                  <ArrowRight className="ml-2 size-5" />
                </Link>
              </Button>
            </div>
            <div className="rounded-lg overflow-hidden shadow-2xl">
              {heroImage && (
                <Image
                  src={heroImage.imageUrl}
                  alt={heroImage.description}
                  width={600}
                  height={400}
                  className="w-full object-cover"
                  data-ai-hint={heroImage.imageHint}
                />
              )}
            </div>
          </div>
        </section>

        <section id="features" className="py-16 md:py-24 lg:py-32 bg-card">
          <div className="container">
            <div className="text-center space-y-4 mb-12">
              <h2 className="text-3xl md:text-4xl font-bold font-headline">
                Everything Your Family Needs
              </h2>
              <p className="text-lg max-w-2xl mx-auto text-muted-foreground">
                Discover a suite of tools designed to connect your family and
                simplify your life.
              </p>
            </div>
            <div className="grid sm:grid-cols-2 lg:grid-cols-4 gap-8">
              {features.map((feature) => (
                <Card
                  key={feature.title}
                  className="bg-background text-center p-6 border-0 shadow-lg hover:shadow-xl transition-shadow"
                >
                  <CardHeader className="items-center">
                    <div className="p-4 bg-primary/10 rounded-full mb-4">
                      {feature.icon}
                    </div>
                    <CardTitle className="font-headline text-xl">
                      {feature.title}
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <p className="text-muted-foreground">
                      {feature.description}
                    </p>
                  </CardContent>
                </Card>
              ))}
            </div>
          </div>
        </section>
      </main>

      <footer className="py-8 bg-card border-t">
        <div className="container flex flex-col md:flex-row items-center justify-between gap-4">
          <p className="text-sm text-muted-foreground">
            &copy; {new Date().getFullYear()} FamilyOS. All rights reserved.
          </p>
          <div className="flex items-center gap-2 font-bold">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              strokeWidth="2"
              strokeLinecap="round"
              strokeLinejoin="round"
              className="size-5 text-primary"
            >
              <path d="M12 2L2 7l10 5 10-5-10-5z" />
              <path d="M2 17l10 5 10-5" />
              <path d="M2 12l10 5 10-5" />
            </svg>
            <span className="font-headline">FamilyOS</span>
          </div>
        </div>
      </footer>
    </div>
  );
}

