'use client';

import { useMemo, useState, useEffect } from 'react';
import { useSearchParams } from 'next/navigation';
import { doc, collection } from 'firebase/firestore';
import { motion, AnimatePresence } from 'framer-motion';
import Link from 'next/link';

import { useFirestore, useUser, useDoc, useCollection, useMemoFirebase } from '@/firebase';
import { Button } from '@/components/ui/button';
import { 
    Users, Shield, Zap, History, FileText, CheckCircle, 
    XCircle, Clock, Smartphone, Tv, Anchor, BrainCircuit, Calendar, 
    ChevronRight, Globe, Activity, Database, KeyRound, Wifi, HardDrive, Loader2, X, ArrowLeft
} from 'lucide-react';

type SystemStatus = 'PENDING' | 'CONNECTED' | 'VERIFIED' | 'LIVE' | 'BROKEN' | 'SYNCING';

// --- Reusable Audit Components ---

const StatusIndicator = ({ label, state }: { label: string; state: SystemStatus }) => {
  const config = {
    LIVE: { color: 'bg-green-500', pulse: true },
    CONNECTED: { color: 'bg-green-500', pulse: false },
    VERIFIED: { color: 'bg-green-500', pulse: false },
    SYNCING: { color: 'bg-yellow-500', pulse: true },
    PENDING: { color: 'bg-yellow-500', pulse: false },
    BROKEN: { color: 'bg-red-500', pulse: true },
  };

  return (
    <div className="flex items-center gap-2">
      <div className={`w-2 h-2 rounded-full ${config[state]?.color || 'bg-gray-500'} ${config[state]?.pulse ? 'animate-pulse' : ''}`} />
      <span className="text-gray-400 text-xs font-mono">{label}: <span className="text-white font-bold">{state}</span></span>
    </div>
  );
}

const DossierDetail = ({ icon: Icon, label, value }) => (
    <div className="flex items-center gap-3 p-3 bg-slate-900/50 rounded-lg">
        <Icon className="w-5 h-5 text-indigo-400" />
        <div className="flex-1">
            <p className="text-xs text-slate-400">{label}</p>
            <p className="text-xs font-bold text-white">{value}</p>
        </div>
    </div>
);


const FamilyCoreCard = ({ familyCore, onClick, isActive }) => {
    const { familyName, members } = familyCore.data;
    
    const { registeredMembers, primaryParent, consentAgreed, integrityScore } = useMemo(() => {
        const regMembers = Object.values(members || {}).filter((m: any) => m.name && m.name !== 'Awaiting User...' && m.dob);
        const pParent = regMembers.find((m: any) => m.relationshipRole === 'parent_primary');
        const cAgreed = pParent?.consent?.masterAgreement === true;
        
        let score = 0;
        if (familyName && familyName !== 'Awaiting Registry') score += 10;
        if (regMembers.length >= 2) score += 40;
        if (cAgreed) score += 50;

        return { registeredMembers: regMembers, primaryParent: pParent, consentAgreed: cAgreed, integrityScore: score };
    }, [members, familyName]);

    const integrityColor = integrityScore > 80 ? 'text-green-400' : integrityScore > 40 ? 'text-yellow-400' : 'text-red-400';
    const parentsCount = useMemo(() => registeredMembers.filter(m => m.type === 'parent').length, [registeredMembers]);
    const childrenCount = useMemo(() => registeredMembers.filter(m => m.type === 'child').length, [registeredMembers]);
    
    return (
        <motion.div 
            layoutId={familyCore.id}
            onClick={() => onClick(familyCore)}
            whileHover={{ y: -8, scale: 1.05 }}
            className={`relative p-6 bg-slate-900 border-2 rounded-3xl cursor-pointer group transition-all duration-300 ${isActive ? 'border-primary shadow-2xl shadow-primary/20' : 'border-slate-800 hover:border-slate-700'}`}
        >
             <div className="flex justify-between items-start">
                <div>
                    <h3 className="text-lg font-black text-white italic tracking-tighter">{familyName || 'Awaiting Registry'}</h3>
                    <p className="text-[9px] font-mono text-slate-500">ID: {familyCore.id.slice(-12)}</p>
                </div>
                <div className="px-3 py-1 bg-green-500/10 border border-green-500/20 text-green-400 text-[10px] font-bold uppercase tracking-widest rounded-full flex items-center gap-2">
                    <div className="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse" />
                    LIVE
                </div>
             </div>
             
             <div className="mt-6 grid grid-cols-2 gap-4 text-center">
                <div>
                    <p className="text-4xl font-black">{registeredMembers.length}</p>
                    <p className="text-xs font-bold text-slate-500 uppercase tracking-widest">Members</p>
                </div>
                 <div>
                    <p className={`text-4xl font-black ${integrityColor}`}>{integrityScore}%</p>
                    <p className="text-xs font-bold text-slate-500 uppercase tracking-widest">Integrity</p>
                </div>
             </div>
             
             <AnimatePresence>
                <motion.div 
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    exit={{ opacity: 0 }}
                    className="absolute inset-x-0 bottom-0 top-auto p-4 bg-black/50 backdrop-blur-lg rounded-b-3xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 space-y-2"
                >
                    <DossierDetail icon={Users} label="Members" value={`${parentsCount} Parents, ${childrenCount} Children`} />
                    <DossierDetail icon={FileText} label="Contracts" value={consentAgreed ? 'Master Agreement Confirmed' : 'Pending Signature'} />
                    <DossierDetail icon={Shield} label="Sandbox" value="Provisioned & Isolated" />
                </motion.div>
             </AnimatePresence>
        </motion.div>
    )
}

// --- MAIN PAGE COMPONENT ---

export default function SandboxAuditPage() {
  const searchParams = useSearchParams();
  const sessionId = searchParams?.get('sessionId') as string | undefined;

  const firestore = useFirestore();
  const { user, isUserLoading, userError } = useUser();
  const [selectedFamily, setSelectedFamily] = useState<any>(null);

  const universesQuery = useMemoFirebase(() => (!firestore ? null : collection(firestore, 'familyCores')), [firestore]);
  const { data: allUniverses, isLoading: isLoadingUniverses } = useCollection(universesQuery);

  const authStatus: SystemStatus = useMemo(() => {
    if (isUserLoading) return 'PENDING';
    if (userError || !user) return 'BROKEN';
    return 'VERIFIED';
  }, [isUserLoading, user, userError]);

  useEffect(() => {
    if(sessionId && allUniverses) {
        const activeFamily = allUniverses.find(core => core.id === sessionId);
        if(activeFamily) {
            setSelectedFamily(activeFamily);
        }
    }
  }, [sessionId, allUniverses]);
  
  const DossierPanel = ({ familyCore, onClose }) => {
    if (!familyCore) return null;
    const { familyName, members } = familyCore.data;
    
    const registeredMembers = Object.values(members || {}).filter((m: any) => m.name && m.name !== 'Awaiting User...' && m.dob);
    const primaryParent = registeredMembers.find((m: any) => m.relationshipRole === 'parent_primary');
    const consentAgreed = primaryParent?.consent?.masterAgreement === true;
    const parentsCount = registeredMembers.filter(m => m.type === 'parent').length;
    const childrenCount = registeredMembers.filter(m => m.type === 'child').length;
    
    return (
        <motion.div 
            initial={{ opacity: 0 }} 
            animate={{ opacity: 1 }} 
            exit={{ opacity: 0 }}
            className="fixed inset-0 bg-black/70 backdrop-blur-md z-50 flex items-center justify-center"
            onClick={onClose}
        >
            <motion.div 
                layoutId={familyCore.id}
                onClick={(e) => e.stopPropagation()}
                className="w-full max-w-lg bg-slate-900 border-2 border-indigo-500/50 rounded-3xl p-8 shadow-2xl shadow-indigo-900/50"
            >
                <div className="flex justify-between items-start mb-6">
                    <div>
                        <h3 className="text-2xl font-black text-white italic tracking-tighter">{familyName}</h3>
                        <p className="text-xs font-mono text-slate-500">DOSSIER // {familyCore.id.slice(-12)}</p>
                    </div>
                    <button onClick={onClose} className="p-2 bg-slate-800 rounded-full hover:bg-slate-700">
                        <X size={16}/>
                    </button>
                </div>
                <div className="space-y-4">
                     <DossierDetail icon={Users} label="Member Breakdown" value={`${parentsCount} Parents, ${childrenCount} Children`} />
                     <DossierDetail icon={FileText} label="Contracts Signed" value={consentAgreed ? 'Master Agreement Confirmed' : 'Pending Guardian Signature'} />
                     <DossierDetail icon={Shield} label="Sandbox Status" value="Provisioned & Isolated" />
                     <DossierDetail icon={HardDrive} label="Data Allocation" value="1.2 TB Sovereign Cloud" />
                     <DossierDetail icon={BrainCircuit} label="Pebble AI" value="Synchronized & Learning" />
                     <DossierDetail icon={Wifi} label="Network Link" value="Active (TVWS)" />
                </div>
                 <Link href={`/admin/dashboard/satellite-view?lat=${familyCore.data.lat || 46.49}&lng=${familyCore.data.lng || -80.99}`}>
                    <Button variant="outline" className="w-full mt-8">View on Global Map <ChevronRight className="ml-2 w-4 h-4"/></Button>
                </Link>
            </motion.div>
        </motion.div>
    );
  }

  return (
    <div className="relative min-h-screen w-screen overflow-y-auto bg-slate-950 text-white font-sans p-4 sm:p-8">
      <div className="absolute inset-0 z-0 opacity-[0.03] pointer-events-none bg-[linear-gradient(to_right,#fff_1px,transparent_1px),linear-gradient(to_bottom,#fff_1px,transparent_1px)] bg-[size:60px_60px]" />

      {/* SYSTEM TRUTH INDICATOR */}
      <div className="fixed top-0 left-0 right-0 z-50 bg-black/50 text-white text-sm px-4 py-2 flex gap-6 backdrop-blur-sm border-b border-white/10">
        <StatusIndicator label="Network" state={'CONNECTED'} />
        <StatusIndicator label="Auth" state={authStatus} />
        <StatusIndicator label="Database" state={isLoadingUniverses ? 'SYNCING' : 'LIVE'} />
        <div className="flex-1 text-right flex items-center justify-end gap-6">
          <span className="font-mono text-xs">{isLoadingUniverses ? '...' : allUniverses?.length || 0} Registered Universes</span>
        </div>
      </div>

      <div className="pt-16 max-w-7xl mx-auto">
        
        <div className="mb-8">
            <Link href="/admin/dashboard">
                <Button variant="outline" className="bg-slate-800 border-slate-700 hover:bg-slate-700">
                    <ArrowLeft className="mr-2 w-4 h-4" /> Back to Dashboard
                </Button>
            </Link>
        </div>

        <header className="mb-12 text-center">
          <h1 className="text-5xl font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-400">
            Sandbox Audit
          </h1>
          <p className="text-slate-400 mt-2 text-sm">Live status of all provisioned family universes on the Sovereign Network.</p>
        </header>

        {isLoadingUniverses && (
            <div className="text-center p-20">
                <Loader2 className="w-12 h-12 text-indigo-500 animate-spin mx-auto"/>
                <p className="mt-4 text-slate-500">Connecting to Audit Ledger...</p>
            </div>
        )}

        {!isLoadingUniverses && (!allUniverses || allUniverses.length === 0) && (
            <div className="text-center p-20 bg-slate-900 rounded-3xl border-2 border-dashed border-slate-700">
                <Users className="w-16 h-16 text-slate-700 mx-auto mb-4"/>
                <h3 className="text-xl font-bold text-slate-400">No Family Cores Detected</h3>
                <p className="text-slate-500 mt-2">Complete a registration flow to provision a new universe.</p>
                 <Link href="/login/registration">
                    <Button variant="outline" className="mt-6">Go to Registration</Button>
                </Link>
            </div>
        )}

        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            {allUniverses?.map((core) => (
                <FamilyCoreCard key={core.id} familyCore={core} onClick={setSelectedFamily} isActive={sessionId === core.id} />
            ))}
        </div>
        
        <AnimatePresence>
            {selectedFamily && <DossierPanel familyCore={selectedFamily} onClose={() => setSelectedFamily(null)} />}
        </AnimatePresence>
      </div>
    </div>
  );
}
