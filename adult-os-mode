'use client';

import React, { useState, useEffect, useRef, useMemo, Suspense, useContext } from 'react';
import { 
  Shield, Zap, X, Search, User, Plus, Heart, 
  Calendar as CalendarIcon, Edit3, 
  Phone, MessageSquare, LayoutGrid, CloudSun, MapPin, 
  Users, AppWindow, Mic, Send, Activity, BrainCircuit,
  Terminal, Sparkles, Globe, Fingerprint, ArrowLeft, RotateCw, Cpu, Clock, HardHat,
  Briefcase, Landmark, Wallet, Video, Music, Radio, Palette, FileText, Sheet, Calculator, Camera,
  Star, HeartPulse, Share2, PowerOff, Eye as EyeIcon, Power as PowerIcon, EyeOff as EyeOffIcon
} from 'lucide-react';
import Image from 'next/image';
import { intelligentSpeak } from '@/ai/flows/tts-flow';
import Link from 'next/link';
import { motion, AnimatePresence } from 'framer-motion';
import { useToast } from '@/hooks/use-toast';
import { useParams, useRouter } from 'next/navigation';
import { FamilyDataContext, FamilyDataProvider } from '@/contexts/FamilyDataContext';


const AppContent = () => {
  const params = useParams();
  const userId = params.userId as string;
  const { familyMembers } = useContext(FamilyDataContext);
  const router = useRouter();
  
  // --- UI & Navigation State ---
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const [activeStage, setActiveStage] = useState(0); 
  const [activeBrowserUrl, setActiveBrowserUrl] = useState(null);
  const [isPhoneModalOpen, setIsPhoneModalOpen] = useState(false);
  const [isMessageModalOpen, setIsMessageModalOpen] = useState(false);
  const [isContactsModalOpen, setIsContactsModalOpen] = useState(false);
  const [isReloading, setIsReloading] = useState(false);
  const [isProfileModalOpen, setIsProfileModalOpen] = useState(false);
  const [isPedlleTtsModalOpen, setIsPedlleTtsModalOpen] = useState(false);
  const [isHealthModalOpen, setIsHealthModalOpen] = useState(false);
  const [isCameraModalOpen, setIsCameraModalOpen] = useState(false);
  const [isMapModalOpen, setIsMapModalOpen] = useState(false);
  const [isAppStoreModalOpen, setIsAppStoreModalOpen] = useState(false);
  const [isMyWorkModalOpen, setIsMyWorkModalOpen] = useState(false);
  const [isBankingAppModalOpen, setIsBankingAppModalOpen] = useState(false);
  const [isMyPersonalBankModalOpen, setIsMyPersonalBankModalOpen] = useState(false);
  const [isSovereignInternetModalOpen, setIsSovereignInternetModalOpen] = useState(false);
  const [isMyAdultPebbleModalOpen, setIsMyAdultPebbleModalOpen] = useState(false);
  const [isQuickActionModalOpen, setIsQuickActionModalOpen] = useState(false);
  const [quickActionUrl, setQuickActionUrl] = useState('');
  
  const [isUiVisible, setIsUiVisible] = useState(true);
  const [isOsBackgroundVisible, setIsOsBackgroundVisible] = useState(true);
  
  const activeUser = useMemo(() => {
    return familyMembers.find(m => m.id === userId) || familyMembers[0];
  }, [userId, familyMembers]);

  // --- Neural / AI Mascot State ---
  const [mood, setMood] = useState('neutral');
  const [input, setInput] = useState('');
  const [chatBubble, setChatBubble] = useState('Neural links active. How can I assist?');
  const [history, setHistory] = useState([]);
  const [isListening, setIsListening] = useState(false);
  const [isProcessing, setIsProcessing] = useState(false);
  const audioRef = useRef<HTMLAudioElement | null>(null);

  // --- Mascot & Refs ---
  const [mascotPosition, setMascotPosition] = useState(null);
  const [mousePos, setMousePos] = useState({ x: 0, y: 0 });
  const pressTimer = useRef(null);
  const dragItem = useRef<any>();
  const recognitionRef = useRef(null);
  const historyRef = useRef([]);

  useEffect(() => {
    setMascotPosition({ x: window.innerWidth - 120, y: window.innerHeight - 150 });
  }, []);
  
  useEffect(() => {
    if (!activeUser) {
        // This can happen on first load if context is not ready.
        // Or if the user ID is invalid. Redirecting is a safe fallback.
        router.push('/login/registration/admin/dashboard/audit-login/audit-journal');
    }
  }, [activeUser, router]);

  // --- Voice Systems Initialization ---
  useEffect(() => {
    if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) return;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      setInput(transcript);
      handleNeuralQuery(transcript);
    };
    recognition.onend = () => setIsListening(false);
    recognitionRef.current = recognition;
  }, []);

  const toggleVoice = () => {
    if (isListening) {
      recognitionRef.current?.stop();
    } else {
      setIsListening(true);
      setMood('listening');
      recognitionRef.current?.start();
    }
  };

  const speak = async (text: string) => {
    setMood('speaking');
    try {
        const { media } = await intelligentSpeak(text);
        if (media && audioRef.current) {
            audioRef.current.src = media;
            audioRef.current.play();
            audioRef.current.onended = () => {
              setMood('neutral');
            };
        } else {
           setMood('neutral');
        }
    } catch (error) {
        console.error("TTS Error:", error);
        setMood('alert');
        setChatBubble("Error: Could not synthesize speech.");
    }
  };

  const handleNeuralQuery = async (queryOverride: string | null = null) => {
    const query = queryOverride || input;
    if (!query.trim() || isProcessing) return;

    setIsProcessing(true);
    setMood('thinking');
    setChatBubble('Processing neural patterns...');
    setInput('');

    try {
      const aiResponseText = `Sovereign AI is processing: "${query}". Please wait for the audio response.`;

      const newHistory = [...historyRef.current, { role: 'user', text: query }, { role: 'assistant', text: aiResponseText }];
      historyRef.current = newHistory;
      setHistory(newHistory);
      
      setChatBubble(aiResponseText);
      await speak(query);

    } catch (err) {
      setChatBubble("System error: AI core destabilized.");
      setMood('alert');
    } finally {
      setIsProcessing(false);
    }
  };

  const handlePointerDown = (e: React.MouseEvent | React.TouchEvent) => {
    const clientX = 'clientX' in e ? e.clientX : e.touches[0].clientX;
    const clientY = 'clientY' in e ? e.clientY : e.touches[0].clientY;
    
    dragItem.current = { startX: clientX, startY: clientY, initialX: mascotPosition.x, initialY: mascotPosition.y, moved: false };
  };

  const handlePointerMove = (e: React.MouseEvent | React.TouchEvent) => {
      setMousePos({ x: 'clientX' in e ? e.clientX : e.touches[0].clientX, y: 'clientY' in e ? e.clientY : e.touches[0].clientY });
      if (!dragItem.current || !mascotPosition) return;
      
      const clientX = 'clientX' in e ? e.clientX : e.touches[0].clientX;
      const clientY = 'clientY' in e ? e.clientY : e.touches[0].clientY;
      
      const dx = Math.abs(clientX - dragItem.current.startX);
      const dy = Math.abs(clientY - dragItem.current.startY);

      if (dx > 5 || dy > 5) {
          dragItem.current.moved = true;
      }

      setMascotPosition({
        x: dragItem.current.initialX + (clientX - dragItem.current.startX),
        y: dragItem.current.initialY + (clientY - dragItem.current.startY)
      });
  };

  const handlePointerUp = () => {
    if (dragItem.current && !dragItem.current.moved) {
      setIsMenuOpen(prev => !prev);
    }
    dragItem.current = null;
  };
  
  const eyeTransform = useMemo(() => {
    if (!mascotPosition) return {};
    const dx = mousePos.x - mascotPosition.x;
    const dy = mousePos.y - mascotPosition.y;
    const angle = Math.atan2(dy, dx);
    const dist = Math.min(4, Math.sqrt(dx*dx + dy*dy) / 100);
    return { transform: `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)` };
  }, [mousePos, mascotPosition]);
  
  const handleReload = () => {
    // ... reload logic
  };
  
  const closeAllModals = () => {
    // ... modal closing logic
    setIsQuickActionModalOpen(false);
  };

  const anyAppModalOpen = isAppStoreModalOpen || isMapModalOpen || isSovereignInternetModalOpen || isMyAdultPebbleModalOpen || isProfileModalOpen || isPedlleTtsModalOpen || isHealthModalOpen || isCameraModalOpen || isPhoneModalOpen || isMessageModalOpen || isContactsModalOpen || isQuickActionModalOpen;
  
  if (!activeUser) {
    return <div className="bg-black text-white flex h-screen w-screen items-center justify-center">Authenticating User...</div>;
  }

  return (
    <div 
      className={`fixed inset-0 transition-all duration-1000 overflow-hidden font-sans select-none bg-[#050510]`} 
      onMouseMove={handlePointerMove}
      onTouchMove={handlePointerMove}
    >
      <audio ref={audioRef} />
      <AnimatePresence>
        {isOsBackgroundVisible && (
          <motion.div 
            initial={{ opacity: 0 }} 
            animate={{ opacity: 1 }} 
            exit={{ opacity: 0 }}
            className="absolute inset-0 z-0 pointer-events-none"
          >
            <div className="absolute inset-0 bg-gradient-to-br from-indigo-950/40 via-black to-purple-950/40 animate-pulse" />
            <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] rounded-full blur-[120px] opacity-10 bg-indigo-500 animate-slow-spin" />
          </motion.div>
        )}
      </AnimatePresence>
      
      <AnimatePresence>
        {isUiVisible && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="relative w-full h-full"
          >
            <div className="absolute top-0 left-0 right-0 p-8 flex justify-between items-center z-[60]">
              <div className="flex gap-4">
                <button
                  className="px-4 py-2 bg-white/5 backdrop-blur-md rounded-full border border-white/10 flex items-center gap-2 text-green-400 text-[10px] font-black uppercase tracking-widest hover:border-green-400/50 transition-colors"
                >
                  <Activity size={14} className="animate-pulse" /> 6G Connected
                </button>
              </div>
              <div className="flex gap-2 items-center">
                <span className="text-[10px] font-mono opacity-40 uppercase tracking-widest hidden sm:inline">Neural Link: {mood}</span>
                <div className={`text-white/40 font-mono text-xs`}>
                  {new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </div>
                <button onClick={() => setIsUiVisible(false)} className="w-10 h-10 rounded-full bg-white/5 backdrop-blur-md border border-white/10 flex items-center justify-center cursor-pointer hover:border-pink-400 transition-colors" title="Toggle UI">
                    <EyeOffIcon size={18} className="text-white/70" />
                </button>
                <button onClick={() => setIsOsBackgroundVisible(p => !p)} className="w-10 h-10 rounded-full bg-white/5 backdrop-blur-md border border-white/10 flex items-center justify-center cursor-pointer hover:border-cyan-400 transition-colors" title="Toggle Background">
                    {isOsBackgroundVisible ? <PowerOff size={18} className="text-white/70" /> : <PowerIcon size={18} className="text-white/70" />}
                </button>
                <button onClick={() => setIsProfileModalOpen(true)} className="w-10 h-10 rounded-full bg-white/5 backdrop-blur-md border border-white/10 flex items-center justify-center cursor-pointer hover:border-blue-400 transition-colors" title="Go to Profile Settings">
                    {activeUser && activeUser.imageUrl ? (
                        <Image src={activeUser.imageUrl} alt={activeUser.name} width={40} height={40} className="w-full h-full object-cover rounded-full" />
                    ) : (
                        <User size={18} className="text-white/70" />
                    )}
                </button>
              </div>
            </div>
            
            <div className="absolute right-8 top-1/2 -translate-y-1/2 flex items-center gap-4 z-50">
              <motion.div className="flex flex-col gap-4 p-3 bg-white/5 backdrop-blur-md rounded-full border border-white/10">
                {[0, 1, 2, 3].map(i => (
                  <button 
                    key={i}
                    onClick={() => setActiveStage(i)}
                    className={`w-2 rounded-full transition-all duration-500 ${activeStage === i ? 'bg-indigo-500 h-6' : 'bg-white/20 h-2 hover:bg-white/50'}`}
                  />
                ))}
              </motion.div>
            </div>
            
            <motion.div
              drag="x"
              dragConstraints={{ left: 0, right: 0 }}
              dragElastic={0.1}
              onDragEnd={(event, { offset, velocity }) => {
                  const swipe = Math.abs(offset.x);
                  if (swipe > 100) {
                      if (offset.x < 0) setActiveStage(s => Math.min(3, s + 1));
                      else setActiveStage(s => Math.max(0, s - 1));
                  }
              }}
              className="absolute inset-0 flex"
              animate={{ x: `-${activeStage * 100}vw` }}
              transition={{ type: "spring", stiffness: 300, damping: 30 }}
            >
              <div className="w-screen h-full flex-shrink-0 p-4 sm:p-8">
                  <div className="w-full h-full bg-black/20 rounded-3xl overflow-hidden">
                      <iframe src={`/shared-app/organizer-multi-grid-app?userId=${userId}`} className="w-full h-full border-none" />
                  </div>
              </div>
              <div className="w-screen h-full flex-shrink-0 flex items-center justify-center p-6">
                <StageSearch 
                  input={input} setInput={setInput} handleSearch={(e) => { e.preventDefault(); handleNeuralQuery(); }} 
                  isListening={isListening} toggleVoice={toggleVoice} isProcessing={isProcessing} chatBubble={chatBubble} 
                  history={history} onPhoneClick={() => setIsPhoneModalOpen(true)} onMessageClick={() => setIsMessageModalOpen(true)} 
                  onCameraClick={() => setIsCameraModalOpen(true)} onMapClick={() => setIsMapModalOpen(true)}
                />
              </div>
              <div className="w-screen h-full flex-shrink-0 flex items-center justify-center p-6">
                 <StagePresetApps onAppClick={(url: string) => { setQuickActionUrl(url); setIsQuickActionModalOpen(true); }} />
              </div>
              <div className="w-screen h-full flex-shrink-0 p-4">
                 <iframe src={`/shared-app/multi-grade-app?userId=${userId}`} className="w-full h-full border-none rounded-3xl" title="Entertainment App Grid" />
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

      {mascotPosition && (
        <div 
          className="fixed z-[100] transition-transform duration-300"
          style={{ left: mascotPosition.x, top: mascotPosition.y, willChange: 'transform' }}
          onMouseDown={handlePointerDown}
          onTouchStart={handlePointerDown}
          onMouseUp={handlePointerUp}
          onTouchEnd={handlePointerUp}
        >
          <div className={`w-20 h-20 backdrop-blur-3xl border-2 flex flex-col items-center justify-center cursor-pointer transition-all duration-700
            bg-white/10 border-white/20 scale-110 shadow-2xl
            rounded-[40%_60%_70%_30%/45%_45%_55%_55%] hover:scale-105 active:scale-90`}
          >
            <div className="flex gap-3">
               <div className="w-2 h-4 bg-black rounded-full overflow-hidden border border-white/5"><div className={`w-1 h-2 rounded-full blur-[1px] mt-1 ml-0.5 transition-colors bg-cyan-400`} style={eyeTransform} /></div>
               <div className="w-2 h-4 bg-black rounded-full overflow-hidden border border-white/5"><div className={`w-1 h-2 rounded-full blur-[1px] mt-1 ml-0.5 transition-colors bg-cyan-400`} style={eyeTransform} /></div>
            </div>
            {(mood === 'speaking' || mood === 'listening') && (
              <div className="flex gap-0.5 absolute bottom-4">
                 {[...Array(4)].map((_, i) => (
                   <div key={i} className="w-1 h-2 bg-cyan-400 rounded-full animate-bounce" style={{ animationDelay: `${i*0.1}s` }} />
                 ))}
              </div>
            )}
          </div>
          <AnimatePresence>
            {isMenuOpen && (
              <motion.div
                initial={{ opacity: 0, y: 10, scale: 0.9 }}
                animate={{ opacity: 1, y: 0, scale: 1 }}
                exit={{ opacity: 0, y: 10, scale: 0.9 }}
                className="absolute bottom-full left-1/2 -translate-x-1/2 mb-4 w-64 p-4 rounded-3xl bg-black/80 backdrop-blur-xl border border-white/10 shadow-2xl text-xs font-medium text-white"
              >
                <p className="mb-3">{chatBubble}</p>
                 <div className="relative">
                    <input 
                      type="text" 
                      value={input} 
                      onChange={(e) => setInput(e.target.value)} 
                      onKeyPress={(e) => e.key === 'Enter' && handleNeuralQuery()}
                      placeholder="Ask me..."
                      className="w-full bg-white/10 rounded-full py-2 px-3 text-xs"
                    />
                    <button onClick={() => handleNeuralQuery()} className="absolute right-2 top-1/2 -translate-y-1/2 p-1 bg-indigo-600 rounded-full">
                       <Send size={14} />
                    </button>
                 </div>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      )}
      
      {/* Modals remain unchanged... */}
      <AnimatePresence>
        {anyAppModalOpen && (
          <div className="fixed inset-0 z-[200] flex items-center justify-center p-6">
            <motion.div 
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={closeAllModals}
              className="absolute inset-0 bg-black/70 backdrop-blur-2xl cursor-default"
            />
            <motion.div 
              initial={{ opacity: 0, scale: 0.95, y: 30 }}
              animate={{ opacity: 1, scale: 1, y: 0 }}
              exit={{ opacity: 0, scale: 0.95, y: 20 }}
              transition={{ type: "spring", damping: 25, stiffness: 350 }}
              className="relative w-full max-w-6xl h-[90vh] bg-[#0c0c0c] border border-white/10 rounded-[2.5rem] shadow-[0_30px_100px_rgba(0,0,0,0.8)] overflow-hidden flex flex-col"
            >
               <div className="flex items-center justify-between px-6 pt-6">
                <div className="flex items-center gap-2">
                  <button 
                    onClick={closeAllModals}
                    className="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-white/60 hover:text-white transition-all active:scale-90"
                    title="Back"
                  >
                    <ArrowLeft size={16} />
                  </button>
                  <button 
                    onClick={handleReload}
                    className="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-white/60 hover:text-white transition-all active:scale-90"
                    title="Reload"
                  >
                    <RotateCw size={16} className={isReloading ? "animate-spin text-blue-400" : ""} />
                  </button>
                </div>

                <div className="px-4 py-1.5 bg-white/5 border border-white/10 rounded-full text-[10px] font-mono text-slate-400">
                    {isQuickActionModalOpen && quickActionUrl}
                </div>

                <button 
                  onClick={closeAllModals}
                  className="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-white/40 hover:text-white transition-colors"
                >
                  <X size={16} />
                </button>
              </div>
              <div className="mt-4 h-[1px] w-full bg-gradient-to-r from-transparent via-white/10 to-transparent" />
              <div className="flex-1 mt-4 rounded-b-[2.5rem] overflow-hidden">
                <iframe
                    id={isQuickActionModalOpen ? "preset-app-iframe" : "main-iframe"}
                    src={quickActionUrl || "/"}
                    className="w-full h-full border-none"
                    title="OS Modal"
                />
              </div>
            </motion.div>
          </div>
        )}
      </AnimatePresence>

      <style dangerouslySetInnerHTML={{ __html: `
        @keyframes slow-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-slow-spin { animation: slow-spin 30s linear infinite; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      `}} />
    </div>
  );
};

// These stage components remain the same as they are functional
const StageSearch = ({ input, setInput, handleSearch, isListening, toggleVoice, isProcessing, chatBubble, onPhoneClick, onMessageClick, onCameraClick, onMapClick }) => {
  const comms = [
    { id: 'phone', icon: <Phone size={24} />, label: "Phone", action: onPhoneClick },
    { id: 'message', icon: <MessageSquare size={24} />, label: "Message", action: onMessageClick },
    { id: 'camera', icon: <Camera size={24} />, label: "Camera", action: onCameraClick },
    { id: 'map', icon: <MapPin size={24} />, label: "Map", action: onMapClick }
  ];
  return (
    <div className="w-full h-full flex flex-col items-center justify-center gap-12 animate-in fade-in slide-in-from-bottom-12 duration-700">
      <div className="w-full max-w-2xl text-center">
         <div className="inline-block px-10 py-6 rounded-[2.5rem] border backdrop-blur-3xl shadow-2xl bg-white/5 border-white/10 text-indigo-100/90">
            <p className="text-xl font-light leading-relaxed">{chatBubble}</p>
         </div>
      </div>
      <div className="w-full max-w-2xl relative">
        <form onSubmit={handleSearch} className="relative group">
          <div className="absolute -inset-0.5 bg-gradient-to-r from-cyan-500/20 to-indigo-600/20 rounded-3xl blur opacity-0 group-hover:opacity-100 transition duration-500" />
          <div className="relative flex items-center bg-white/[0.03] backdrop-blur-2xl border border-white/10 rounded-3xl p-2 pl-6">
            <input type="text" value={input} onChange={(e) => setInput(e.target.value)} placeholder={isListening ? "Listening..." : "Ask Quantum anything..."} className="flex-1 bg-transparent py-4 text-sm focus:outline-none placeholder:text-white/20"/>
            <button type="button" onClick={toggleVoice} className={`p-4 rounded-2xl transition-all ${isListening ? 'bg-cyan-500 text-black scale-110 shadow-lg' : 'bg-white/5 text-white/40 hover:bg-white/10'}`}><Mic size={20} className={isListening ? 'animate-pulse' : ''} /></button>
            <button type="submit" disabled={isProcessing} className="p-4 bg-indigo-600 hover:bg-indigo-500 rounded-2xl ml-2 transition-all disabled:opacity-50">{isProcessing ? <Activity size={20} className="animate-spin" /> : <Send size={18} />}</button>
          </div>
        </form>
      </div>
      <div className="grid grid-cols-4 gap-6 mt-4">
        {comms.map((item) => (<div key={item.id} onClick={item.action} className="flex flex-col items-center gap-3 group cursor-pointer"><div className="w-16 h-16 rounded-[1.25rem] flex items-center justify-center transition-all group-hover:scale-110 group-hover:-translate-y-1 shadow-2xl border-b-4 border-black/20 bg-slate-800 text-white">{item.icon}</div><span className="text-[9px] font-black uppercase tracking-widest transition-opacity group-hover:opacity-100 text-white/60 opacity-40">{item.label}</span></div>))}
      </div>
    </div>
  );
};
const StagePresetApps = ({ onAppClick }: { onAppClick: (url: string) => void }) => {
  const apps = [
    { title: "My Work", icon: Briefcase, url: "/adult-app/my-work" },
    { title: "Work Helper", icon: HardHat, url: "/adult-app/work-helper" },
    { title: "Personal Bank", icon: Wallet, url: "/adult-app/my-personal-bank" },
    { title: "Spike Store", icon: Star, url: "/adult-app/my-spikes-point-store" },
    { title: "Social Feed", icon: MessageSquare, url: "/adult-app/adult-socialpost-view" },
    { title: "Music & Video", icon: Music, url: "/adult-app/adult-music-video" },
    { title: "Health", icon: HeartPulse, url: "/adult-app/health-wellness" },
    { title: "Family", icon: Share2, url: "/shared-app/family-pebbles/setting-f" }
  ];
  return (
    <div className="w-full max-w-4xl space-y-8 animate-in fade-in zoom-in-95 duration-700">
      <div>
        <h3 className="text-sm font-black tracking-[0.2em] uppercase text-white/40 mb-4 ml-2">Productivity & Finance</h3>
        <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
          {apps.slice(0, 4).map(app => <AppButton key={app.title} {...app} onAppClick={onAppClick} />)}
        </div>
      </div>
      <div>
        <h3 className="text-sm font-black tracking-[0.2em] uppercase text-white/40 mb-4 ml-2">Social & Health</h3>
        <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
          {apps.slice(4).map(app => <AppButton key={app.title} {...app} onAppClick={onAppClick} />)}
        </div>
      </div>
    </div>
  );
};
const AppButton = ({ title, icon: Icon, url, onAppClick }) => (
    <button onClick={() => onAppClick(url)} className="flex flex-col items-center justify-center gap-2 p-4 bg-white/5 border border-white/10 rounded-2xl text-white/70 hover:bg-white/10 hover:text-white transition-all group h-24">
      <Icon size={24} className="group-hover:scale-110 transition-transform"/>
      <span className="text-[10px] font-bold uppercase tracking-widest text-center">{title}</span>
    </button>
);

const App = (props) => {
    return (
        <Suspense fallback={<div className="bg-black text-white flex items-center justify-center h-screen">Loading...</div>}>
            <FamilyDataProvider>
                <AppContent {...props} />
            </FamilyDataProvider>
        </Suspense>
    )
}

export default App;
