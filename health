
'use client';

import React, { useState, useRef, useCallback, useEffect } from 'react';
import {
  Zap,
  Search,
  Activity,
  Cpu,
  ShieldAlert,
  History,
  Layers,
  ExternalLink,
  X,
  TrendingUp,
  BarChart3,
  ShieldCheck,
  Globe,
  Copy,
  Download,
  Filter,
  ArrowRight
} from 'lucide-react';

const API_ENDPOINT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent';
const apiKey = process.env.NEXT_PUBLIC_GEMINI_API_KEY; 

/**
 * Advanced Intelligence Parser
 */
const parseIntel = (raw = '', sources = [], ticker) => {
  const grab = (tag) => {
    const match = raw.match(new RegExp(`\\[${tag}\\](.*?)(?=\\[|$)`, 's'));
    return match ? match[1].trim() : null;
  };

  const sentimentRaw = grab('SENTIMENT') || 'NEUTRAL';
  let alertLevel = 'zinc';
  let pulseSpeed = '3s';
  
  if (sentimentRaw.toUpperCase().includes('BULL')) {
    alertLevel = 'emerald';
    pulseSpeed = '2s';
  } else if (sentimentRaw.toUpperCase().includes('BEAR')) {
    alertLevel = 'red';
    pulseSpeed = '1s';
  }

  return {
    id: `${ticker}-${Date.now()}`,
    ticker,
    summary: grab('SUMMARY') || 'Uplink interrupted.',
    sentiment: sentimentRaw,
    move: grab('KEY_MOVE') || 'N/A',
    technical: grab('TECHNICALS') || 'Data scan pending...',
    risk: grab('RISK_LEVEL') || 'Unknown',
    catalysts: (grab('CATALYSTS') || '').split('\n').filter(t => t.trim()),
    alertLevel,
    pulseSpeed,
    sources: sources.slice(0, 3),
    timestamp: new Date().toLocaleTimeString(),
  };
};

export default function App() {
  const [query, setQuery] = useState('');
  const [activeScans, setActiveScans] = useState([]); // Array for Parallel Scan
  const [history, setHistory] = useState([]);
  const [loading, setLoading] = useState(false);
  const [showDisclaimer, setShowDisclaimer] = useState(true);
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [historyFilter, setHistoryFilter] = useState('ALL');

  const executeParallelScan = useCallback(async (e) => {
    if (e) e.preventDefault();
    if (!query.trim() || loading || !apiKey) {
      if (!apiKey) {
        console.error("API Key is missing.");
        alert("API key is not configured. Please set NEXT_PUBLIC_GEMINI_API_KEY in your environment.");
      }
      return;
    }

    const tickers = query.split(',').map(t => t.trim().toUpperCase()).filter(t => t);
    setLoading(true);
    setActiveScans([]); // Clear current view for new parallel batch

    const systemPrompt = `
      You are a high-performance market intelligence terminal. Perform a DEEP SCAN.
      FORMAT:
      [SUMMARY] A dense synthesis.
      [SENTIMENT] Bullish/Bearish/Neutral.
      [TECHNICALS] Key support/resistance.
      [RISK_LEVEL] Low/Medium/High/Extreme.
      [KEY_MOVE] The tactical headline.
      [CATALYSTS] 3 bullet points.
    `;

    // Process all tickers in parallel
    const scanPromises = tickers.map(async (ticker) => {
      try {
        const res = await fetch(`${API_ENDPOINT}?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: `PARALLEL DEEP SCAN: ${ticker}` }] }],
            system_instruction: { parts: [{ text: systemPrompt }] },
            tools: [{ google_search: {} }]
          })
        });

        if (!res.ok) {
            const errorBody = await res.text();
            throw new Error(`API Error (${res.status}): ${errorBody}`);
        }

        const json = await res.json();
        const text = json?.candidates?.[0]?.content?.parts?.[0]?.text || '[SUMMARY] No valid response from model.';
        const sources = json?.candidates?.[0]?.groundingMetadata?.groundingAttributions?.map((a) => ({
          uri: a.web?.uri,
          title: a.web?.title
        })) || [];

        const parsed = parseIntel(text, sources, ticker);
        return parsed;
      } catch (err) {
        console.error(`Error scanning ${ticker}:`, err);
        return { ticker, error: true, id: ticker + Date.now(), summary: `Scan failed for ${ticker}. Check console for details.` };
      }
    });

    const results = await Promise.all(scanPromises);
    const validResults = results.filter(r => !r.error);
    
    setActiveScans(results);
    setHistory(prev => [...validResults, ...prev].slice(0, 30));
    setLoading(false);
    setQuery('');
  }, [query, loading]);

  const copyToClipboard = (intel) => {
    const text = `SCAN: ${intel.ticker}\nSENTIMENT: ${intel.sentiment}\nMOVE: ${intel.move}\nSUMMARY: ${intel.summary}`;
    navigator.clipboard.writeText(text);
  };

  const filteredHistory = history.filter(item => {
    if (historyFilter === 'ALL') return true;
    return item.alertLevel.toUpperCase() === historyFilter;
  });

  if (showDisclaimer) {
    return (
      <div className="min-h-screen bg-black text-white flex items-center justify-center p-6 uppercase tracking-[0.2em]">
        <div className="border border-emerald-900/30 bg-emerald-950/5 p-12 max-w-lg space-y-8 backdrop-blur-3xl relative overflow-hidden">
          <div className="absolute top-0 left-0 w-full h-1 bg-emerald-500 animate-pulse"></div>
          <div className="flex items-center gap-4 text-emerald-500">
            <ShieldAlert size={48} strokeWidth={1} />
            <h1 className="text-4xl font-black italic tracking-tighter">SOVEREIGN_V2</h1>
          </div>
          <div className="space-y-4 text-[10px] text-zinc-500 font-mono leading-loose">
            <p>[STATUS] MULTI-NODE SCANNING ONLINE</p>
            <p>[SYSTEM] TOKENIZED STREAMING CAPABILITIES LOADED</p>
            <p>[SECURITY] SESSION ISOLATED AND ENCRYPTED</p>
          </div>
          <button
            onClick={() => setShowDisclaimer(false)}
            className="w-full border border-emerald-500/50 py-4 hover:bg-emerald-500 hover:text-black transition-all font-bold tracking-[0.5em]"
          >
            INIT_STATION
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#030303] text-zinc-300 font-mono selection:bg-emerald-500 selection:text-black">
      {/* Background HUD Layer */}
      <div className="fixed inset-0 pointer-events-none z-0">
        <div className="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,rgba(16,185,129,0.03),transparent)] animate-pulse"></div>
        <div className="absolute inset-0 opacity-[0.05]" style={{ backgroundImage: 'linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px)', backgroundSize: '40px 40px' }}></div>
      </div>

      {/* Sidebar - History & Filters */}
      <div className={`fixed inset-y-0 left-0 w-80 bg-[#070707] border-r border-white/5 z-50 transform ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} transition-transform duration-300 shadow-2xl`}>
        <div className="p-6 h-full flex flex-col">
          <div className="flex items-center justify-between mb-8">
            <div className="text-[10px] tracking-widest text-emerald-500 flex items-center gap-2 font-bold">
              <History size={14} /> SESSION_ARCHIVE
            </div>
            <button onClick={() => setSidebarOpen(false)} className="hover:text-white"><X size={18} /></button>
          </div>

          <div className="flex gap-2 mb-6">
            {['ALL', 'EMERALD', 'RED'].map(f => (
              <button 
                key={f}
                onClick={() => setHistoryFilter(f)}
                className={`text-[8px] flex-1 py-1 border transition-all ${historyFilter === f ? 'border-emerald-500 text-emerald-500 bg-emerald-500/10' : 'border-white/10 text-zinc-600 hover:border-white/30'}`}
              >
                {f === 'EMERALD' ? 'BULL' : f === 'RED' ? 'BEAR' : 'ALL'}
              </button>
            ))}
          </div>

          <div className="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar">
            {filteredHistory.map((item) => (
              <div 
                key={item.id} 
                onClick={() => { setActiveScans([item]); setSidebarOpen(false); }}
                className="p-3 border border-white/5 bg-white/[0.01] cursor-pointer hover:border-emerald-500/40 hover:bg-emerald-500/[0.02] transition-all group"
              >
                <div className="flex justify-between items-center text-xs font-bold mb-1">
                  <span>{item.ticker}</span>
                  <span className={`text-[8px] px-1 bg-${item.alertLevel}-500/20 text-${item.alertLevel}-500`}>{item.alertLevel === 'emerald' ? 'BULL' : item.alertLevel === 'red' ? 'BEAR' : 'NEUT'}</span>
                </div>
                <div className="text-[9px] text-zinc-600 truncate uppercase">{item.move}</div>
              </div>
            ))}
          </div>
        </div>
      </div>

      <div className="relative z-10 flex flex-col min-h-screen">
        <header className="h-14 border-b border-white/5 flex items-center justify-between px-6 bg-black/60 backdrop-blur-xl sticky top-0 z-40">
          <div className="flex items-center gap-4">
            <button onClick={() => setSidebarOpen(true)} className="p-2 hover:bg-white/5 rounded-full transition-colors">
              <Layers size={18} className="text-zinc-500" />
            </button>
            <div className="text-[10px] tracking-[0.4em] font-black text-emerald-500/80">SOVEREIGN_OS // PARALLEL_UNIT</div>
          </div>
          <div className="flex items-center gap-6">
            <div className="flex items-center gap-2 text-[9px] text-zinc-600">
              <Activity size={12} className="text-emerald-500" />
              UPSTREAM: 1.2 GB/S
            </div>
          </div>
        </header>

        <main className="flex-1 max-w-7xl mx-auto w-full px-6 py-8">
          
          {/* Parallel Input */}
          <section className="max-w-3xl mx-auto mb-12">
            <form onSubmit={executeParallelScan} className="relative">
              <input
                autoFocus
                value={query}
                onChange={e => setQuery(e.target.value)}
                placeholder="AAPL, TSLA, BTC, SOL..."
                className="w-full bg-white/[0.02] border border-white/10 p-6 text-xl focus:outline-none focus:border-emerald-500/50 transition-all font-bold placeholder:text-zinc-800 tracking-widest"
              />
              <div className="absolute right-4 top-1/2 -translate-y-1/2 flex items-center gap-4">
                {loading ? <Cpu className="animate-spin text-emerald-500" /> : <button type="submit" className="text-zinc-600 hover:text-white transition-colors"><ArrowRight size={24} /></button>}
              </div>
              <div className="mt-2 text-[8px] text-zinc-700 tracking-[0.2em]">SPLIT TICKERS WITH COMMAS FOR MULTI-NODE PARALLEL SCAN</div>
            </form>
          </section>

          {/* Active Parallel Scans Grid */}
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
            {activeScans.map((intel) => (
              <div key={intel.id} className="relative border border-white/10 bg-[#080808] overflow-hidden group">
                {/* Sentiment Pulse Border */}
                <div 
                  className={`absolute inset-0 pointer-events-none border-2 border-${intel.alertLevel}-500/20`}
                  style={{ animation: `pulse-alert ${intel.pulseSpeed} infinite` }}
                ></div>

                <div className="p-6 space-y-6 relative z-10">
                  <div className="flex justify-between items-start">
                    <div>
                      <h2 className="text-5xl font-black italic tracking-tighter text-white mb-1">{intel.ticker}</h2>
                      <div className={`text-[10px] font-bold tracking-[0.3em] text-${intel.alertLevel}-500 uppercase`}>
                        {intel.sentiment} / {intel.risk} RISK
                      </div>
                    </div>
                    <div className="flex gap-2">
                      <button onClick={() => copyToClipboard(intel)} className="p-2 hover:bg-white/5 rounded text-zinc-600 hover:text-white transition-all"><Copy size={14} /></button>
                      <button className="p-2 hover:bg-white/5 rounded text-zinc-600 hover:text-white transition-all"><Download size={14} /></button>
                    </div>
                  </div>

                  <div className="border-l-2 border-emerald-500/30 pl-4">
                    <div className="text-[9px] text-zinc-600 mb-2 tracking-widest">INTELLIGENCE_STREAM</div>
                    <p className="text-sm leading-relaxed text-zinc-300 font-medium">
                      {intel.summary}
                    </p>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div className="p-3 bg-white/[0.02] border border-white/5">
                      <div className="flex items-center gap-2 mb-2 text-zinc-600">
                        <BarChart3 size={12} /> <span className="text-[8px] font-bold tracking-widest">TECHNICALS</span>
                      </div>
                      <p className="text-[10px] leading-tight text-zinc-400 uppercase">{intel.technical}</p>
                    </div>
                    <div className="p-3 bg-white/[0.02] border border-white/5">
                      <div className="flex items-center gap-2 mb-2 text-zinc-600">
                        <TrendingUp size={12} /> <span className="text-[8px] font-bold tracking-widest">CATALYSTS</span>
                      </div>
                      <div className="space-y-1">
                        {intel.catalysts.slice(0, 2).map((c, i) => (
                          <div key={i} className="text-[9px] text-zinc-500 truncate">{c}</div>
                        ))}
                      </div>
                    </div>
                  </div>

                  <div className={`p-4 bg-${intel.alertLevel}-500/10 border-l-4 border-${intel.alertLevel}-500`}>
                    <div className="text-[8px] font-black text-zinc-500 mb-1 uppercase">TACTICAL_HEADLINE</div>
                    <div className="text-lg font-black uppercase italic tracking-tight text-white">{intel.move}</div>
                  </div>

                  <div className="pt-4 flex gap-4 overflow-x-auto custom-scrollbar pb-2">
                    {intel.sources.map((s, i) => (
                      <a key={i} href={s.uri} target="_blank" rel="noreferrer" className="flex-shrink-0 flex items-center gap-2 px-3 py-2 bg-white/[0.02] border border-white/5 text-[9px] hover:bg-white hover:text-black transition-all">
                        <Globe size={10} /> SOURCE_NODE_{i+1}
                      </a>
                    ))}
                  </div>
                </div>
              </div>
            ))}

            {loading && activeScans.length === 0 && (
              <div className="lg:col-span-2 py-20 flex flex-col items-center justify-center space-y-4 opacity-50">
                <Cpu size={48} className="animate-spin text-emerald-500" />
                <div className="text-[10px] tracking-[1em] animate-pulse">INITIATING_PARALLEL_NODES</div>
              </div>
            )}
          </div>
        </main>
      </div>

      <style>{`
        @keyframes pulse-alert {
          0%, 100% { opacity: 0.1; }
          50% { opacity: 0.6; }
        }
        .custom-scrollbar::-webkit-scrollbar { height: 2px; width: 2px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }
      `}</style>
    </div>
  );
}
