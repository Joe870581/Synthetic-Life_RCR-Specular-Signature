'use client';

import React, { useState, useEffect, useRef, useMemo } from 'react';
import { 
  Shield, Zap, X, Search, User, Plus, Heart, 
  Calendar as CalendarIcon, Edit3, 
  Phone, MessageSquare, LayoutGrid, CloudSun, MapPin, 
  Users, AppWindow, Mic, Send, Activity, BrainCircuit,
  Terminal, Sparkles, Globe, Fingerprint, ArrowLeft, RotateCw, Cpu, Clock, HardHat,
  Briefcase, Landmark, Wallet, Camera
} from 'lucide-react';
import { intelligentSpeak } from '@/ai/flows/tts-flow';
import Link from 'next/link';
import { motion, AnimatePresence } from 'framer-motion';

const App = () => {
  // --- UI & Navigation State ---
  const [isOsMode, setIsOsMode] = useState(false);
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const [activeStage, setActiveStage] = useState(1); // Default to search stage
  const [activeBrowserUrl, setActiveBrowserUrl] = useState(null);
  const [isPhoneModalOpen, setIsPhoneModalOpen] = useState(false);
  const [isMessageModalOpen, setIsMessageModalOpen] = useState(false);
  const [isContactsModalOpen, setIsContactsModalOpen] = useState(false);
  const [isAppStoreModalOpen, setIsAppStoreModalOpen] = useState(false);
  const [isReloading, setIsReloading] = useState(false);
  const [isProfileModalOpen, setIsProfileModalOpen] = useState(false);
  const [isPedlleTtsModalOpen, setIsPedlleTtsModalOpen] = useState(false);
  const [isHealthModalOpen, setIsHealthModalOpen] = useState(false);
  const [isClockModalOpen, setIsClockModalOpen] = useState(false);
  const [isWorkHelperModalOpen, setIsWorkHelperModalOpen] = useState(false);
  const [isCameraModalOpen, setIsCameraModalOpen] = useState(false);
  const [isMapModalOpen, setIsMapModalOpen] = useState(false);

  // New state for the requested modals
  const [isMyWorkModalOpen, setIsMyWorkModalOpen] = useState(false);
  const [isBankingAppModalOpen, setIsBankingAppModalOpen] = useState(false);
  const [isMyPersonalBankModalOpen, setIsMyPersonalBankModalOpen] = useState(false);
  const [isSovereignInternetModalOpen, setIsSovereignInternetModalOpen] = useState(false);
  
  // --- Neural / AI State ---
  const [mood, setMood] = useState('neutral'); // neutral, thinking, listening, speaking, alert
  const [input, setInput] = useState('');
  const [chatBubble, setChatBubble] = useState('Neural links active. How can I assist?');
  const [history, setHistory] = useState([]);
  const [isListening, setIsListening] = useState(false);
  const [isProcessing, setIsProcessing] = useState(false);
  const audioRef = useRef<HTMLAudioElement | null>(null);


  // --- Mascot & Refs ---
  const [mascotPosition, setMascotPosition] = useState(null);
  const [mousePos, setMousePos] = useState({ x: 0, y: 0 });
  const pressTimer = useRef(null);
  const dragItem = useRef();
  const recognitionRef = useRef(null);
  const historyRef = useRef([]);

  useEffect(() => {
    // Set initial position after the component has mounted on the client to avoid hydration errors
    setMascotPosition({ x: window.innerWidth - 120, y: window.innerHeight - 250 });
  }, []);

  // --- Voice Systems Initialization ---
  useEffect(() => {
    if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) return;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      setInput(transcript);
      handleNeuralQuery(transcript);
    };
    recognition.onend = () => setIsListening(false);
    recognitionRef.current = recognition;
  }, []);

  const toggleVoice = () => {
    if (isListening) {
      recognitionRef.current?.stop();
    } else {
      setIsListening(true);
      setMood('listening');
      recognitionRef.current?.start();
    }
  };

  const speak = async (text: string) => {
    setMood('speaking');
    try {
        const { media } = await intelligentSpeak(text);
        if (media && audioRef.current) {
            audioRef.current.src = media;
            audioRef.current.play();
            audioRef.current.onended = () => {
              setMood('neutral');
            };
        } else {
           setMood('neutral');
        }
    } catch (error) {
        console.error("TTS Error:", error);
        setMood('alert');
        setChatBubble("Error: Could not synthesize speech.");
    }
  };

  // --- Neural Engine (The "Super Smart" Search) ---
  const handleNeuralQuery = async (queryOverride = null) => {
    const query = queryOverride || input;
    if (!query.trim() || isProcessing) return;

    setIsProcessing(true);
    setMood('thinking');
    setChatBubble('Processing neural patterns...');
    setInput('');

    try {
      const aiResponseText = `Sovereign AI is processing: "${query}". Please wait for the audio response.`;

      const newHistory = [...historyRef.current, { role: 'user', text: query }, { role: 'assistant', text: aiResponseText }];
      historyRef.current = newHistory;
      setHistory(newHistory);
      
      setChatBubble(aiResponseText);
      await speak(query); // Pass the user query to the intelligentSpeak flow

      // Automatic trigger for browser if searching specific URLs
      if (query.toLowerCase().includes("search internet for")) {
        setActiveBrowserUrl(`https://www.bing.com/search?q=${encodeURIComponent(query.replace("search internet for", ""))}`);
      }

    } catch (err) {
      setChatBubble("System error: AI core destabilized.");
      setMood('alert');
    } finally {
      setIsProcessing(false);
    }
  };

  // --- UI Interactivity ---
  const handlePointerDown = (e) => {
    pressTimer.current = setTimeout(() => {
      const newOsMode = !isOsMode;
      setIsOsMode(newOsMode);
      if (newOsMode) setIsMenuOpen(true);
      setChatBubble(newOsMode ? "Quantum OS Engaged!" : "Returning to Phone Mode.");
      pressTimer.current = null;
    }, 1200);

    const clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
    const clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : 0);
    dragItem.current = { startX: clientX, startY: clientY, initialX: mascotPosition.x, initialY: mascotPosition.y };
  };

  const handlePointerUp = () => {
    if (pressTimer.current) {
      clearTimeout(pressTimer.current);
      pressTimer.current = null;
      const newMenuState = !isMenuOpen;
      setIsMenuOpen(newMenuState);
      if (!newMenuState) {
        setActiveBrowserUrl(null);
      }
    }
    dragItem.current = null;
  };

  const eyeTransform = useMemo(() => {
    if (!mascotPosition) return {};
    const dx = mousePos.x - mascotPosition.x;
    const dy = mousePos.y - mascotPosition.y;
    const angle = Math.atan2(dy, dx);
    const dist = Math.min(4, Math.sqrt(dx*dx + dy*dy) / 100);
    return { transform: `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)` };
  }, [mousePos, mascotPosition]);

  const handleReload = () => {
    setIsReloading(true);
    // Find the iframe and reload it
    const iframe = document.getElementById('app-store-iframe') as HTMLIFrameElement || 
                   document.getElementById('profile-iframe') as HTMLIFrameElement || 
                   document.getElementById('pedlle-tts-iframe') as HTMLIFrameElement || 
                   document.getElementById('health-iframe') as HTMLIFrameElement || 
                   document.getElementById('clock-iframe') as HTMLIFrameElement || 
                   document.getElementById('work-helper-iframe') as HTMLIFrameElement ||
                   document.getElementById('my-work-iframe') as HTMLIFrameElement ||
                   document.getElementById('banking-app-iframe') as HTMLIFrameElement ||
                   document.getElementById('my-personal-bank-iframe') as HTMLIFrameElement ||
                   document.getElementById('map-iframe') as HTMLIFrameElement ||
                   document.getElementById('sovereign-internet-iframe') as HTMLIFrameElement;
    if (iframe) {
        iframe.src = iframe.src;
    }
    setTimeout(() => setIsReloading(false), 1000);
  };
  
  const anyAppModalOpen = isAppStoreModalOpen || isClockModalOpen || isWorkHelperModalOpen || isMyWorkModalOpen || isBankingAppModalOpen || isMyPersonalBankModalOpen || isMapModalOpen || isSovereignInternetModalOpen;

  return (
    <div 
      className={`fixed inset-0 transition-all duration-1000 overflow-hidden font-sans select-none
        ${isOsMode ? 'bg-[#050510]' : 'bg-transparent'}`} 
      onMouseMove={(e) => {
        setMousePos({ x: e.clientX, y: e.clientY });
        if (!dragItem.current || !mascotPosition) return;
        setMascotPosition({
          x: dragItem.current.initialX + (e.clientX - dragItem.current.startX),
          y: dragItem.current.initialY + (e.clientY - dragItem.current.startY)
        });
      }}
    >
      <audio ref={audioRef} />
      {/* BACKGROUND - OS Mode Only */}
      {isOsMode && (
        <div className="absolute inset-0 z-0 pointer-events-none">
          <div className="absolute inset-0 bg-gradient-to-br from-indigo-950/40 via-black to-purple-950/40 animate-pulse" />
          <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] rounded-full blur-[120px] opacity-10 bg-indigo-500 animate-slow-spin" />
        </div>
      )}

      {/* STATUS BAR */}
      {(isOsMode || isMenuOpen) && (
        <div className="absolute top-0 left-0 right-0 p-8 flex justify-between items-center z-[60] animate-in slide-in-from-top-full duration-500">
          <div className="flex gap-4">
            <button
              onClick={() => setIsSovereignInternetModalOpen(true)}
              className="px-4 py-2 bg-white/5 backdrop-blur-md rounded-full border border-white/10 flex items-center gap-2 text-green-400 text-[10px] font-black uppercase tracking-widest hover:border-green-400/50 transition-colors"
            >
              <Activity size={14} className="animate-pulse" /> 6G Connected
            </button>
          </div>
          <div className="flex gap-2 items-center">
            <span className="text-[10px] font-mono opacity-40 uppercase tracking-widest hidden sm:inline">Neural Link: {mood}</span>
            <div className={`${isOsMode ? 'text-white/40' : 'text-slate-900/40'} font-mono text-xs`}>
              {new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
            </div>
            <button onClick={() => setIsHealthModalOpen(true)} className="w-10 h-10 rounded-full bg-white/5 backdrop-blur-md border border-white/10 flex items-center justify-center cursor-pointer hover:border-pink-400 transition-colors" title="Health & Wellness">
                <Heart size={18} className="text-white/70" />
            </button>
             <button onClick={() => setIsPedlleTtsModalOpen(true)} className="w-10 h-10 rounded-full bg-white/5 backdrop-blur-md border border-white/10 flex items-center justify-center cursor-pointer hover:border-cyan-400 transition-colors" title="Go to PEDLLE TTS Engine">
                  <Cpu size={18} className="text-white/70" />
            </button>
             <button onClick={() => setIsProfileModalOpen(true)} className="w-10 h-10 rounded-full bg-white/5 backdrop-blur-md border border-white/10 flex items-center justify-center cursor-pointer hover:border-blue-400 transition-colors" title="Go to Profile Settings">
                  <User size={18} className="text-white/70" />
            </button>
          </div>
        </div>
      )}

      {/* MAIN INTERFACE */}
      {isMenuOpen && (activeStage !== null) && (
        <>
          {/* SIDE DOCK */}
          <div className="absolute left-8 top-1/2 -translate-y-1/2 flex flex-col gap-6 z-50 animate-in slide-in-from-left-full duration-700">
            {['Mom', 'Dad'].map((name, i) => (
              <div 
                key={name}
                onClick={() => setIsMessageModalOpen(true)}
                className={`w-12 h-12 rounded-full border-2 border-white/20 flex items-center justify-center shadow-xl transition-all hover:scale-110 cursor-pointer ${i === 0 ? 'bg-blue-600' : 'bg-pink-600'}`}>
                <User size={20} className="text-white" />
              </div>
            ))}
            <div 
              onClick={() => setIsContactsModalOpen(true)}
              className="w-12 h-12 rounded-full border-2 border-dashed border-white/20 flex items-center justify-center shadow-xl transition-all hover:scale-110 hover:border-white/50 cursor-pointer bg-white/10">
              <Plus size={20} className="text-white/70" />
            </div>
          </div>

          {/* PAGE CONTENT CONTAINER */}
          <div className="absolute inset-0 flex flex-col items-center justify-center px-6 z-40 pointer-events-none">
            <div className="w-full max-w-5xl pointer-events-auto flex flex-col items-center gap-12">
              
              {/* STAGE SELECTOR */}
              <div className="flex justify-center gap-4">
                {[0, 1, 2].map(i => (
                  <button 
                    key={i}
                    onClick={() => setActiveStage(i)}
                    className={`h-2 rounded-full transition-all duration-500 ${activeStage === i ? 'bg-indigo-500 w-12' : 'bg-white/20 w-2'}`}
                  />
                ))}
              </div>

              {/* STAGE CONTENT RENDERING */}
              <div className="w-full min-h-[500px] flex items-center justify-center transition-all duration-500">
                {activeStage === 0 && <StagePersonal 
                  mode={isOsMode} 
                  onClockClick={() => setIsClockModalOpen(true)} 
                  onWorkHelperClick={() => setIsWorkHelperModalOpen(true)}
                  onMyWorkClick={() => setIsMyWorkModalOpen(true)}
                  onBankingAppClick={() => setIsBankingAppModalOpen(true)}
                  onMyPersonalBankClick={() => setIsMyPersonalBankModalOpen(true)}
                />}
                {activeStage === 1 && (
                  <StageSearch 
                    input={input} 
                    setInput={setInput} 
                    handleSearch={(e) => { e.preventDefault(); handleNeuralQuery(); }} 
                    mode={isOsMode} 
                    isListening={isListening}
                    toggleVoice={toggleVoice}
                    isProcessing={isProcessing}
                    chatBubble={chatBubble}
                    history={history}
                    onPhoneClick={() => setIsPhoneModalOpen(true)}
                    onMessageClick={() => setIsMessageModalOpen(true)}
                    onCameraClick={() => setIsCameraModalOpen(true)}
                    onMapClick={() => setIsMapModalOpen(true)}
                  />
                )}
                {activeStage === 2 && <StageInstall mode={isOsMode} onInstallClick={() => setIsAppStoreModalOpen(true)}/>}
              </div>
            </div>
          </div>
        </>
      )}

      {/* FLOATING MASCOT */}
      {mascotPosition && (
        <div 
          className="fixed z-[100] transition-transform duration-300"
          style={{ left: mascotPosition.x, top: mascotPosition.y }}
          onMouseDown={handlePointerDown}
          onTouchStart={handlePointerDown}
          onMouseUp={handlePointerUp}
          onTouchEnd={handlePointerUp}
        >
          <div className={`w-20 h-20 backdrop-blur-3xl border-2 flex flex-col items-center justify-center cursor-pointer transition-all duration-700
            ${isOsMode ? 'bg-white/10 border-white/20 scale-110 shadow-2xl' : 'bg-black/90 border-white/10 scale-90'}
            rounded-[40%_60%_70%_30%/45%_45%_55%_55%] hover:scale-105 active:scale-90`}
          >
            {/* Eyes */}
            <div className="flex gap-3">
               <div className="w-2 h-4 bg-black rounded-full overflow-hidden border border-white/5">
                  <div className={`w-1 h-2 rounded-full blur-[1px] mt-1 ml-0.5 transition-colors ${isOsMode ? 'bg-cyan-400' : 'bg-slate-400'}`} style={eyeTransform} />
               </div>
               <div className="w-2 h-4 bg-black rounded-full overflow-hidden border border-white/5">
                  <div className={`w-1 h-2 rounded-full blur-[1px] mt-1 ml-0.5 transition-colors ${isOsMode ? 'bg-cyan-400' : 'bg-slate-400'}`} style={eyeTransform} />
               </div>
            </div>
            
            {/* Audio Visualization bars */}
            {(mood === 'speaking' || mood === 'listening') && (
              <div className="flex gap-0.5 absolute bottom-4">
                 {[...Array(4)].map((_, i) => (
                   <div key={i} className="w-1 h-2 bg-cyan-400 rounded-full animate-bounce" style={{ animationDelay: `${i*0.1}s` }} />
                 ))}
              </div>
            )}
          </div>

          {/* Chat Bubble (Near Mascot) */}
          {!isMenuOpen && (
            <div className={`absolute bottom-full left-1/2 -translate-x-1/2 mb-6 w-48 p-4 rounded-3xl rounded-bl-none shadow-2xl text-[10px] font-black transition-all duration-500 border-2
              ${isOsMode ? 'bg-white text-slate-900 border-white' : 'bg-black/95 text-white border-white/10'}`}>
              {chatBubble.length > 50 ? chatBubble.substring(0, 50) + "..." : chatBubble}
              <div className="absolute -bottom-2 left-0 w-4 h-4 bg-inherit border-b-2 border-l-2 border-inherit transform rotate-45" />
            </div>
          )}
        </div>
      )}
      
      <AnimatePresence>
        {(isPhoneModalOpen || isMessageModalOpen || isContactsModalOpen || isCameraModalOpen) && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-0 md:p-6" >
            <motion.div 
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={() => {
                setIsPhoneModalOpen(false);
                setIsMessageModalOpen(false);
                setIsContactsModalOpen(false);
                setIsCameraModalOpen(false);
              }}
              className="absolute inset-0 bg-black/70 backdrop-blur-xl cursor-pointer"
            />
            <motion.div 
              initial={{ opacity: 0, scale: 0.9, y: 20 }}
              animate={{ opacity: 1, scale: 1, y: 0 }}
              exit={{ opacity: 0, scale: 0.95, y: 10 }}
              transition={{ type: "spring", damping: 25, stiffness: 350 }}
              className="relative w-full max-w-[400px] h-full md:h-[850px] bg-transparent border-none overflow-hidden"
              onClick={(e) => e.stopPropagation()}
            >
              <iframe 
                src={
                  isPhoneModalOpen ? "/family-shared/phone-pad" :
                  isMessageModalOpen ? "/adult-app/adults-message" :
                  isContactsModalOpen ? "/adult-app/adults-contact" :
                  "/shared-app/live-video-recording"
                }
                className="w-full h-full border-none"
                title={
                  isPhoneModalOpen ? "Sovereign Phone Pad" :
                  isMessageModalOpen ? "Sovereign Messenger" :
                  isContactsModalOpen ? "Sovereign Contacts" :
                  "Live Video Recording"
                }
              />
              <button 
                  onClick={() => {
                    setIsPhoneModalOpen(false);
                    setIsMessageModalOpen(false);
                    setIsContactsModalOpen(false);
                    setIsCameraModalOpen(false);
                  }}
                  className="absolute top-6 right-6 p-2 rounded-full bg-white/5 hover:bg-white/10 text-white/40 hover:text-white transition-colors"
                >
                  <X size={24} />
              </button>
            </motion.div>
          </div>
        )}
      </AnimatePresence>

      <AnimatePresence>
        {anyAppModalOpen && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-6">
            <motion.div 
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={() => {
                setIsAppStoreModalOpen(false);
                setIsClockModalOpen(false);
                setIsWorkHelperModalOpen(false);
                setIsMyWorkModalOpen(false);
                setIsBankingAppModalOpen(false);
                setIsMyPersonalBankModalOpen(false);
                setIsMapModalOpen(false);
                setIsSovereignInternetModalOpen(false);
              }}
              className="absolute inset-0 bg-black/70 backdrop-blur-2xl cursor-default"
            />
            <motion.div 
              initial={{ opacity: 0, scale: 0.95, y: 30 }}
              animate={{ opacity: 1, scale: 1, y: 0 }}
              exit={{ opacity: 0, scale: 0.95, y: 20 }}
              transition={{ type: "spring", damping: 25, stiffness: 350 }}
              className="relative w-full max-w-6xl h-[90vh] bg-[#0c0c0c] border border-white/10 rounded-[2.5rem] shadow-[0_30px_100px_rgba(0,0,0,0.8)] overflow-hidden flex flex-col"
            >
               <div className="flex items-center justify-between px-6 pt-6">
                <div className="flex items-center gap-2">
                  <button 
                    onClick={() => {
                      setIsAppStoreModalOpen(false);
                      setIsClockModalOpen(false);
                      setIsWorkHelperModalOpen(false);
                      setIsMyWorkModalOpen(false);
                      setIsBankingAppModalOpen(false);
                      setIsMyPersonalBankModalOpen(false);
                      setIsMapModalOpen(false);
                      setIsSovereignInternetModalOpen(false);
                    }}
                    className="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-white/60 hover:text-white transition-all active:scale-90"
                    title="Back"
                  >
                    <ArrowLeft size={16} />
                  </button>
                  <button 
                    onClick={handleReload}
                    className="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-white/60 hover:text-white transition-all active:scale-90"
                    title="Reload"
                  >
                    <RotateCw size={16} className={isReloading ? "animate-spin text-blue-400" : ""} />
                  </button>
                </div>

                <div className="px-4 py-1.5 bg-white/5 border border-white/10 rounded-full text-[10px] font-mono text-slate-400">
                    {isAppStoreModalOpen && "/admin/dashboard/pedlle-tts/client-app-blueprints"}
                    {isClockModalOpen && "/Family-Shared/clock-setting"}
                    {isWorkHelperModalOpen && "/adult-app/work-helper"}
                    {isMyWorkModalOpen && "/adult-app/my-work"}
                    {isBankingAppModalOpen && "/adult-app/banking-app"}
                    {isMyPersonalBankModalOpen && "/adult-app/my-personal-bank"}
                    {isMapModalOpen && "/shared-app/family-anchor-map"}
                    {isSovereignInternetModalOpen && "/admin/dashboard/system-settings/sovereign-internet"}
                </div>

                <button 
                  onClick={() => {
                    setIsAppStoreModalOpen(false);
                    setIsClockModalOpen(false);
                    setIsWorkHelperModalOpen(false);
                    setIsMyWorkModalOpen(false);
                    setIsBankingAppModalOpen(false);
                    setIsMyPersonalBankModalOpen(false);
                    setIsMapModalOpen(false);
                    setIsSovereignInternetModalOpen(false);
                  }}
                  className="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-white/40 hover:text-white transition-colors"
                >
                  <X size={16} />
                </button>
              </div>
              <div className="mt-4 h-[1px] w-full bg-gradient-to-r from-transparent via-white/10 to-transparent" />
              <div className="flex-1 mt-4 rounded-b-[2.5rem] overflow-hidden">
                <iframe
                    id={
                      isAppStoreModalOpen ? "app-store-iframe" :
                      isClockModalOpen ? "clock-iframe" :
                      isWorkHelperModalOpen ? "work-helper-iframe" :
                      isMyWorkModalOpen ? "my-work-iframe" :
                      isBankingAppModalOpen ? "banking-app-iframe" :
                      isMapModalOpen ? "map-iframe" :
                      isSovereignInternetModalOpen ? "sovereign-internet-iframe" :
                      "my-personal-bank-iframe"
                    }
                    src={
                      isAppStoreModalOpen ? "/admin/dashboard/pedlle-tts/client-app-blueprints" :
                      isClockModalOpen ? "/Family-Shared/clock-setting" :
                      isWorkHelperModalOpen ? "/adult-app/work-helper" :
                      isMyWorkModalOpen ? "/adult-app/my-work" :
                      isBankingAppModalOpen ? "/adult-app/banking-app" :
                      isMapModalOpen ? "/shared-app/family-anchor-map" :
                      isSovereignInternetModalOpen ? "/admin/dashboard/system-settings/sovereign-internet" :
                      "/adult-app/my-personal-bank"
                    }
                    className="w-full h-full border-none"
                    title={
                      isAppStoreModalOpen ? "Sovereign App Launcher" :
                      isClockModalOpen ? "Clock Customization" :
                      isWorkHelperModalOpen ? "Work Helper" :
                      isMyWorkModalOpen ? "My Work" :
                      isBankingAppModalOpen ? "Banking App" :
                      isMapModalOpen ? "Family Anchor Map" :
                      isSovereignInternetModalOpen ? "Sovereign Internet Settings" :
                      "My Personal Bank"
                    }
                />
              </div>
            </motion.div>
          </div>
        )}
      </AnimatePresence>

      <AnimatePresence>
        {isProfileModalOpen && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-6">
            <motion.div 
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={() => setIsProfileModalOpen(false)}
              className="absolute inset-0 bg-black/70 backdrop-blur-2xl cursor-default"
            />
            <motion.div 
              initial={{ opacity: 0, scale: 0.95, y: 30 }}
              animate={{ opacity: 1, scale: 1, y: 0 }}
              exit={{ opacity: 0, scale: 0.95, y: 20 }}
              transition={{ type: "spring", damping: 25, stiffness: 350 }}
              className="relative w-full max-w-4xl h-[90vh] bg-[#0c0c0c] border border-white/10 rounded-[2.5rem] shadow-[0_30px_100px_rgba(0,0,0,0.8)] overflow-hidden flex flex-col"
            >
               <div className="flex items-center justify-between px-6 pt-6">
                <div className="flex items-center gap-2">
                  <button 
                    onClick={() => setIsProfileModalOpen(false)}
                    className="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-white/60 hover:text-white transition-all active:scale-90"
                    title="Back"
                  >
                    <ArrowLeft size={16} />
                  </button>
                   <button 
                    onClick={handleReload}
                    className="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-white/60 hover:text-white transition-all active:scale-90"
                    title="Reload"
                  >
                    <RotateCw size={16} className={isReloading ? "animate-spin text-blue-400" : ""} />
                  </button>
                </div>
                <div className="px-4 py-1.5 bg-white/5 border border-white/10 rounded-full text-[10px] font-mono text-slate-400">
                  /user/identity-vault
                </div>
                <button 
                  onClick={() => setIsProfileModalOpen(false)}
                  className="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-white/40 hover:text-white transition-colors"
                >
                  <X size={16} />
                </button>
              </div>
              <div className="mt-4 h-[1px] w-full bg-gradient-to-r from-transparent via-white/10 to-transparent" />
              <div className="flex-1 mt-4 rounded-b-[2.5rem] overflow-hidden">
                <iframe
                    id="profile-iframe"
                    src="/shared-app/family-pebbles/user-client-app-blueprints/adults"
                    className="w-full h-full border-none"
                    title="User Identity Vault"
                />
              </div>
            </motion.div>
          </div>
        )}
      </AnimatePresence>

      <AnimatePresence>
        {isPedlleTtsModalOpen && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-6">
            <motion.div 
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={() => setIsPedlleTtsModalOpen(false)}
              className="absolute inset-0 bg-black/70 backdrop-blur-2xl cursor-default"
            />
            <motion.div 
              initial={{ opacity: 0, scale: 0.95, y: 30 }}
              animate={{ opacity: 1, scale: 1, y: 0 }}
              exit={{ opacity: 0, scale: 0.95, y: 20 }}
              transition={{ type: "spring", damping: 25, stiffness: 350 }}
              className="relative w-full max-w-7xl h-[90vh] bg-[#0c0c0c] border border-white/10 rounded-[2.5rem] shadow-[0_30px_100px_rgba(0,0,0,0.8)] overflow-hidden flex flex-col"
            >
               <div className="flex items-center justify-between px-6 pt-6">
                <div className="flex items-center gap-2">
                  <button 
                    onClick={() => setIsPedlleTtsModalOpen(false)}
                    className="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-white/60 hover:text-white transition-all active:scale-90"
                    title="Back"
                  >
                    <ArrowLeft size={16} />
                  </button>
                   <button 
                    onClick={handleReload}
                    className="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-white/60 hover:text-white transition-all active:scale-90"
                    title="Reload"
                  >
                    <RotateCw size={16} className={isReloading ? "animate-spin text-blue-400" : ""} />
                  </button>
                </div>
                <div className="px-4 py-1.5 bg-white/5 border border-white/10 rounded-full text-[10px] font-mono text-slate-400">
                  /admin/dashboard/pedlle-tts
                </div>
                <button 
                  onClick={() => setIsPedlleTtsModalOpen(false)}
                  className="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-white/40 hover:text-white transition-colors"
                >
                  <X size={16} />
                </button>
              </div>
              <div className="mt-4 h-[1px] w-full bg-gradient-to-r from-transparent via-white/10 to-transparent" />
              <div className="flex-1 mt-4 rounded-b-[2.5rem] overflow-hidden">
                <iframe
                    id="pedlle-tts-iframe"
                    src="/admin/dashboard/pedlle-tts"
                    className="w-full h-full border-none"
                    title="PEDLLE TTS Engine"
                />
              </div>
            </motion.div>
          </div>
        )}
      </AnimatePresence>

      <AnimatePresence>
        {isHealthModalOpen && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-6">
            <motion.div 
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={() => setIsHealthModalOpen(false)}
              className="absolute inset-0 bg-black/70 backdrop-blur-2xl cursor-default"
            />
            <motion.div 
              initial={{ opacity: 0, scale: 0.95, y: 30 }}
              animate={{ opacity: 1, scale: 1, y: 0 }}
              exit={{ opacity: 0, scale: 0.95, y: 20 }}
              transition={{ type: "spring", damping: 25, stiffness: 350 }}
              className="relative w-full max-w-4xl h-[90vh] bg-[#0c0c0c] border border-white/10 rounded-[2.5rem] shadow-[0_30px_100px_rgba(0,0,0,0.8)] overflow-hidden flex flex-col"
            >
               <div className="flex items-center justify-between px-6 pt-6">
                <div className="flex items-center gap-2">
                  <button 
                    onClick={() => setIsHealthModalOpen(false)}
                    className="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-white/60 hover:text-white transition-all active:scale-90"
                    title="Back"
                  >
                    <ArrowLeft size={16} />
                  </button>
                   <button 
                    onClick={handleReload}
                    className="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-white/60 hover:text-white transition-all active:scale-90"
                    title="Reload"
                  >
                    <RotateCw size={16} className={isReloading ? "animate-spin text-blue-400" : ""} />
                  </button>
                </div>
                <div className="px-4 py-1.5 bg-white/5 border border-white/10 rounded-full text-[10px] font-mono text-slate-400">
                  /adult-app/health-wellness
                </div>
                <button 
                  onClick={() => setIsHealthModalOpen(false)}
                  className="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-white/40 hover:text-white transition-colors"
                >
                  <X size={16} />
                </button>
              </div>
              <div className="mt-4 h-[1px] w-full bg-gradient-to-r from-transparent via-white/10 to-transparent" />
              <div className="flex-1 mt-4 rounded-b-[2.5rem] overflow-hidden">
                <iframe
                    id="health-iframe"
                    src="/adult-app/health-wellness"
                    className="w-full h-full border-none"
                    title="Health & Wellness"
                />
              </div>
            </motion.div>
          </div>
        )}
      </AnimatePresence>

      {/* BROWSER PORTAL */}
      {activeBrowserUrl && isMenuOpen && (
        <div className="absolute inset-10 z-[200] bg-white rounded-[3rem] shadow-2xl overflow-hidden flex flex-col animate-in zoom-in-95 duration-500">
           <div className="p-4 bg-slate-50 border-b flex justify-between items-center">
              <div className="flex items-center gap-2 text-green-600 font-bold uppercase text-xs tracking-widest">
                 <Shield size={16} /> Secure Portal
              </div>
              <button onClick={() => setActiveBrowserUrl(null)} className="p-2 hover:bg-red-50 text-red-500 rounded-full transition-colors">
                <X size={24} />
              </button>
           </div>
           <iframe src={activeBrowserUrl} className="flex-1 w-full border-none" title="Safe Search" />
        </div>
      )}

      <style dangerouslySetInnerHTML={{ __html: `
        @keyframes slow-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-slow-spin { animation: slow-spin 30s linear infinite; }
        @keyframes gradient {
          0% { background-position: 0% 50%; }
          100% { background-position: 200% 50%; }
        }
      `}} />
    </div>
  );
};

// --- STAGE 0: PERSONAL PORTFOLIO ---
const StagePersonal = ({ mode, onClockClick, onWorkHelperClick, onMyWorkClick, onBankingAppClick, onMyPersonalBankClick }) => {
  const [time, setTime] = useState(new Date());

  useEffect(() => {
    const timer = setInterval(() => setTime(new Date()), 1000);
    return () => clearInterval(timer);
  }, []);

  const days = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
  const date = time.getDate();
  const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
  
  return (
    <div className="w-full max-w-4xl space-y-6 animate-in fade-in zoom-in-95 duration-700">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div 
          onClick={onClockClick}
          className={`col-span-1 md:col-span-1 p-8 rounded-[3rem] border flex items-center justify-between transition-all cursor-pointer ${mode ? 'bg-white/5 border-white/10 text-white' : 'bg-white border-slate-200 shadow-xl text-slate-800'}`}
        >
          <div>
             <h1 className="text-5xl font-black tracking-tighter">
              {time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
             </h1>
          </div>
          <Clock size={32} className="opacity-20" />
        </div>
        <div className={`col-span-1 md:col-span-1 p-8 rounded-[3rem] border flex flex-col justify-center transition-all ${mode ? 'bg-white/5 border-white/10 text-white' : 'bg-white border-slate-200 shadow-xl text-slate-800'}`}>
           <div className="flex items-center gap-2 text-indigo-500">
             <CloudSun size={32} />
             <span className="text-3xl font-black">72Â°</span>
           </div>
           <div className="flex items-center gap-1 opacity-40 text-[10px] font-bold uppercase tracking-widest mt-1">
             <MapPin size={10} /> PALO ALTO, CA | {monthNames[time.getMonth()]} {time.getDate()}
           </div>
        </div>
        <div 
          className={`p-8 rounded-[3rem] border flex flex-col justify-center transition-all space-y-2 ${mode ? 'bg-white/5 border-white/10 text-white' : 'bg-white border-slate-200 shadow-xl text-slate-800'}`}
        >
           <span className="text-[10px] font-black uppercase tracking-widest opacity-40 mb-2 text-indigo-500">Quick Actions</span>
           <button onClick={onWorkHelperClick} className="flex items-center gap-3 w-full p-3 rounded-2xl bg-indigo-500/80 text-white font-black uppercase text-xs tracking-widest hover:scale-105 transition-transform">
             <HardHat size={18} /> Work Helper
           </button>
           <button onClick={onMyWorkClick} className="flex items-center gap-3 w-full p-3 rounded-2xl bg-slate-700/80 text-white font-black uppercase text-xs tracking-widest hover:scale-105 transition-transform">
             <Briefcase size={18} /> My Work
           </button>
           <button onClick={onBankingAppClick} className="flex items-center gap-3 w-full p-3 rounded-2xl bg-slate-700/80 text-white font-black uppercase text-xs tracking-widest hover:scale-105 transition-transform">
             <Landmark size={18} /> Banking App
           </button>
           <button onClick={onMyPersonalBankClick} className="flex items-center gap-3 w-full p-3 rounded-2xl bg-slate-700/80 text-white font-black uppercase text-xs tracking-widest hover:scale-105 transition-transform">
             <Wallet size={18} /> Personal Bank
           </button>
        </div>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div className={`p-8 rounded-[3rem] border transition-all ${mode ? 'bg-white/5 border-white/10 text-white' : 'bg-white border-slate-200 shadow-xl text-slate-800'}`}>
          <div className="flex items-center justify-between mb-6">
            <div className="flex items-center gap-3">
              <CalendarIcon size={24} className="text-indigo-500" />
              <h2 className="font-black text-xl uppercase tracking-tighter">Daily Planner</h2>
            </div>
            <span className="text-[10px] font-black opacity-40 uppercase tracking-widest">{monthNames[time.getMonth()]}</span>
          </div>
          <div className="grid grid-cols-7 gap-2">
            {days.map((d, i) => <div key={d + i} className="text-center text-[10px] font-black opacity-30">{d}</div>)}
            {Array.from({ length: 31 }).map((_, i) => (
              <div key={i} className={`aspect-square flex items-center justify-center rounded-xl text-xs font-bold transition-all ${i + 1 === date ? 'bg-indigo-500 text-white scale-110 shadow-lg' : 'hover:bg-indigo-500/10'} ${i + 1 > 28 ? 'opacity-20' : ''}`}>{i + 1}</div>
            ))}
          </div>
        </div>
        <div className={`p-8 rounded-[3rem] border transition-all ${mode ? 'bg-white/5 border-white/10 text-white' : 'bg-white border-slate-200 shadow-xl text-slate-800'}`}>
          <div className="flex items-center gap-3 mb-6">
            <Edit3 size={24} className="text-pink-500" />
            <h2 className="font-black text-xl uppercase tracking-tighter">My Notes</h2>
          </div>
          <textarea placeholder="What are we doing today?" className="w-full h-32 bg-transparent border-2 border-dashed border-indigo-500/10 rounded-2xl p-4 text-xs font-bold focus:outline-none focus:border-indigo-500/30 transition-all resize-none" />
        </div>
      </div>
    </div>
  );
};

// --- STAGE 1: SEARCH & NEURAL HUB ---
const StageSearch = ({ input, setInput, handleSearch, mode, isListening, toggleVoice, isProcessing, chatBubble, history, onPhoneClick, onMessageClick, onCameraClick, onMapClick }) => {
  const comms = [
    { id: 'phone', icon: <Phone size={28} />, label: "Phone", color: "bg-green-500", action: onPhoneClick },
    { id: 'message', icon: <MessageSquare size={28} />, label: "Message", color: "bg-blue-500", action: onMessageClick },
    { id: 'camera', icon: <Camera size={28} />, label: "Camera", color: "bg-rose-500", action: onCameraClick },
    { id: 'map', icon: <MapPin size={28} />, label: "Map", color: "bg-slate-700", action: onMapClick }
  ];

  return (
    <div className="w-full flex flex-col items-center gap-12 animate-in fade-in slide-in-from-bottom-12 duration-700">
      
      {/* Neural AI Response Bubble */}
      <div className="w-full max-w-2xl text-center mb-4">
         <div className={`inline-block px-10 py-6 rounded-[2.5rem] border backdrop-blur-3xl shadow-2xl transition-all ${mode ? 'bg-white/5 border-white/10 text-indigo-100/90' : 'bg-white border-slate-100 text-slate-800'}`}>
            <p className="text-xl font-light leading-relaxed">{chatBubble}</p>
         </div>
      </div>

      {/* Super Search Bar Container */}
      <div className="mt-16 w-full max-w-2xl relative">
        <form onSubmit={handleSearch} className="relative group">
          <div className="absolute -inset-0.5 bg-gradient-to-r from-cyan-500/20 to-indigo-600/20 rounded-3xl blur opacity-0 group-hover:opacity-100 transition duration-500" />
          <div className="relative flex items-center bg-white/[0.03] backdrop-blur-2xl border border-white/10 rounded-3xl p-2 pl-6">
            <input 
              type="text"
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder={isListening ? "Listening for command..." : "Ask Quantum anything..."}
              className="flex-1 bg-transparent py-4 text-sm focus:outline-none placeholder:text-white/20"
            />
            <button 
              type="button" 
              onClick={toggleVoice}
              className={`p-4 rounded-2xl transition-all ${isListening ? 'bg-cyan-500 text-black scale-110 shadow-lg shadow-cyan-500/40' : 'bg-white/5 text-white/40 hover:bg-white/10'}`}
            >
              <Mic size={20} className={isListening ? 'animate-pulse' : ''} />
            </button>
            <button 
              type="submit"
              disabled={isProcessing}
              className="p-4 bg-indigo-600 hover:bg-indigo-500 rounded-2xl ml-2 transition-all disabled:opacity-50"
            >
              {isProcessing ? <Activity size={20} className="animate-spin" /> : <Send size={18} />}
            </button>
          </div>
        </form>

        {/* Neural Shortcuts */}
        <div className="flex justify-center gap-3 mt-6">
           <div className={`flex items-center gap-2 px-4 py-2 rounded-full border text-[9px] font-black uppercase tracking-widest ${mode ? 'bg-white/5 border-white/10 text-white/40' : 'bg-slate-50 border-slate-200 text-slate-400'}`}>
              <Zap size={10} className="text-amber-500" /> Neural Link Active
           </div>
           <div className={`flex items-center gap-2 px-4 py-2 rounded-full border text-[9px] font-black uppercase tracking-widest ${mode ? 'bg-white/5 border-white/10 text-white/40' : 'bg-slate-50 border-slate-200 text-slate-400'}`}>
              <Globe size={10} className="text-cyan-500" /> 6G Slim
           </div>
        </div>
      </div>

      {/* Communications Dock */}
      <div className="grid grid-cols-4 gap-12 mt-4">
        {comms.map((item) => (
            <div key={item.id} onClick={item.action} className="flex flex-col items-center gap-4 group cursor-pointer">
              <div className={`w-24 h-24 rounded-[2rem] flex items-center justify-center transition-all group-hover:scale-110 group-hover:-translate-y-2 shadow-2xl border-b-[6px] border-black/20 ${item.color} text-white`}>
                {item.icon}
              </div>
              <span className={`text-[12px] font-black uppercase tracking-widest transition-opacity group-hover:opacity-100 ${mode ? 'text-white/60 opacity-40' : 'text-slate-500 opacity-60'}`}>
                {item.label}
              </span>
            </div>
        ))}
      </div>

      {/* Mini Memory Feed (Last Interaction) */}
      {history.length > 0 && (
         <div className={`mt-8 px-6 py-3 rounded-2xl border text-[10px] font-mono flex items-center gap-3 ${mode ? 'bg-white/5 border-white/5 text-white/20' : 'bg-slate-50 border-slate-100 text-slate-400'}`}>
            <Terminal size={14} />
            <span>Memory Loaded: {history[history.length-1].text.substring(0, 40)}...</span>
         </div>
      )}
    </div>
  );
};

// --- STAGE 2: INSTALL SPACE ---
const StageInstall = ({ mode, onInstallClick }) => (
  <div className="w-full flex flex-col items-center gap-6 animate-in fade-in zoom-in-95 duration-1000">
    <button 
      onClick={onInstallClick}
      className={`w-40 h-40 rounded-[3rem] border-4 border-dashed flex flex-col items-center justify-center cursor-pointer hover:border-indigo-500 hover:bg-indigo-500/5 transition-all group ${mode ? 'border-white/10' : 'border-slate-200'}`}
    >
      <Plus size={48} className={`transition-transform group-hover:rotate-90 ${mode ? 'text-white/20' : 'text-slate-300'}`} />
      <span className={`mt-4 text-[10px] font-black uppercase tracking-[0.2em] ${mode ? 'text-white/20' : 'text-slate-400'}`}>Install Hub</span>
    </button>
    <div className={`text-[10px] font-black uppercase tracking-widest opacity-30 ${mode ? 'text-white' : 'text-slate-900'}`}>
      Multi-modal App Expansion
    </div>
  </div>
);

export default App;
