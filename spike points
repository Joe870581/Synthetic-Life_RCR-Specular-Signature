
'use client';

import React, { useState, useEffect, useMemo, useCallback, Suspense } from 'react';
import { 
  Zap, Trophy, ShieldAlert, FileText, Settings, Users, 
  Smartphone, Volume2, Wifi, Power, Gift, ShoppingBag, 
  ArrowUpCircle, ArrowDownCircle, History, Info, Plus,
  CreditCard, Coffee, Tv, Utensils, Heart, ChevronRight,
  Loader2, CheckCircle, ShieldOff, Gamepad2
} from 'lucide-react';
import { useFirebase, useUser, useDoc, useMemoFirebase } from '@/firebase';
import { doc, runTransaction, serverTimestamp, collection, addDoc } from 'firebase/firestore';
import { motion, AnimatePresence } from 'framer-motion';
import { useToast } from '@/hooks/use-toast';
import { Button } from '@/components/ui/button';
import { useSearchParams } from 'next/navigation';
import { FamilyDataProvider, useFamilyData } from '@/contexts/FamilyDataContext';
import Link from 'next/link';


// --- UI Components ---
const cn = (...classes) => classes.filter(Boolean).join(' ');

const GlassCard = ({ children, className = "", hover = true }) => (
  <div className={cn("bg-white/[0.03] border border-white/[0.08] rounded-[2.5rem] p-8 backdrop-blur-3xl shadow-2xl transition-all duration-500", hover ? 'hover:bg-white/[0.05] hover:border-white/20' : '', className)}>
    {children}
  </div>
);

// Map string keys to Lucide components
const IconMap = {
  Tv: Tv,
  Utensils: Utensils,
  Coffee: Coffee,
  ShoppingBag: ShoppingBag,
  Smartphone: Smartphone,
  Zap: Zap,
  Heart: Heart,
  Gamepad2: Gamepad2,
  Gift: Gift,
};

const IconPicker = ({ onSelect, selectedIcon }) => {
    const icons = ['ShoppingBag', 'Tv', 'Utensils', 'Coffee', 'Zap', 'Heart', 'Gamepad2', 'Gift'];
    return (
        <div className="grid grid-cols-4 gap-2">
            {icons.map(iconName => {
                const Icon = IconMap[iconName];
                return (
                    <button
                        key={iconName}
                        type="button"
                        onClick={() => onSelect(iconName)}
                        className={cn(
                            "flex items-center justify-center aspect-square rounded-xl border-2 transition-all",
                            selectedIcon === iconName ? 'bg-indigo-500/20 border-indigo-500' : 'bg-white/5 border-white/10 hover:border-white/30'
                        )}
                    >
                        <Icon className="w-6 h-6 text-white" />
                    </button>
                )
            })}
        </div>
    )
};


// --- MAIN APP ---
function AppContent() {
  const { firestore } = useFirebase();
  const { toast } = useToast();
  const { familyState, updateFamilyMember, isLoaded } = useFamilyData();
  const searchParams = useSearchParams();
  const userId = searchParams.get('userId') || 'p1';
  
  const [isAdmin, setIsAdmin] = useState(false);
  const [showStoreModal, setShowStoreModal] = useState(false);
  const [sortOrder, setSortOrder] = useState<'recent' | 'oldest'>('recent');
  
  const user = useMemo(() => familyState.members[userId], [userId, familyState.members]);
  const userIsParent = user?.type === 'parent';
  
  useEffect(() => {
    setIsAdmin(userIsParent);
  }, [userIsParent]);
  
  const economyDocRef = useMemoFirebase(() => {
    if (!firestore || !familyState.familyId) return null;
    return doc(firestore, 'families', familyState.familyId, 'economy', 'global_state');
  }, [firestore, familyState.familyId]);
  
  const { data: economy, isLoading } = useDoc(economyDocRef);

  const updateEconomy = async (updates) => {
    if (!economyDocRef) return;
    try {
      await runTransaction(firestore, async (transaction) => {
        const sfDoc = await transaction.get(economyDocRef);
        const currentData = sfDoc.exists() ? sfDoc.data() : {
            spikePoints: 5000,
            dailyChange: 0,
            servicesActive: true,
            inventory: [],
            giftAllowance: 500,
        };
        const newEconomyData = { ...currentData, ...updates, lastUpdate: serverTimestamp() };
        transaction.set(economyDocRef, newEconomyData, { merge: true });
      });
    } catch (e) {
      console.error("Failed to update economy:", e);
      toast({ title: "Database Error", description: "Could not sync with economy state.", variant: "destructive" });
    }
  };

  const handleTransaction = (amount, description) => {
    if (!economy) return;
    const currentDaily = economy.dailyChange || 0;
    
    if (amount < 0 && economy.spikePoints < Math.abs(amount)) {
        toast({ title: "Insufficient Points", description: "You don't have enough Spike Points for this transaction.", variant: "destructive" });
        return;
    }
    
    if (amount > 0 && Math.abs(currentDaily + amount) > 1000) {
      toast({ title: "Daily Limit Reached", description: "Daily earning limit is 1,000 Spikes.", variant: "destructive" });
      return;
    }

    const newPoints = Math.max(0, (economy.spikePoints || 0) + amount);
    updateEconomy({ 
      spikePoints: newPoints, 
      dailyChange: amount > 0 ? currentDaily + amount : currentDaily 
    });
    toast({ title: "Transaction Completed!", description: `${Math.abs(amount)} SP ${amount > 0 ? 'earned' : 'spent'}: ${description}` });
  };

  const giftSpikes = () => {
    if (!economy) return;
    if (economy.giftAllowance <= 0) return alert("You have used your 500 Spike gift allowance for today.");
    updateEconomy({ giftAllowance: 0, spikePoints: (economy.spikePoints || 0) + 500 });
    toast({ title: "Gifted!", description: "You've shared 500 Spikes with the family pool." });
  };

  const addItemToStore = (e) => {
    e.preventDefault();
    const title = e.target.title.value;
    const price = parseInt(e.target.price.value);
    const icon = e.target.icon.value;
    if (!title || isNaN(price) || !economy) return;

    const newItem = {
      id: Date.now().toString(),
      title,
      price,
      icon: icon || 'ShoppingBag',
      category: 'Custom'
    };
    updateEconomy({ inventory: [...(economy.inventory || []), newItem] });
    setShowStoreModal(false);
  };

  const renderIcon = (iconName) => {
    const IconComponent = IconMap[iconName] || ShoppingBag;
    return <IconComponent />;
  };
  
  const sortedInventory = useMemo(() => {
    if (!economy?.inventory) return [];
    return [...economy.inventory].sort((a, b) => {
        if (sortOrder === 'recent') return parseInt(b.id) - parseInt(a.id);
        return parseInt(a.id) - parseInt(b.id);
    });
  }, [economy?.inventory, sortOrder]);


  if (isLoading || !isLoaded) return (
    <div className="h-screen bg-black flex items-center justify-center">
      <div className="w-16 h-16 border-4 border-white/10 border-t-white rounded-full animate-spin" />
    </div>
  );
  
  const servicesEnabled = (economy?.spikePoints || 0) >= 400;

  return (
    <div className="min-h-screen bg-[#000000] text-white p-6 md:p-12 font-sans overflow-x-hidden">
      <div className="fixed top-[-10%] right-[-10%] w-[50%] h-[50%] bg-indigo-600/20 blur-[180px] rounded-full -z-10" />
      <div className="fixed bottom-[-10%] left-[-10%] w-[40%] h-[40%] bg-purple-600/10 blur-[150px] rounded-full -z-10" />

      <div className="max-w-7xl mx-auto space-y-12">
        <header className="flex flex-col md:flex-row justify-between items-start md:items-center gap-8 border-b border-white/10 pb-12">
          <div>
            <div className="flex items-center gap-4 mb-4">
              <div className="w-12 h-12 bg-white text-black rounded-2xl flex items-center justify-center shadow-2xl">
                <Zap fill="black" size={28} />
              </div>
              <h1 className="text-4xl font-black tracking-tight">Sovereign Spike</h1>
            </div>
            <p className="text-white/40 text-lg font-medium tracking-tight">
              Protocol v2.4 â€” <span className="text-white/60 italic">Family Accountability Network</span>
            </p>
          </div>

          <Link href="/login/registration/admin/dashboard/audit-login/audit-journal">
            <GlassCard className="!p-4" hover={true}>
              <div className="flex items-center gap-3">
                <div className="w-12 h-12 rounded-full border border-white/10 flex items-center justify-center bg-white/5 overflow-hidden">
                    <Users size={20} className="text-white/40 group-hover:text-white transition-colors" />
                </div>
                 <div>
                    <p className="text-xs text-slate-400 font-bold uppercase">Family Pool</p>
                    <p className="text-2xl font-bold text-yellow-400">{economy?.spikePoints?.toLocaleString() || 0}</p>
                 </div>
              </div>
            </GlassCard>
          </Link>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
          <GlassCard className="lg:col-span-8 overflow-hidden relative" hover={false}>
            <div className="flex flex-col md:flex-row justify-between gap-12">
              <div className="space-y-4">
                <h2 className="text-white/30 text-xs font-black uppercase tracking-[0.3em]">Total Liquidity</h2>
                <div className="flex items-baseline gap-2">
                  <span className="text-7xl md:text-9xl font-black tracking-tighter tabular-nums leading-none">
                    {economy?.spikePoints?.toLocaleString() || 0}
                  </span>
                  <span className="text-white/20 text-2xl font-black uppercase">SPK</span>
                </div>
                <div className="flex items-center gap-4 pt-4">
                  <div className="bg-emerald-500/10 text-emerald-400 px-4 py-1.5 rounded-full text-xs font-bold border border-emerald-500/20">
                    +{economy?.dailyChange || 0} Today
                  </div>
                  <div className="bg-white/5 text-white/40 px-4 py-1.5 rounded-full text-xs font-bold border border-white/10">
                    Limit: 1,000 / Day
                  </div>
                </div>
              </div>

              <div className="flex flex-col justify-end items-end gap-4 min-w-[200px]">
                <button 
                  onClick={giftSpikes}
                  className="w-full flex items-center justify-center gap-3 bg-indigo-500 hover:bg-indigo-400 text-white p-5 rounded-3xl font-black text-sm uppercase transition-all shadow-xl shadow-indigo-500/20"
                >
                  <Gift size={20} />
                  Claim Gift (+500)
                </button>
                <p className="text-[10px] text-white/20 uppercase font-black tracking-widest text-center w-full">
                  1 Gift per member per day
                </p>
              </div>
            </div>

            <div className="mt-16 h-[2px] w-full bg-white/10 relative overflow-hidden">
               <div 
                 className="absolute top-0 left-0 h-full bg-indigo-500 shadow-[0_0_20px_#6366f1] transition-all duration-1000"
                 style={{ width: `${Math.min(100, ((economy?.spikePoints || 0) / 10000) * 100)}%` }}
               />
            </div>
          </GlassCard>

          <GlassCard className="lg:col-span-4 flex flex-col gap-8">
            <h3 className="text-sm font-black text-white/30 uppercase tracking-[0.2em] flex items-center gap-2">
              <CreditCard size={16} /> Obligations
            </h3>
            <div className="space-y-4">
              <div className="bg-white/5 p-6 rounded-3xl border border-white/10 group hover:border-rose-500/50 transition-all">
                <div className="flex justify-between items-center">
                  <div>
                    <p className="font-bold text-lg mb-1">Phone Services</p>
                    <p className="text-xs text-white/40">Monthly network fee</p>
                  </div>
                  <div className="text-right">
                    <p className="text-xl font-black text-rose-400">400</p>
                    <button 
                      onClick={() => handleTransaction(-400, 'Phone Bill')}
                      disabled={!servicesEnabled}
                      className="text-[10px] font-black uppercase text-white/20 hover:text-white transition-colors disabled:text-red-500/50 disabled:cursor-not-allowed"
                    >
                      {servicesEnabled ? "Pay Now" : "POOL DEPLETED"}
                    </button>
                  </div>
                </div>
              </div>

              <div className="bg-white/5 p-6 rounded-3xl border border-white/10 opacity-40">
                <div className="flex justify-between items-center">
                  <div>
                    <p className="font-bold text-lg mb-1">Mesh WiFi</p>
                    <p className="text-xs text-white/40">Broadband allocation</p>
                  </div>
                  <div className="text-right">
                    <p className="text-xl font-black">Free</p>
                    <p className="text-[10px] uppercase text-emerald-400">Paid by Spikes</p>
                  </div>
                </div>
              </div>
            </div>
          </GlassCard>
        </div>

        <section className="space-y-8 pt-12">
          <div className="flex flex-col md:flex-row justify-between items-end gap-4">
            <div>
              <h2 className="text-5xl font-black tracking-tighter mb-2">Sacrifice & Rewards</h2>
              <p className="text-white/40 font-medium">Earned by Pebbles. Spent on the better life.</p>
            </div>
            <div className="flex items-center gap-2">
                <button onClick={() => setSortOrder('recent')} className={`px-4 py-2 text-xs font-bold rounded-lg ${sortOrder === 'recent' ? 'bg-white/10' : 'bg-transparent'}`}>Recent</button>
                <button onClick={() => setSortOrder('oldest')} className={`px-4 py-2 text-xs font-bold rounded-lg ${sortOrder === 'oldest' ? 'bg-white/10' : 'bg-transparent'}`}>Oldest</button>
                {isAdmin && (
                  <button 
                    onClick={() => setShowStoreModal(true)}
                    className="flex items-center gap-2 bg-white/5 border border-white/10 px-6 py-3 rounded-full hover:bg-white/10 transition-all"
                  >
                    <Plus size={18} />
                    <span className="text-sm font-bold">List Service</span>
                  </button>
                )}
            </div>
          </div>

          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
            {sortedInventory.map((item) => {
              const Icon = IconMap[item.icon] || ShoppingBag;
              return (
              <GlassCard key={item.id} className="group relative flex flex-col h-full !p-6">
                <div className="mb-6 w-12 h-12 bg-white/5 rounded-2xl flex items-center justify-center text-white/40 group-hover:text-white transition-all">
                  <Icon />
                </div>
                <h4 className="text-lg font-bold mb-2 leading-tight flex-grow">{item.title}</h4>
                <div className="flex justify-between items-center mt-4">
                  <div className="flex items-baseline gap-1">
                    <span className="text-xl font-black tracking-tight italic">{item.price}</span>
                    <span className="text-[10px] text-white/20 font-black">SPK</span>
                  </div>
                  <button 
                    onClick={() => handleTransaction(-item.price, item.title)}
                    className="p-3 bg-white/5 hover:bg-white text-white hover:text-black rounded-xl transition-all"
                  >
                    <ChevronRight size={18} />
                  </button>
                </div>
              </GlassCard>
            )})}
          </div>
        </section>

        {showStoreModal && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 backdrop-blur-3xl bg-black/60">
            <GlassCard className="w-full max-w-md bg-[#0a0a0a] border-white/20" hover={false}>
              <h3 className="text-2xl font-black mb-6">List Family Service</h3>
              <form onSubmit={addItemToStore} className="space-y-6">
                <div>
                  <label className="text-[10px] font-black uppercase text-white/30 mb-2 block tracking-widest">Service Title</label>
                  <input name="title" required placeholder="e.g. Sibling cleans my room" className="w-full bg-white/5 border border-white/10 rounded-2xl p-4 focus:outline-none focus:border-indigo-500 transition-all" />
                </div>
                 <div>
                    <label className="text-[10px] font-black uppercase text-white/30 mb-2 block tracking-widest">Icon</label>
                    <input name="icon" type="hidden" value="ShoppingBag" />
                    <IconPicker onSelect={(icon) => {
                        const input = document.querySelector('input[name="icon"]') as HTMLInputElement;
                        if(input) input.value = icon;
                    }} selectedIcon={null} />
                </div>
                <div>
                  <label className="text-[10px] font-black uppercase text-white/30 mb-2 block tracking-widest">Point Price</label>
                  <input name="price" type="number" required placeholder="500" className="w-full bg-white/5 border border-white/10 rounded-2xl p-4 focus:outline-none focus:border-indigo-500 transition-all" />
                </div>
                <div className="flex gap-4 pt-4">
                  <button type="submit" className="flex-1 bg-white text-black font-black p-4 rounded-2xl uppercase text-xs">Publish</button>
                  <button type="button" onClick={() => setShowStoreModal(false)} className="flex-1 bg-white/5 text-white font-black p-4 rounded-2xl uppercase text-xs border border-white/10">Discard</button>
                </div>
              </form>
            </GlassCard>
          </div>
        )}

        <footer className="pt-24 pb-12 opacity-20 hover:opacity-100 transition-opacity duration-1000">
           <div className="flex flex-col items-center gap-4 text-center">
              <ShieldAlert size={40} className="text-white" />
              <div className="space-y-1">
                <p className="text-[10px] font-black uppercase tracking-[0.4em]">Spike Point Ledger v2.0</p>
                <p className="text-[10px] uppercase font-medium">Encryption Active // No Exchange Possible // Non-Tradeable Assets</p>
              </div>
           </div>
        </footer>
      </div>
    </div>
  );
}

const AppWrapper = () => (
  <Suspense fallback={<div className="h-screen w-screen bg-black flex items-center justify-center"><Loader2 className="animate-spin" /></div>}>
    <FamilyDataProvider>
        <AppContent />
    </FamilyDataProvider>
  </Suspense>
);

export default AppWrapper;
