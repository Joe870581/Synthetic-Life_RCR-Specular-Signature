
'use client';

import React, { useState, useEffect, useRef, useMemo, Suspense, useContext } from 'react';
import { 
  Bot, User, Send, BrainCircuit, Loader2, Activity, History 
} from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import { useToast } from '@/hooks/use-toast';
import { useSearchParams } from 'next/navigation';
import { FamilyDataProvider, useFamilyData, type AuditLog } from '@/contexts/FamilyDataContext';
import { speakToPebble } from '@/app/actions/ai';


const AppContent = () => {
    const { familyState, addMemoryEvent, isLoaded } = useFamilyData();
    const searchParams = useSearchParams();
    const userId = searchParams.get('userId');
    const { toast } = useToast();

    // ✅ CLEANUP: Seed the initial message via useState
    const [messages, setMessages] = useState([
      { id: crypto.randomUUID(), role: 'assistant', text: "Lasso and Archive memory online. What's on our radar?" }
    ]);
    const [input, setInput] = useState('');
    const [isThinking, setIsThinking] = useState(false);
    
    const scrollAreaRef = useRef<HTMLDivElement>(null);
    const auditScrollRef = useRef<HTMLDivElement>(null);
    
    useEffect(() => {
        if (scrollAreaRef.current) {
            scrollAreaRef.current.scrollTop = scrollAreaRef.current.scrollHeight;
        }
    }, [messages]);

    useEffect(() => {
        if (auditScrollRef.current) {
            auditScrollRef.current.scrollTop = 0;
        }
    }, [familyState.auditLogs]);

    const handleSendMessage = async (e?: React.FormEvent) => {
        e?.preventDefault();
        if (!input.trim() || isThinking) return;

        const userMessage = { id: crypto.randomUUID(), role: 'user', text: input };
        setMessages(prev => [...prev, userMessage]);
        addMemoryEvent({ level: 'USER', detail: `Sent query: "${input}"`, userId: userId || 'p1' });
        
        const query = input;
        setInput('');
        setIsThinking(true);
        
        try {
            // ✅ CORRECT ARCHITECTURE: Calling the server action
            const response = await speakToPebble(query, { 
              voice: "Puck",
              // ✅ REQUIRED FIX: Pass userId to the AI core
              userId: userId || 'p1', 
            });

            // ✅ SHOULD FIX: Harden response handling
            if (!response || typeof response.text !== 'string') {
              throw new Error('Invalid AI response received from server action.');
            }

            const aiMessage = { id: crypto.randomUUID(), role: 'assistant', text: response.text };
            setMessages(prev => [...prev, aiMessage]);
            addMemoryEvent({ level: 'INFO', detail: `AI Response: "${response.text}"`, userId: 'pebble' });

        } catch (error) {
            const errorDetails = error instanceof Error ? error.message : typeof error === 'string' ? error : 'Unknown error';
            console.error('[Pebble]', errorDetails);
            
            const errorMessage = { id: crypto.randomUUID(), role: 'assistant', text: "I seem to be having trouble connecting to my core processes right now." };
            setMessages(prev => [...prev, errorMessage]);
            
            addMemoryEvent({ level: 'SYSTEM', detail: `AI Core Error: ${errorDetails}`, userId: 'system_error' });
            
            // ✅ SHOULD FIX: Defer toast to avoid React update cycles
            queueMicrotask(() => {
                toast({
                    variant: "destructive",
                    title: "AI Core Error",
                    description: "Could not get a response from Pebble.",
                });
            });
        } finally {
            setIsThinking(false);
        }
    };
    
    // ✅ SHOULD FIX: Harden timestamp formatting
    const formatLogTimestamp = (timestamp: any) => {
      if (!timestamp) return '---';
      if (timestamp instanceof Date) return timestamp.toLocaleTimeString();
      if (typeof timestamp.toDate === 'function') return timestamp.toDate().toLocaleTimeString();
      return String(timestamp);
    };
    
    const ChatBubble = ({ message }) => {
        const isUser = message.role === 'user';
        const Icon = isUser ? User : Bot;

        return (
            <motion.div
                layout
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                className={`flex items-start gap-4 ${isUser ? 'justify-end' : ''}`}
            >
                {!isUser && (
                    <div className="w-10 h-10 rounded-full bg-indigo-500/20 border border-indigo-500/30 flex items-center justify-center flex-shrink-0">
                        <Icon className="w-6 h-6 text-indigo-400" />
                    </div>
                )}
                <div className={`p-4 rounded-3xl max-w-lg text-sm leading-relaxed ${isUser ? 'bg-blue-600 text-white rounded-br-none' : 'bg-slate-800 text-slate-300 rounded-bl-none'}`}>
                    {message.text}
                </div>
                 {isUser && (
                    <div className="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center flex-shrink-0">
                        <Icon className="w-6 h-6 text-slate-300" />
                    </div>
                )}
            </motion.div>
        );
    };
    
    const AuditLogRow = ({ log }) => {
        const levelConfig = {
            SYSTEM: 'border-red-500/30 text-red-400',
            USER: 'border-blue-500/30 text-blue-400',
            INFO: 'border-cyan-500/30 text-cyan-400',
            SANDBOX_ACTION: 'border-yellow-500/30 text-yellow-400',
        };
        const config = levelConfig[log.level] || 'border-slate-700 text-slate-500';

        return (
            <div className={`text-[10px] font-mono border-l-2 pl-3 py-1 ${config}`}>
                <span className="text-slate-600 mr-2">[{formatLogTimestamp(log.timestamp)}]</span>
                <span className="font-bold mr-2">[{log.level}]</span>
                <span className="text-slate-400">{log.detail}</span>
            </div>
        )
    };

    if (!isLoaded) {
        return <div className="h-full w-full flex items-center justify-center"><Loader2 className="animate-spin text-indigo-500"/></div>
    }

    return (
        <div className="h-full w-full flex flex-col md:flex-row gap-6 p-4 md:p-8">
             {/* Left Column: Chat Interface */}
            <div className="flex-1 flex flex-col bg-slate-900/50 border border-slate-800 rounded-3xl overflow-hidden shadow-2xl">
                <header className="p-4 border-b border-slate-800 flex items-center gap-3">
                    <div className="w-10 h-10 bg-indigo-500/20 rounded-full flex items-center justify-center">
                        <BrainCircuit className="text-indigo-400" />
                    </div>
                    <div>
                        <h2 className="font-bold text-white">MyPebbleChat</h2>
                        <p className="text-xs text-slate-400">Your personal, always-on AI companion.</p>
                    </div>
                </header>

                <div ref={scrollAreaRef} className="flex-1 overflow-y-auto space-y-6 p-4 custom-scrollbar">
                     <AnimatePresence>
                        {messages.map((msg) => (
                            <ChatBubble key={msg.id} message={msg} />
                        ))}
                    </AnimatePresence>
                    {isThinking && (
                         <motion.div initial={{opacity:0, y:10}} animate={{opacity:1, y:0}} className="flex items-start gap-4">
                            <div className="w-10 h-10 rounded-full bg-indigo-500/20 border border-indigo-500/30 flex items-center justify-center flex-shrink-0">
                                <Bot className="w-6 h-6 text-indigo-400" />
                            </div>
                            <div className="p-4 rounded-3xl max-w-lg bg-slate-800 text-slate-300 rounded-bl-none flex items-center gap-2">
                               <Loader2 className="w-4 h-4 animate-spin text-indigo-400"/>
                               <span className="text-sm italic">Pebble is thinking...</span>
                            </div>
                        </motion.div>
                    )}
                </div>

                 <form onSubmit={handleSendMessage} className="p-4 bg-slate-800/50 backdrop-blur-md border-t border-slate-700">
                    <div className="relative">
                        {/* ✅ REQUIRED FIX: Bind input value */}
                        <input
                            type="text"
                            value={input}
                            onChange={e => setInput(e.target.value)}
                            placeholder="Ask about your history, get ideas, or just chat..."
                            className="w-full bg-slate-900 border border-slate-700 rounded-full py-4 pl-6 pr-16 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            disabled={isThinking}
                        />
                        <button type="submit" className="absolute right-3 top-1/2 -translate-y-1/2 p-2.5 bg-indigo-600 rounded-full hover:bg-indigo-500 transition-colors disabled:bg-slate-600" disabled={isThinking || !input.trim()}>
                            <Send className="w-5 h-5 text-white" />
                        </button>
                    </div>
                </form>
            </div>
            
             {/* Right Column: Audit Log */}
            <div className="w-full md:w-96 flex-shrink-0 flex flex-col bg-slate-900/50 border border-slate-800 rounded-3xl overflow-hidden shadow-2xl">
                <header className="p-4 border-b border-slate-800 flex items-center gap-3">
                    <div className="w-10 h-10 bg-cyan-500/10 rounded-full flex items-center justify-center">
                        <History className="text-cyan-400" />
                    </div>
                    <div>
                        <h2 className="font-bold text-white">Lasso Memory</h2>
                        <p className="text-xs text-slate-400">Live Audit Journal</p>
                    </div>
                </header>
                <div ref={auditScrollRef} className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                   {familyState.auditLogs.map((log) => <AuditLogRow key={log.id} log={log} />)}
                </div>
            </div>
            <style jsx global>{`
                .custom-scrollbar::-webkit-scrollbar { width: 4px; }
                .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
                .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(129, 140, 248, 0.3); border-radius: 4px; }
            `}</style>
        </div>
    );
};

export default function WorkHelperPage() {
    return (
        <Suspense fallback={<div className="h-screen w-screen bg-slate-950 flex items-center justify-center"><Loader2 className="animate-spin" /></div>}>
            <FamilyDataProvider>
                <div className="h-screen w-screen bg-slate-950">
                    <AppContent />
                </div>
            </FamilyDataProvider>
        </Suspense>
    )
}
