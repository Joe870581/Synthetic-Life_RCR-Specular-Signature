
'use client';

import React, { useState, useEffect, useRef, useMemo, Suspense, useContext } from 'react';
import { 
  Shield, Zap, X, Search, User, Plus, Heart, 
  Calendar as CalendarIcon, Edit3, 
  Phone, MessageSquare, LayoutGrid, CloudSun, MapPin, 
  Users, AppWindow, Mic, Send, Activity, BrainCircuit,
  Terminal, Sparkles, Globe, ToyBrick, Music, Home, School, HelpCircle, Wallet, Star, Anchor, Map, FileText, Sheet, Calculator, Camera, Video, Clock, Banknote, Power, VideoIcon, Disc, FolderKanban, Radio, Palette,
  ArrowLeft, RotateCw, Briefcase, PiggyBank, Cpu, Share2
} from 'lucide-react';
import Image from 'next/image';
import { simpleSpeak } from '@/ai/flows/tts-flow';
import Link from 'next/link';
import { motion, AnimatePresence } from 'framer-motion';
import { useToast } from '@/hooks/use-toast';
import { useParams, useRouter, useSearchParams } from 'next/navigation';
import { FamilyDataContext, FamilyDataProvider, type SpeakConfig, useFamilyData, type Device } from '@/contexts/FamilyDataContext';
import { Button } from '@/components/ui/button';
import { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import { Calendar } from '@/components/ui/calendar';
import { ToastProvider } from '@/components/ui/toast-provider';
import CalendarView from '@/components/calendar/calendar-view';
import { users, calendarEvents } from '@/lib/mock-data';

const AppContent = () => {
  const params = useParams();
  const userId = params.userId as string;
  const { familyMembers } = useFamilyData();
  const router = useRouter();
  const searchParams = useSearchParams();
  const sessionId = searchParams.get('sessionId');

  const { toast } = useToast();
  
  const user = useMemo(() => {
    return familyMembers.find(m => m.id === userId);
  }, [userId, familyMembers]);
  
  const getAge = (dob) => {
    if (!dob) return 0;
    const birthDate = new Date(dob);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    return age;
  };

  useEffect(() => {
    if (user && user.dob) {
      const age = getAge(user.dob);
      if (age >= 16) {
        // If the user is 16 or older, redirect them to the adult OS page.
        router.replace(`/login/registration/admin/dashboard/audit-login/audit-journal/user-family/dashboard/peddle-tts/client-app-blueprints/adult-os-mode/${userId}?sessionId=${sessionId}`);
      }
    } else if (!user) {
        // Optional: Redirect if user not found, after a delay to allow context to load
        const timer = setTimeout(() => {
            const userExists = familyMembers.find(m => m.id === userId);
            if (!userExists || userExists.name === 'Awaiting User...') {
                router.push(`/login/registration/admin/dashboard/audit-login/audit-journal?sessionId=${sessionId}`);
            }
        }, 2000);
        return () => clearTimeout(timer);
    }
  }, [user, familyMembers, userId, router, sessionId]);

  // --- UI & Navigation State ---
  const [isOsMode, setIsOsMode] = useState(false);
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const [activeStage, setActiveStage] = useState(1);
  const [activeBrowserUrl, setActiveBrowserUrl] = useState(null);
  const [isReloading, setIsReloading] = useState(false);
  const [isCameraModalOpen, setIsCameraModalOpen] = useState(false);
  const [isMapModalOpen, setIsMapModalOpen] = useState(false);
  const [isPhoneModalOpen, setIsPhoneModalOpen] = useState(false);
  const [isMessageModalOpen, setIsMessageModalOpen] = useState(false);
  const [isContactsModalOpen, setIsContactsModalOpen] = useState(false);
  const [isInstallHubOpen, setIsInstallHubOpen] = useState(false);
  const [isClockModalOpen, setIsClockModalOpen] = useState(false);
  
  const [isQuickActionModalOpen, setIsQuickActionModalOpen] = useState(false);
  const [quickAction, setQuickAction] = useState<{title: string, url: string} | null>(null);
  const [isHealthModalOpen, setIsHealthModalOpen] = useState(false);
  const [isPedlleTtsModalOpen, setIsPedlleTtsModalOpen] = useState(false);
  const [isProfileModalOpen, setIsProfileModalOpen] = useState(false);


  // --- Neural / AI State ---
  const [mood, setMood] = useState('neutral');
  const [input, setInput] = useState('');
  const [chatBubble, setChatBubble] = useState('How can I help you today?');
  const [history, setHistory] = useState([]);
  const [isListening, setIsListening] = useState(false);
  const [isProcessing, setIsProcessing] = useState(false);
  const audioRef = useRef<HTMLAudioElement | null>(null);

  // --- Mascot & Refs ---
  const [mascotPosition, setMascotPosition] = useState(null);
  const [mousePos, setMousePos] = useState({ x: 0, y: 0 });
  const pressTimer = useRef(null);
  const dragItem = useRef<any>();
  const recognitionRef = useRef(null);
  const historyRef = useRef([]);

  useEffect(() => {
    setMascotPosition({ x: window.innerWidth - 120, y: window.innerHeight - 250 });
  }, []);

  // --- Voice Systems Initialization ---
  useEffect(() => {
    if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) return;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      setInput(transcript);
      handleNeuralQuery(transcript);
    };
    recognition.onend = () => setIsListening(false);
    recognitionRef.current = recognition;
  }, []);

  const toggleVoice = () => {
    if (isListening) {
      recognitionRef.current?.stop();
    } else {
      setIsListening(true);
      setMood('listening');
      recognitionRef.current?.start();
    }
  };

  const speak = async (text) => {
    setMood('speaking');
    try {
        const { media } = await simpleSpeak(text, { voice: 'Puck' });
        if (media && audioRef.current) {
            audioRef.current.src = media;
            audioRef.current.play();
            audioRef.current.onended = () => {
              setMood('neutral');
            };
        } else {
           setMood('neutral');
        }
    } catch (error) {
        console.error("TTS Error:", error);
        setMood('alert');
        setChatBubble("Oops, I got a little glitch!");
    }
  };

  // --- Neural Engine (The "Super Smart" Search) ---
  const handleNeuralQuery = async (queryOverride = null) => {
    const query = queryOverride || input;
    if (!query.trim() || isProcessing) return;

    setIsProcessing(true);
    setMood('thinking');
    setChatBubble('Thinking of a fun answer...');
    setInput('');

    try {
      const aiText = `This is a simulated response to: "${query}". I'm a kid-friendly AI!`;
      const newHistory = [...historyRef.current, { role: 'user', text: query }, { role: 'assistant', text: aiText }];
      historyRef.current = newHistory;
      setHistory(newHistory);
      setChatBubble(aiText);
      await speak(aiText);

      if (query.toLowerCase().includes("search for")) {
        setActiveBrowserUrl(`https://www.bing.com/search?q=${encodeURIComponent(query.replace("search for", ""))}&adlt=strict`);
      }
    } catch (err) {
      setChatBubble("System error: AI core destabilized.");
      setMood('alert');
    } finally {
      setIsProcessing(false);
    }
  };

  // --- UI Interactivity ---
  const handlePointerDown = (e: React.MouseEvent | React.TouchEvent) => {
    pressTimer.current = setTimeout(() => {
      const newOsMode = !isOsMode;
      setIsOsMode(newOsMode);
      if (newOsMode) setIsMenuOpen(true);
      setChatBubble(newOsMode ? "Adventure Mode Engaged!" : "Switching to Phone Mode.");
      pressTimer.current = null;
    }, 1200);

    const clientX = 'clientX' in e ? e.clientX : e.touches[0].clientX;
    const clientY = 'clientY' in e ? e.clientY : e.touches[0].clientY;
    dragItem.current = { startX: clientX, startY: clientY, initialX: mascotPosition.x, initialY: mascotPosition.y };
  };

  const handlePointerUp = () => {
    if (pressTimer.current) {
      clearTimeout(pressTimer.current);
      pressTimer.current = null;
      const newMenuState = !isMenuOpen;
      setIsMenuOpen(newMenuState);
      if (!newMenuState) {
        setActiveBrowserUrl(null);
      }
    }
    dragItem.current = null;
  };

  const eyeTransform = useMemo(() => {
    if (!mascotPosition) return {};
    const dx = mousePos.x - mascotPosition.x;
    const dy = mousePos.y - mascotPosition.y;
    const angle = Math.atan2(dy, dx);
    const dist = Math.min(4, Math.sqrt(dx*dx + dy*dy) / 100);
    return { transform: `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)` };
  }, [mousePos, mascotPosition]);
  
  
  const handleReload = () => {
    setIsReloading(true);
    const iframes = [
      "camera-iframe", "map-iframe", "install-hub-iframe", "clock-iframe", 
      "calendar-iframe", "notes-iframe", "quick-action-iframe", "health-iframe", "pedlle-tts-iframe", "profile-iframe"
    ];
    let reloaded = false;
    for (const id of iframes) {
      const iframe = document.getElementById(id) as HTMLIFrameElement;
      if (iframe) {
          iframe.src = iframe.src;
          reloaded = true;
          break;
      }
    }
    setTimeout(() => setIsReloading(false), 1000);
  };
  
  const closeAllModals = () => {
    setIsCameraModalOpen(false);
    setIsMapModalOpen(false);
    setIsInstallHubOpen(false);
    setIsClockModalOpen(false);
    setIsQuickActionModalOpen(false);
    setIsHealthModalOpen(false);
    setIsPedlleTtsModalOpen(false);
    setIsProfileModalOpen(false);
    setQuickAction(null);
  };

  const anyAppModalOpen = isCameraModalOpen || isMapModalOpen || isInstallHubOpen || isClockModalOpen || isQuickActionModalOpen || isHealthModalOpen || isPedlleTtsModalOpen || isProfileModalOpen;
  
  const openQuickAction = (app: {title: string, url: string}) => {
    const finalUrl = `${app.url}?sessionId=${sessionId}&userId=${userId}`;
    setQuickAction({title: app.title, url: finalUrl});
    setIsQuickActionModalOpen(true);
  }
  
  if (!user) {
    return <div className="bg-black text-white flex h-screen w-screen items-center justify-center">Authenticating User...</div>;
  }

  return (
    <div 
      className={`fixed inset-0 transition-all duration-1000 overflow-hidden font-sans select-none
        ${isOsMode ? 'bg-[#050510]' : 'bg-transparent'}`} 
      onMouseMove={(e) => {
        setMousePos({ x: e.clientX, y: e.clientY });
        if (!dragItem.current || !mascotPosition) return;
        setMascotPosition({
          x: dragItem.current.initialX + (e.clientX - dragItem.current.startX),
          y: dragItem.current.initialY + (e.clientY - dragItem.current.startY)
        });
      }}
    >
      <audio ref={audioRef} />
      {/* BACKGROUND - OS Mode Only */}
      {isOsMode && (
        <div className="absolute inset-0 z-0 pointer-events-none">
          <div className="absolute inset-0 bg-gradient-to-br from-indigo-950/40 via-black to-purple-950/40 animate-pulse" />
          <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] rounded-full blur-[120px] opacity-10 bg-indigo-500 animate-slow-spin" />
        </div>
      )}

      {/* STATUS BAR */}
      {(isOsMode || isMenuOpen) && (
        <div className="absolute top-0 left-0 right-0 p-8 flex justify-between items-center z-[60] animate-in slide-in-from-top-full duration-500">
          <div className="flex gap-4">
            <div className="px-4 py-2 bg-white/5 backdrop-blur-md rounded-full border border-white/10 flex items-center gap-2 text-green-400 text-[10px] font-black uppercase tracking-widest">
              <Activity size={14} className="animate-pulse" /> 6G Connected
            </div>
          </div>
          <div className="flex gap-2 items-center">
            <span className="text-[10px] font-mono opacity-40 uppercase tracking-widest hidden sm:inline">Neural Link: {mood}</span>
            <div className={`${isOsMode ? 'text-white/40' : 'text-slate-900/40'} font-mono text-xs`}>
              {new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
            </div>
             <button onClick={() => openQuickAction({ title: 'My Health', url: '/kids-app/my-health' })} className="w-10 h-10 rounded-full bg-white/5 backdrop-blur-md border border-white/10 flex items-center justify-center cursor-pointer hover:border-pink-400 transition-colors" title="My Health">
                <Heart size={18} className="text-white/70" />
            </button>
            <button onClick={() => openQuickAction({ title: 'PEDLLE TTS Engine', url: '/login/registration/admin/dashboard/audit-login/audit-journal/user-family/dashboard/peddle-tts' })} className="w-10 h-10 rounded-full bg-white/5 backdrop-blur-md border border-white/10 flex items-center justify-center cursor-pointer hover:border-cyan-400 transition-colors" title="Go to PEDLLE TTS Engine">
              <Cpu size={18} className="text-white/70" />
            </button>
            <button onClick={() => openQuickAction({ title: 'Profile Settings', url: `/shared-app/family-pebbles/user-client-app-blueprints/kids?userId=${userId}` })} className="w-10 h-10 rounded-full bg-white/5 backdrop-blur-md border border-white/10 flex items-center justify-center cursor-pointer hover:border-blue-400 transition-colors" title="Go to Profile Settings">
                {user.imageUrl ? (
                    <Image src={user.imageUrl} alt={user.name} width={40} height={40} className="w-full h-full object-cover rounded-full" />
                ) : <User size={18} className="text-white/70" />}
            </button>
          </div>
        </div>
      )}

      {/* MAIN INTERFACE */}
      {isMenuOpen && (activeStage !== null) && (
        <>
          {/* SIDE DOCK */}
          <div className="absolute left-8 top-1/2 -translate-y-1/2 flex flex-col gap-6 z-50 animate-in slide-in-from-left-full duration-700">
            {['Mom', 'Dad'].map((name, i) => (
              <div key={name}  onClick={() => openQuickAction({ title: "Kids Messenger", url: "/kids-app/kids-message" })} className={`w-12 h-12 rounded-full border-2 border-white/20 flex items-center justify-center shadow-xl transition-all hover:scale-110 cursor-pointer ${i === 0 ? 'bg-blue-600' : 'bg-pink-600'}`}>
                <User size={20} className="text-white" />
              </div>
            ))}
            <div 
              onClick={() => openQuickAction({ title: "Kids Contacts", url: "/kids-app/kids-contact" })}
              className="w-12 h-12 rounded-full border-2 border-dashed border-white/20 flex items-center justify-center shadow-xl transition-all hover:scale-110 hover:border-white/50 cursor-pointer bg-white/10">
              <Plus size={20} className="text-white/70" />
            </div>
          </div>

          {/* PAGE CONTENT CONTAINER */}
          <div className="absolute inset-0 flex flex-col items-center justify-center px-6 z-40 pointer-events-none">
            <div className="w-full max-w-5xl pointer-events-auto flex flex-col items-center gap-12">
              
              {/* STAGE SELECTOR */}
              <div className="flex justify-center gap-4">
                {[0, 1, 2].map(i => (
                  <button 
                    key={i}
                    onClick={() => setActiveStage(i)}
                    className={`h-2 rounded-full transition-all duration-500 ${activeStage === i ? 'bg-indigo-500 w-12' : 'bg-white/20 w-2'}`}
                  />
                ))}
              </div>

              {/* STAGE CONTENT RENDERING */}
              <div className="w-full min-h-[500px] flex items-center justify-center transition-all duration-500">
                {activeStage === 0 && <StagePersonal 
                    mode={isOsMode} 
                    onQuickAction={openQuickAction}
                  />}
                {activeStage === 1 && (
                   <StageSearch 
                    input={input} 
                    setInput={setInput} 
                    handleSearch={(e) => { e.preventDefault(); handleNeuralQuery(); }} 
                    mode={isOsMode} 
                    isListening={isListening}
                    toggleVoice={toggleVoice}
                    isProcessing={isProcessing}
                    chatBubble={chatBubble}
                    history={history}
                    onPhoneClick={() => openQuickAction({ title: 'Phone Pad', url: '/family-shared/phone-pad' })}
                    onMessageClick={() => openQuickAction({ title: 'Kids Messenger', url: '/kids-app/kids-message' })}
                    onCameraClick={() => openQuickAction({ title: 'AR Camera', url: '/shared-app/ar-camera' })}
                    onMapClick={() => openQuickAction({ title: 'Family Anchor Map', url: '/shared-app/family-anchor-map' })}
                  />
                )}
                {activeStage === 2 && <StageInstall mode={isOsMode} onInstallClick={() => openQuickAction({ title: 'App Store', url: '/login/registration/admin/dashboard/audit-login/audit-journal/user-family/dashboard/peddle-tts/client-app-blueprints' })} />}
              </div>
            </div>
          </div>
        </>
      )}

      {/* FLOATING MASCOT */}
       {mascotPosition && (
        <div 
          className="fixed z-[100] transition-transform duration-300"
          style={{ left: mascotPosition.x, top: mascotPosition.y }}
          onMouseDown={handlePointerDown}
          onTouchStart={handlePointerDown}
          onMouseUp={handlePointerUp}
          onTouchEnd={handlePointerUp}
        >
          <div className={`w-20 h-20 backdrop-blur-3xl border-2 flex flex-col items-center justify-center cursor-pointer transition-all duration-700
            ${isOsMode ? 'bg-white/10 border-white/20 scale-110 shadow-2xl' : 'bg-black/90 border-white/10 scale-90'}
            rounded-[40%_60%_70%_30%/45%_45%_55%_55%] hover:scale-105 active:scale-90`}
          >
            <div className="flex gap-3">
               <div className="w-2 h-4 bg-black rounded-full overflow-hidden border border-white/5"><div className={`w-1 h-2 rounded-full blur-[1px] mt-1 ml-0.5 transition-colors ${isOsMode ? 'bg-cyan-400' : 'bg-slate-400'}`} style={eyeTransform} /></div>
               <div className="w-2 h-4 bg-black rounded-full overflow-hidden border border-white/5"><div className={`w-1 h-2 rounded-full blur-[1px] mt-1 ml-0.5 transition-colors ${isOsMode ? 'bg-cyan-400' : 'bg-slate-400'}`} style={eyeTransform} /></div>
            </div>
            {(mood === 'speaking' || mood === 'listening') && (
              <div className="flex gap-0.5 absolute bottom-4">
                 {[...Array(4)].map((_, i) => (
                   <div key={i} className="w-1 h-2 bg-cyan-400 rounded-full animate-bounce" style={{ animationDelay: `${i*0.1}s` }} />
                 ))}
              </div>
            )}
          </div>
          {!isMenuOpen && (<div className={`absolute bottom-full left-1/2 -translate-x-1/2 mb-6 w-48 p-4 rounded-3xl rounded-bl-none shadow-2xl text-[10px] font-black transition-all duration-500 border-2 ${isOsMode ? 'bg-white text-slate-900 border-white' : 'bg-black/95 text-white border-white/10'}`}>{chatBubble.length > 50 ? chatBubble.substring(0, 50) + "..." : chatBubble}<div className="absolute -bottom-2 left-0 w-4 h-4 bg-inherit border-b-2 border-l-2 border-inherit transform rotate-45" /></div>)}
        </div>
      )}

      {/* BROWSER PORTAL */}
      {activeBrowserUrl && isMenuOpen && (<div className="absolute inset-10 z-[200] bg-white rounded-[3rem] shadow-2xl overflow-hidden flex flex-col animate-in zoom-in-95 duration-500"><div className="p-4 bg-slate-50 border-b flex justify-between items-center"><div className="flex items-center gap-2 text-green-600 font-bold uppercase text-xs tracking-widest"><Shield size={16} /> Secure Portal</div><button onClick={() => setActiveBrowserUrl(null)} className="p-2 hover:bg-red-50 text-red-500 rounded-full transition-colors"><X size={24} /></button></div><iframe src={activeBrowserUrl} className="flex-1 w-full border-none" title="Safe Search" /></div>)}
      
      <AnimatePresence>
        {anyAppModalOpen && (
          <div className="fixed inset-0 z-[200] flex items-center justify-center p-6">
            <motion.div 
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={closeAllModals}
              className="absolute inset-0 bg-black/70 backdrop-blur-2xl cursor-default"
            />
            <motion.div 
              initial={{ opacity: 0, scale: 0.95, y: 30 }}
              animate={{ opacity: 1, scale: 1, y: 0 }}
              exit={{ opacity: 0, scale: 0.95, y: 20 }}
              transition={{ type: "spring", damping: 25, stiffness: 350 }}
              className="relative w-full max-w-6xl h-[90vh] bg-[#0c0c0c] border border-white/10 rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col"
            >
               <div className="flex items-center justify-between px-6 pt-6">
                <div className="flex items-center gap-2">
                  <button onClick={closeAllModals} className="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-white/60 hover:text-white transition-all active:scale-90" title="Back" > <ArrowLeft size={16} /> </button>
                  <button onClick={handleReload} className="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-white/60 hover:text-white transition-all active:scale-90" title="Reload" > <RotateCw size={16} className={isReloading ? "animate-spin text-blue-400" : ""} /> </button>
                </div>
                <div className="px-4 py-1.5 bg-white/5 border border-white/10 rounded-full text-[10px] font-mono text-slate-400">{quickAction?.url}</div>
                <button onClick={closeAllModals} className="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-white/40 hover:text-white transition-colors" > <X size={16} /> </button>
              </div>
              <div className="mt-4 h-[1px] w-full bg-gradient-to-r from-transparent via-white/10 to-transparent" />
              <div className="flex-1 mt-4 rounded-b-[2.5rem] overflow-hidden">
                <iframe id="app_iframe" src={quickAction?.url} className="w-full h-full border-none" title={quickAction?.title} />
              </div>
            </motion.div>
          </div>
        )}
      </AnimatePresence>

      <style dangerouslySetInnerHTML={{ __html: `
        @keyframes slow-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-slow-spin { animation: slow-spin 30s linear infinite; }
      `}} />
    </div>
  );
};

const StagePersonal = ({ mode, onQuickAction }) => {
  const [time, setTime] = useState(new Date());
  useEffect(() => { const timer = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(timer); }, []);
  
  const quickActions = [
      { label: "Personal Bank", icon: PiggyBank, url: '/kids-app/my-personal-bank'},
      { label: "Homework Helper", icon: HelpCircle, url: '/kids-app/kids-homework-helper'},
      { label: "Spike Store", icon: Star, url: '/kids-app/my-spikes-point-store'},
      { label: "My School", icon: School, url: '/kids-app/my-school'},
  ];

  return (
    <div className="w-full max-w-4xl space-y-6 animate-in fade-in zoom-in-95 duration-700">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div 
          onClick={() => onQuickAction({title: "Clock Settings", url: "/Family-Shared/clock-setting"})}
          className={`col-span-1 p-8 rounded-[3rem] border flex flex-col items-center justify-center transition-all cursor-pointer ${mode ? 'bg-white/5 border-white/10 text-white' : 'bg-white border-slate-200 shadow-xl text-slate-800'}`}
        >
          <h1 className="text-5xl font-black tracking-tighter">{time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</h1>
          <p className="text-xs font-bold uppercase tracking-widest opacity-40 mt-1">{time.toLocaleDateString([], { month: 'long', day: 'numeric', year: 'numeric' })}</p>
        </div>
        <div className={`col-span-1 p-8 rounded-[3rem] border flex flex-col justify-center transition-all ${mode ? 'bg-white/5 border-white/10 text-white' : 'bg-white border-slate-200 shadow-xl text-slate-800'}`}>
           <div className="flex items-center gap-2 text-indigo-500"><CloudSun size={32} /><span className="text-3xl font-black">72Â°</span></div>
           <div className="flex items-center gap-1 opacity-40 text-[10px] font-bold uppercase tracking-widest mt-1"><MapPin size={10} /> PALO ALTO, CA</div>
        </div>
        <div className={`p-6 rounded-[3rem] border flex flex-col justify-center transition-all space-y-2 ${mode ? 'bg-white/5 border-white/10 text-white' : 'bg-white border-slate-200 shadow-xl text-slate-800'}`}>
           <span className="text-[10px] font-black uppercase tracking-widest opacity-40 mb-2 text-indigo-500">Quick Actions</span>
            {quickActions.map(action => (
                <button key={action.label} onClick={() => onQuickAction(action)} className="flex items-center gap-3 w-full p-3 rounded-2xl bg-indigo-500/10 text-indigo-300 font-black uppercase text-xs tracking-widest hover:bg-indigo-500/20 hover:text-white transition-all">
                    <action.icon size={18} /> {action.label}
                </button>
            ))}
        </div>
      </div>
    </div>
  );
};


const StageSearch = ({ onAppClick, ...props }) => {
  const comms = [
    { id: 'phone', icon: <Phone size={24} />, label: "Phone", action: () => onAppClick({title: "Phone", url: "/family-shared/phone-pad"}) },
    { id: 'message', icon: <MessageSquare size={24} />, label: "Message", action: () => onAppClick({title: "Messages", url: "/kids-app/kids-message"}) },
    { id: 'camera', icon: <Camera size={24} />, label: "Camera", action: () => onAppClick({title: "AR Camera", url: "/shared-app/ar-camera"}) },
    { id: 'map', icon: <Map size={24} />, label: "Map", action: () => onAppClick({title: "Anchor Map", url: "/shared-app/family-anchor-map"}) }
  ];
  return (
    <div className="w-full h-full flex flex-col items-center justify-center gap-12 animate-in fade-in slide-in-from-bottom-12 duration-700">
      <div className="w-full max-w-2xl text-center">
         <div className={`inline-block px-10 py-6 rounded-[2.5rem] border backdrop-blur-3xl shadow-2xl bg-white/5 border-white/10 text-indigo-100/90`}>
            <p className="text-xl font-light leading-relaxed">{props.chatBubble}</p>
         </div>
      </div>
      <div className="grid grid-cols-4 gap-6 mt-4">
        {comms.map((item) => (<div key={item.id} onClick={item.action} className="flex flex-col items-center gap-3 group cursor-pointer"><div className="w-16 h-16 rounded-[1.25rem] flex items-center justify-center transition-all group-hover:scale-110 group-hover:-translate-y-1 shadow-2xl border-b-4 border-black/20 bg-slate-800 text-white">{item.icon}</div><span className="text-[9px] font-black uppercase tracking-widest transition-opacity group-hover:opacity-100 text-white/60 opacity-40">{item.label}</span></div>))}
      </div>
    </div>
  );
};


const StageInstall = ({ mode, onInstallClick }) => (
  <div className="w-full flex flex-col items-center gap-6 animate-in fade-in zoom-in-95 duration-1000">
    <button 
      onClick={onInstallClick}
      className={`w-40 h-40 rounded-[3rem] border-4 border-dashed flex flex-col items-center justify-center cursor-pointer hover:border-indigo-500 hover:bg-indigo-500/5 transition-all group ${mode ? 'border-white/10' : 'border-slate-200'}`}
    >
      <Plus size={48} className={`transition-transform group-hover:rotate-90 ${mode ? 'text-white/20' : 'text-slate-300'}`} />
      <span className={`mt-4 text-[10px] font-black uppercase tracking-[0.2em] ${mode ? 'text-white/20' : 'text-slate-400'}`}>Install Hub</span>
    </button>
    <div className={`text-[10px] font-black uppercase tracking-widest opacity-30 ${mode ? 'text-white' : 'text-slate-900'}`}>
      Multi-modal App Expansion
    </div>
  </div>
);

const App = (props) => {
    return (
        <FamilyDataProvider>
            <ToastProvider>
                <Suspense fallback={<div className="bg-black text-white flex items-center justify-center h-screen">Loading...</div>}>
                    <AppContent {...props} />
                </Suspense>
            </ToastProvider>
        </FamilyDataProvider>
    );
};

export default App;
