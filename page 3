'use client';

import { useState } from 'react';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';
import { 
    Baby, Users, User, ToyBrick, Briefcase, PiggyBank, HeartPulse, MessagesSquare, FolderKanban, 
    Video, Music, Radio, Palette, Anchor, Car, Map, FileText, Sheet, Calculator, Camera, 
    BrainCircuit, Calendar, Clock, Banknote, Power, VideoIcon, Disc, Phone, School, Home, 
    MessageCircle, HelpCircle, UserPlus, BookCopy, Wallet, Star, Server, Check, X, 
    Award, ShieldCheck, VideoOff, Timer, Globe, WifiOff, HardHat, KeyRound, ChevronRight,
    Search, Bell, Settings, Info, Save, Trash2, Mail, MapPin, Eye, EyeOff, Cpu, Rocket,
    AppWindow, LayoutGrid, History
} from 'lucide-react';
import Link from 'next/link';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuLabel, DropdownMenuSeparator, DropdownMenuTrigger, DropdownMenuGroup } from '@/components/ui/dropdown-menu';
import { AnimatePresence, motion } from 'framer-motion';


// --- Helper Components ---

const ProfileIcon = ({ icon: Icon, label, onClick, disabled = false }) => (
    <button 
        onClick={!disabled ? onClick : undefined} 
        disabled={disabled}
        className={`flex flex-col items-center gap-3 p-6 rounded-2xl transition-all duration-300 border-2 border-transparent group
            ${disabled 
                ? 'opacity-40 cursor-not-allowed bg-slate-50 dark:bg-slate-800/20' 
                : 'cursor-pointer hover:bg-indigo-50 dark:hover:bg-indigo-950/30 hover:border-indigo-200 dark:hover:border-indigo-900 active:scale-95 bg-white dark:bg-slate-900'}`}
    >
        <div className={`p-4 rounded-2xl transition-transform group-hover:scale-110 ${disabled ? 'bg-slate-200 dark:bg-slate-800' : 'bg-indigo-100 dark:bg-indigo-900/50'}`}>
            <Icon className={`size-8 ${disabled ? 'text-slate-400' : 'text-indigo-600 dark:text-indigo-400'}`} />
        </div>
        <span className={`text-sm font-bold ${disabled ? 'text-slate-400' : 'text-slate-900 dark:text-slate-100'}`}>{label}</span>
    </button>
);


const ProtocolItem = ({ children, allowed = true }) => (
    <li className="flex items-start gap-4 p-3 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800/40 transition-colors">
        {allowed ? (
            <div className="bg-green-100 dark:bg-green-900/30 p-1 rounded-full flex-shrink-0">
                <Check className="size-4 text-green-600 dark:text-green-400" />
            </div>
        ) : (
            <div className="bg-red-100 dark:bg-red-900/30 p-1 rounded-full flex-shrink-0">
                <X className="size-4 text-red-600 dark:text-red-400" />
            </div>
        )}
        <div className={allowed ? "text-slate-600 dark:text-slate-300" : "text-red-600 dark:text-red-400 italic"}>
            {children}
        </div>
    </li>
);

const TokenItem = ({ icon: Icon, label, idFormat }) => (
    <div className="flex flex-col items-center gap-2 p-5 rounded-xl bg-slate-900 border border-slate-800 text-center group transition-all hover:border-cyan-500/50 hover:shadow-[0_0_15px_rgba(6,182,212,0.1)]">
        <div className="relative w-14 h-14 flex items-center justify-center">
            <Icon className="size-8 text-cyan-400 z-10" />
            <div className="absolute inset-0 flex items-center justify-center text-slate-700 text-3xl font-bold select-none">?</div>
            <div className="absolute inset-0 bg-cyan-400/10 rounded-full blur-md opacity-0 group-hover:opacity-100 transition-opacity" />
        </div>
        <span className="text-xs font-bold text-white uppercase tracking-wider">{label}</span>
        <span className="text-[10px] font-mono text-slate-500 bg-slate-800 px-2 py-0.5 rounded">{idFormat}</span>
    </div>
);


// --- Identity Vault Components (New Addition) ---

const ProfileField = ({ icon: Icon, label, value, isSensitive = false, showSensitive }) => (
    <div className="flex items-start gap-4 p-4 border border-slate-200 dark:border-slate-700 rounded-2xl bg-slate-50 dark:bg-slate-800/50">
      <Icon size={20} className="text-blue-500 mt-1 flex-shrink-0" />
      <div className="flex-1">
        <p className="text-xs font-bold text-slate-400 uppercase">{label}</p>
        <p className="text-sm font-semibold text-slate-700 dark:text-slate-200">
          {isSensitive && !showSensitive ? '•••••••••' : value}
        </p>
      </div>
    </div>
);

const FormField = ({ label, name, value, onChange, placeholder, type = 'text', required = true }) => (
    <div>
        <label className="block text-sm font-semibold mb-1 text-slate-800 dark:text-slate-200">{label}</label>
        <input
            required={required}
            type={type}
            name={name}
            value={value}
            onChange={onChange}
            className="w-full p-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-slate-900 dark:text-white"
            placeholder={placeholder}
        />
    </div>
);


const AdultProfileModalContent = () => {
    const [isEditing, setIsEditing] = useState(false);
    const [showSensitive, setShowSensitive] = useState(false);
    const [formData, setFormData] = useState({
        fullName: '', dob: '', phone: '', email: '', address: '',
        city: '', province: '', postalCode: '', sin: '',
    });

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        // In a real app, this would save to a secure backend.
        // For this demo, we'll just switch back to view mode.
        setIsEditing(false);
    };

    if (isEditing) {
        return (
            <form onSubmit={handleSubmit} className="space-y-8">
                <section className="space-y-4">
                    <h3 className="font-bold text-slate-400 uppercase text-xs tracking-widest border-b border-slate-200 dark:border-slate-700 pb-2">Personal Essentials</h3>
                    <FormField label="Full Legal Name" name="fullName" value={formData.fullName} onChange={handleInputChange} placeholder="First Middle Last" />
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <FormField label="Date of Birth" name="dob" value={formData.dob} onChange={handleInputChange} type="date" />
                        <FormField label="Phone Number" name="phone" value={formData.phone} onChange={handleInputChange} placeholder="(555) 000-0000" />
                    </div>
                    <FormField label="Email Address" name="email" value={formData.email} onChange={handleInputChange} type="email" placeholder="email@provider.com" />
                </section>

                <section className="space-y-4">
                    <h3 className="font-bold text-slate-400 uppercase text-xs tracking-widest border-b border-slate-200 dark:border-slate-700 pb-2">Residency & Verification</h3>
                    <FormField label="Street Address" name="address" value={formData.address} onChange={handleInputChange} placeholder="123 Main St" />
                     <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <FormField label="City" name="city" value={formData.city} onChange={handleInputChange} />
                        <FormField label="Province" name="province" value={formData.province} onChange={handleInputChange} />
                        <FormField label="Postal Code" name="postalCode" value={formData.postalCode} onChange={handleInputChange} />
                    </div>
                    <FormField label="SIN (Social Insurance Number)" name="sin" value={formData.sin} onChange={handleInputChange} type="password" placeholder="000-000-000" />
                </section>
                
                <div className="flex justify-end gap-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                    <Button type="button" variant="outline" onClick={() => setIsEditing(false)}>Cancel</Button>
                    <Button type="submit">
                        <Save className="mr-2 size-4" /> Save Identity
                    </Button>
                </div>
            </form>
        );
    }

    return (
        <div className="space-y-8">
            {/* Profile Header */}
            <div className="flex flex-col md:flex-row items-start gap-8">
                <div className="w-32 h-32 bg-slate-100 dark:bg-slate-800 rounded-3xl flex items-center justify-center border-4 border-white dark:border-slate-700 shadow-inner">
                    <Camera size={64} className="text-slate-300 dark:text-slate-600" />
                </div>
                <div className="flex-1 space-y-4">
                    <div>
                        <h2 className="text-4xl font-black text-slate-800 dark:text-white">Waiting for User...</h2>
                        <p className="text-slate-500 dark:text-slate-400 flex items-center gap-2 mt-1">
                            <MapPin size={16} /> Location Undefined
                        </p>
                    </div>
                     <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <ProfileField icon={Mail} label="Primary Email" value="Waiting for Registry..." />
                        <ProfileField icon={Phone} label="Contact Number" value="Waiting for Registry..." />
                    </div>
                </div>
            </div>

            {/* Sensitive Data */}
            <div>
                <div className="flex items-center justify-between mb-6">
                    <h3 className="font-bold text-slate-400 uppercase tracking-widest text-sm">Service Provider Ready Data</h3>
                    <button onClick={() => setShowSensitive(!showSensitive)} className="flex items-center gap-2 text-sm font-bold text-blue-600 dark:text-blue-400 hover:opacity-80">
                        {showSensitive ? <EyeOff size={16} /> : <Eye size={16} />}
                        {showSensitive ? 'Hide Private Keys' : 'Reveal Sensitive Data'}
                    </button>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <ProfileField icon={Home} label="Residency" value="Waiting for Registry..." />
                    <ProfileField icon={ShieldCheck} label="Gov. Identity (SIN)" value="•••••••••" isSensitive showSensitive={showSensitive} />
                    <ProfileField icon={Calendar} label="Birth Date" value="Waiting for Registry..." isSensitive showSensitive={showSensitive} />
                </div>
            </div>
            
             {/* Core Service Tokens Section */}
            <div className="space-y-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                <div className="flex items-center gap-3">
                    <KeyRound className="size-6 text-cyan-500" />
                    <h3 className="font-black uppercase text-sm tracking-widest">Core Service Tokens</h3>
                </div>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <TokenItem icon={Radio} label="Live Studio" idFormat="[FAM]-[USR]" />
                    <TokenItem icon={FolderKanban} label="Media Vault" idFormat="[FAM]-ID" />
                    <TokenItem icon={Anchor} label="Home Anchor" idFormat="[FAM]-[DEV]" />
                    <TokenItem icon={Phone} label="Sovereign Comms" idFormat="[FAM]-ID" />
                </div>
            </div>

            {/* Action Buttons */}
            <div className="mt-8 flex flex-wrap gap-3 pt-6 border-t border-slate-200 dark:border-slate-700">
                <Button onClick={() => setIsEditing(true)}>
                    Edit Details
                </Button>
                <Button variant="destructive" disabled>
                    <Trash2 className="mr-2 size-4" /> Wipe Profile
                </Button>
            </div>
        </div>
    );
};

const KidProfileModalContent = () => {
    return (
        <div className="space-y-8">
            {/* Guardian Link Section */}
            <div className="p-4 bg-slate-100 dark:bg-slate-800/50 rounded-2xl border border-slate-200 dark:border-slate-700">
                <div className="flex items-center gap-4">
                    <div className="p-3 bg-green-100 dark:bg-green-900/30 rounded-xl">
                        <User className="size-6 text-green-600 dark:text-green-400"/>
                    </div>
                    <div>
                        <p className="text-xs font-bold text-slate-400 uppercase">Guardian Link</p>
                        <p className="font-semibold text-slate-700 dark:text-slate-200">Linked to Parent/Guardian Profile</p>
                    </div>
                </div>
            </div>

            {/* Profile Header */}
            <div className="flex flex-col md:flex-row items-start gap-8">
                <div className="w-32 h-32 bg-slate-100 dark:bg-slate-800 rounded-3xl flex items-center justify-center border-4 border-white dark:border-slate-700 shadow-inner">
                    <Baby size={64} className="text-slate-300 dark:text-slate-600" />
                </div>
                <div className="flex-1 space-y-4">
                    <div>
                        <h2 className="text-4xl font-black text-slate-800 dark:text-white">Waiting for User...</h2>
                        <p className="text-slate-500 dark:text-slate-400 mt-1">Child Profile</p>
                    </div>
                     <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <ProfileField icon={Phone} label="Emergency Contact" value="Waiting for Registry..." />
                        <ProfileField icon={Calendar} label="Birth Date" value="Waiting for Registry..." />
                    </div>
                </div>
            </div>
            
             {/* Core Service Tokens Section */}
            <div className="space-y-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                <div className="flex items-center gap-3">
                    <KeyRound className="size-6 text-cyan-500" />
                    <h3 className="font-black uppercase text-sm tracking-widest">Core Service Tokens</h3>
                </div>
                <p className="text-sm text-slate-500 dark:text-slate-400 -mt-4">
                    This profile is linked to the family's shared service tokens.
                </p>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <TokenItem icon={Radio} label="Live Studio" idFormat="[FAM]-[USR]" />
                    <TokenItem icon={FolderKanban} label="Media Vault" idFormat="[FAM]-ID" />
                    <TokenItem icon={Anchor} label="Home Anchor" idFormat="[FAM]-[DEV]" />
                    <TokenItem icon={Phone} label="Sovereign Comms" idFormat="[FAM]-ID" />
                </div>
            </div>

            {/* Action Buttons */}
            <div className="mt-8 flex flex-wrap gap-3 pt-6 border-t border-slate-200 dark:border-slate-700">
                <Button variant="outline" disabled>
                    View-Only Profile
                </Button>
            </div>
        </div>
    );
};



const appSections = [
    {
        title: 'Kids App Blueprints',
        id: 'kids',
        icon: <Rocket className="size-8 text-indigo-600 dark:text-indigo-400" />,
        description: 'Safe-zone templates specifically designed for children with high-level AI oversight.',
        apps: [
            { href: '/kids/kids-app/socialpost-view', icon: <ToyBrick className="size-6" />, title: 'Social App', description: 'The isolated social zone for kids.', mirStatus: 'yellow' },
            { href: '/kids/kids-app/kids-video-music', icon: <Music className="size-6" />, title: 'Kids\' Music & Video', description: 'Filtered long-form video and music.', mirStatus: 'yellow' },
            { href: '/kids-app/kids-hub', icon: <Home className="size-6" />, title: 'Kids Hub', description: 'The main dashboard for kids.', mirStatus: 'red' },
            { href: '/kids-app/my-school', icon: <School className="size-6" />, title: 'My School', description: 'Tools for homework and learning.', mirStatus: 'green' },
            { href: '/kids-app/my-kids-pebble', icon: <BrainCircuit className="size-6" />, title: 'My Kids Pebble', description: 'The core AI node for kids.', mirStatus: 'green' },
            { href: '/kids-app/kids-message', icon: <MessageCircle className="size-6" />, title: 'Kids Message', description: 'Send messages to family members.', mirStatus: 'red' },
            { href: '/kids-app/kids-homework-helper', icon: <HelpCircle className="size-6" />, title: 'Kids Homework Helper', description: 'AI-powered help for school work.', mirStatus: 'green' },
            { href: '/kids-app/kids-my-chat', icon: <MessagesSquare className="size-6" />, title: 'Kids My Chat', description: 'A private chat for kids.', mirStatus: 'green' },
            { href: '/kids-app/kids-contact', icon: <UserPlus className="size-6" />, title: 'Kids Contact', description: 'A list of approved contacts.', mirStatus: 'green' },
            { href: '/kids-app/my-personal-bank', icon: <Wallet className="size-6" />, title: 'My Personal Bank', description: 'View your personal bank account.', mirStatus: 'green' },
            { href: '/kids-app/my-spikes-point-store', icon: <Star className="size-6" />, title: 'My Spikes Point Store', description: 'Redeem your Spike Points for rewards.', mirStatus: 'green' }
        ]
    },
    {
        title: 'Family Shared App Blueprints',
        id: 'shared',
        icon: <Users className="size-8 text-indigo-600 dark:text-indigo-400" />,
        description: 'Applications that foster collaboration and transparency across all family tiers.',
        apps: [
            { href: '/shared-app/family-pebbles', icon: <BrainCircuit className="size-6" />, title: 'Family Pebble', description: 'Core AI node for shared knowledge.', mirStatus: 'green' },
            { href: '/shared-app/family-anchor-map', icon: <Anchor className="size-6" />, title: 'Family Anchor Map', description: 'Live map of all connected family devices.', mirStatus: 'green' },
            { href: '/shared-app/travinling-planing', icon: <Map className="size-6" />, title: 'Traveling Planning', description: 'Plan your family trips and adventures.', mirStatus: 'red' },
            { href: '/shared-app/word-processor', icon: <FileText className="size-6" />, title: 'Word Processor', description: 'Shared document editor for the family.', mirStatus: 'green' },
            { href: '/shared-app/spreadsheet', icon: <Sheet className="size-6" />, title: 'Spreadsheet', description: 'Family budgets, lists, and more.', mirStatus: 'green' },
            { href: '/shared-app/calculator', icon: <Calculator className="size-6" />, title: 'Calculator', description: 'Quick maths for the family.', mirStatus: 'yellow' },
            { href: '/shared-app/social-posting', icon: <MessagesSquare className="size-6" />, title: 'Social Posting', description: 'Create and share posts with your family.', mirStatus: 'yellow' },
            { href: '/shared-app/ar-camera', icon: <Camera className="size-6" />, title: 'AR Camera', description: 'Augmented reality filters and effects.', mirStatus: 'yellow' },
            { href: '/shared-app/video-posting', icon: <Video className="size-6" />, title: 'Video Posting', description: 'Share video moments with your family.', mirStatus: 'yellow' },
            { href: '/shared-app/Shared-Calendar', icon: <Calendar className="size-6" />, title: 'Shared Calendar', description: 'Central family scheduling app.', mirStatus: 'yellow' },
            { href: '/Family-Shared/clock-setting', icon: <Clock className="size-6" />, title: 'Clock', description: 'Holographic clock customization.', mirStatus: 'yellow' },
            { href: '/family-shared/spike-store', icon: <Banknote className="size-6" />, title: 'Spike Store', description: 'Spike Points reward system.', mirStatus: 'yellow' },
            { href: '/family-shared/family-banking', icon: <Power className="size-6" />, title: 'Family Banking', description: 'Shared family financial tools.', mirStatus: 'yellow' },
            { href: '/family-shared/live-video-recording', icon: <VideoIcon className="size-6" />, title: 'Live Video Recording', description: 'Record and share live video.', mirStatus: 'red' },
            { href: '/family-shared/my-tuner', icon: <Disc className="size-6" />, title: 'MyTuner', description: 'Tune in to family broadcasts.', mirStatus: 'yellow' },
            { href: '/family-shared/phone-pad', icon: <Phone className="size-6" />, title: 'Phone Pad', description: 'Isolated phone pad for secure calls.', mirStatus: 'yellow' },
            { href: '/family-shared/family-chat', icon: <MessagesSquare className="size-6" />, title: 'Family Chat', description: 'Secure messaging for the whole family.', mirStatus: 'yellow' },
            { href: '/family-shared/media-vault', icon: <FolderKanban className="size-6" />, title: 'Media Vault', description: 'Shared photos, videos, and docs.', mirStatus: 'red' },
            { href: '/shared-app/video-creator', icon: <Video className="size-6" />, title: 'Video Studio', description: 'Create and edit family videos.', mirStatus: 'yellow' },
            { href: '/shared-app/audio-studio', icon: <Music className="size-6" />, title: 'Audio Studio', description: 'Record podcasts and music.', mirStatus: 'yellow' },
            { href: '/shared-app/live-studio', icon: <Radio className="size-6" />, title: 'Live Studio', description: 'DJ booth and live radio.', mirStatus: 'red' },
            { href: '/shared-app/art-studio', icon: <Palette className="size-6" />, title: 'Art Studio', description: 'Digital painting and drawing tools.', mirStatus: 'yellow' }
        ]
    },
    {
        title: 'Adult App Blueprints',
        id: 'adults',
        icon: <User className="size-8 text-indigo-600 dark:text-indigo-400" />,
        description: 'Unrestricted templates for productivity, finance, and wellness for adult profiles.',
        apps: [
            { href: '/adult-app/adult-socialpost-view', icon: <MessagesSquare className="size-6" />, title: 'Adult Social Posting', description: 'Private social feed for adults.', mirStatus: 'yellow' },
            { href: '/car', icon: <Car className="size-6" />, title: 'Car Info System', description: 'Central dashboard for vehicle tech.', mirStatus: 'yellow' },
            { href: '/adult-app/my-work', icon: <Briefcase className="size-6" />, title: 'My Work', description: 'Productivity and work-related tools.', mirStatus: 'green' },
            { href: '/adult-app/banking-app', icon: <PiggyBank className="size-6" />, title: 'Banking App', description: 'Personal and family finance management.', mirStatus: 'green' },
            { href: '/adult-app/adult-music-video', icon: <Music className="size-6" />, title: 'Music & Video Hub', description: 'Long-form video content hub.', mirStatus: 'yellow' },
            { href: '/adult-app/adults-hub', icon: <Home className="size-6" />, title: 'Adults Hub', description: 'The main dashboard for adults.', mirStatus: 'red' },
            { href: '/adult-app/my-adult-pebble', icon: <BrainCircuit className="size-6" />, title: 'My Adult Pebble', description: 'The core AI node for adults.', mirStatus: 'yellow' },
            { href: '/adult-app/adults-message', icon: <MessagesSquare className="size-6" />, title: 'Adults Message', description: 'Send messages to family and contacts.', mirStatus: 'yellow' },
            { href: '/adult-app/work-helper', icon: <HelpCircle className="size-6" />, title: 'Work Helper', description: 'AI-powered assistance for tasks.', mirStatus: 'yellow' },
            { href: '/adult-app/adults-my-chat', icon: <MessagesSquare className="size-6" />, title: 'Adults My Chat', description: 'Private and group chat for adults.', mirStatus: 'yellow' },
            { href: '/adult-app/adults-contact', icon: <UserPlus className="size-6" />, title: 'Adults Contact', description: 'Manage personal and work contacts.', mirStatus: 'yellow' },
            { href: '/adult-app/my-personal-bank', icon: <Wallet className="size-6" />, title: 'My Personal Bank', description: 'Manage personal bank accounts.', mirStatus: 'green' },
            { href: '/adult-app/my-spikes-point-store', icon: <Star className="size-6" />, title: 'My Spikes Point Store', description: 'Redeem Spike Points for rewards.', mirStatus: 'yellow' },
            { href: '/adult-app/health-wellness', icon: <HeartPulse className="size-6" />, title: 'Health & Wellness', description: 'Fitness, records, and wellness apps.', mirStatus: 'green' }
        ]
    }
];

const AppCard = ({ href, icon, title, description, mirStatus, onActionClick }) => {
    const statusClasses = {
        green: 'bg-green-500',
        yellow: 'bg-yellow-500',
        red: 'bg-red-500',
    };

    const borderClasses = {
        green: 'border-green-500/80 shadow-lg shadow-green-500/10 dark:shadow-[0_0_30px_rgba(74,222,128,0.15)]',
        yellow: 'border-yellow-500/60',
        red: 'border-red-500/60',
    };
    
    const cardBorder = borderClasses[mirStatus] || 'border-slate-200 dark:border-slate-800';
    const mirColor = statusClasses[mirStatus] || 'bg-gray-500';

    return (
        <Card className={`relative flex flex-col h-full bg-white dark:bg-slate-900/40 text-left transition-all hover:-translate-y-1 group border-2 ${cardBorder}`}>
            <CardHeader className="flex flex-row items-start gap-5 pb-4">
                <div className="p-3 bg-slate-100 dark:bg-slate-800 rounded-xl text-slate-500 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">
                    {icon}
                </div>
                <div className="flex-1">
                     <CardTitle className="text-base font-bold">{title}</CardTitle>
                    <CardDescription className="line-clamp-2 text-xs leading-relaxed mt-1">
                        {description}
                    </CardDescription>
                </div>
                <Tooltip>
                    <TooltipTrigger asChild>
                        <div className={`w-3 h-3 rounded-full border-2 border-slate-50 dark:border-slate-950 flex-shrink-0 ${mirColor}`} />
                    </TooltipTrigger>
                    <TooltipContent>
                        <p>MIR Status: {mirStatus.charAt(0).toUpperCase() + mirStatus.slice(1)}</p>
                    </TooltipContent>
                </Tooltip>
            </CardHeader>
            <CardContent className="flex-grow" />
            <div className="p-4 pt-0">
                <Button variant="outline" className="w-full" onClick={(e) => { e.preventDefault(); onActionClick(); }}>
                    Launch
                </Button>
            </div>
        </Card>
    );
};

export default function ClientAppsPage() {
    const [isFamilyModalOpen, setIsFamilyModalOpen] = useState(false);
    const [isSystemModalOpen, setIsSystemModalOpen] = useState(false);
    const [isAdultProfileModalOpen, setIsAdultProfileModalOpen] = useState(false);
    const [isKidProfileModalOpen, setIsKidProfileModalOpen] = useState(false);
    
    const [simulatedRole, setSimulatedRole] = useState<'admin' | 'adult' | 'kid'>('admin');
    const [previewUrl, setPreviewUrl] = useState<string | null>(null);

    const visibleSections = appSections.filter(section => {
        if (simulatedRole === 'admin') return true;
        if (simulatedRole === 'adult') return true;
        if (simulatedRole === 'kid') return section.id === 'kids' || section.id === 'shared';
        return false;
    });

    const RoleSwitcherIcon = ({ role, label, icon: Icon, color }) => (
        <Tooltip>
            <TooltipTrigger asChild>
                <button
                    onClick={() => setSimulatedRole(role)}
                    className={`p-2.5 rounded-full transition-all duration-300 ${simulatedRole === role ? `${color} text-white shadow-lg` : 'bg-slate-100 dark:bg-slate-900 text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-800'}`}
                >
                    <Icon className="size-5" />
                </button>
            </TooltipTrigger>
            <TooltipContent>
                <p>View as {label}</p>
            </TooltipContent>
        </Tooltip>
    );

    return (
        <TooltipProvider>
        <div className="min-h-screen bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 font-sans selection:bg-indigo-500/30">
            <header className="sticky top-0 z-40 bg-white/80 dark:bg-slate-950/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800">
                <div className="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between">
                    <div className="flex items-center gap-4">
                        <div className="bg-indigo-600 p-2.5 rounded-xl shadow-lg shadow-indigo-500/20">
                            <BrainCircuit className="size-6 text-white" />
                        </div>
                        <div>
                            <h1 className="text-xl font-black tracking-tight uppercase">Sovereign <span className="text-indigo-600">OS</span></h1>
                            <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Client App Blueprints</p>
                        </div>
                    </div>
                    
                    <div className="hidden md:flex items-center gap-2 p-1.5 rounded-full bg-slate-100 dark:bg-slate-900 border border-slate-200 dark:border-slate-800">
                        <RoleSwitcherIcon role="admin" label="Admin" icon={Cpu} color="bg-gray-600" />
                        <RoleSwitcherIcon role="adult" label="Adult" icon={User} color="bg-blue-600" />
                        <RoleSwitcherIcon role="kid" label="Kid" icon={Rocket} color="bg-pink-600" />
                        <div className="w-px h-6 bg-slate-200 dark:bg-slate-700 mx-1" />
                        <Tooltip>
                            <TooltipTrigger asChild>
                                <Link href="/login/registration/admin/dashboard/audit-login/audit-journal/user-family/dashboard/peddle-tts">
                                    <button className='p-2.5 rounded-full bg-slate-100 dark:bg-slate-900 text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-800'>
                                        <Cpu className="size-5 text-indigo-400" />
                                    </button>
                                </Link>
                            </TooltipTrigger>
                            <TooltipContent><p>PEDLLE TTS Engine</p></TooltipContent>
                        </Tooltip>
                         <Tooltip>
                            <TooltipTrigger asChild>
                                <Link href="/shared-app/family-pebbles">
                                    <button className='p-2.5 rounded-full bg-slate-100 dark:bg-slate-900 text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-800'>
                                        <BrainCircuit className="size-5 text-green-400" />
                                    </button>
                                </Link>
                            </TooltipTrigger>
                            <TooltipContent><p>Family Pebbles</p></TooltipContent>
                        </Tooltip>
                         <Tooltip>
                            <TooltipTrigger asChild>
                                <Link href="/shared-app/Shared-Calendar">
                                    <button className='p-2.5 rounded-full bg-slate-100 dark:bg-slate-900 text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-800'>
                                        <Calendar className="size-5 text-red-400" />
                                    </button>
                                </Link>
                            </TooltipTrigger>
                            <TooltipContent><p>Shared Calendar</p></TooltipContent>
                        </Tooltip>
                        <Tooltip>
                            <TooltipTrigger asChild>
                                <button className='p-2.5 rounded-full bg-slate-100 dark:bg-slate-900 text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-800 cursor-not-allowed opacity-50'>
                                    <History className="size-5 text-orange-400" />
                                </button>
                            </TooltipTrigger>
                            <TooltipContent><p>Audit Journal (Confirmation Light)</p></TooltipContent>
                        </Tooltip>
                    </div>

                    <DropdownMenu>
                        <DropdownMenuTrigger asChild>
                            <Button variant="outline" className="hidden md:inline-flex items-center gap-2 bg-slate-100 dark:bg-slate-900 border-slate-200 dark:border-slate-800">
                                <AppWindow size={16} />
                                Sovereign App Launcher
                                <ChevronRight className="size-4 opacity-50" />
                            </Button>
                        </DropdownMenuTrigger>
                        <DropdownMenuContent className="w-64" align="end">
                            <DropdownMenuLabel>Preview an App</DropdownMenuLabel>
                            <DropdownMenuSeparator />
                            {appSections.map(section => (
                                <DropdownMenuGroup key={section.id}>
                                    <DropdownMenuLabel className="text-xs text-muted-foreground">{section.title}</DropdownMenuLabel>
                                    {section.apps.map(app => (
                                        <DropdownMenuItem key={app.href} onSelect={() => setPreviewUrl(app.href)}>
                                            {app.icon}
                                            <span className="ml-2">{app.title}</span>
                                        </DropdownMenuItem>
                                    ))}
                                    <DropdownMenuSeparator />
                                </DropdownMenuGroup>
                            ))}
                        </DropdownMenuContent>
                    </DropdownMenu>

                    <div className="flex items-center gap-3">
                    </div>
                </div>
            </header>

            <main className="max-w-7xl mx-auto px-4 py-12 space-y-16">
                
                <section>
                    <div className="mb-8">
                        <h2 className="text-2xl font-black mb-2 uppercase tracking-tight">Identity & Governance</h2>
                        <p className="text-slate-500 dark:text-slate-400">Manage family roles, protocol hierarchies, and service registrations.</p>
                    </div>
                    <Card className="p-2 bg-slate-100 dark:bg-slate-900/50">
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-2">
                            <ProfileIcon icon={Users} label="Family Shared" onClick={() => setIsFamilyModalOpen(true)} />
                            <ProfileIcon icon={User} label="Adult Profile" onClick={() => setIsAdultProfileModalOpen(true)} />
                            <ProfileIcon icon={Baby} label="Kid Profile" onClick={() => setIsKidProfileModalOpen(true)} />
                            <ProfileIcon icon={Server} label="System Config" onClick={() => setIsSystemModalOpen(true)} />
                        </div>
                    </Card>
                </section>
                
                <div className="p-1 w-full text-center">
                    <p className="text-sm font-bold text-indigo-500 dark:text-indigo-400 uppercase tracking-widest">
                        Viewing as: {simulatedRole}
                    </p>
                </div>


                {visibleSections.map((section) => (
                    <div key={section.title} className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                        <div className="flex items-start gap-6 group">
                            <div className="p-4 bg-indigo-100 dark:bg-indigo-900/30 rounded-2xl transition-transform group-hover:scale-105">
                                {section.icon}
                            </div>
                            <div className="max-w-2xl">
                                <h2 className="text-2xl font-black uppercase tracking-tight mb-1">{section.title}</h2>
                                <p className="text-slate-500 dark:text-slate-400 leading-relaxed">{section.description}</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {section.apps.map((app, idx) => (
                                <AppCard 
                                    key={app.href || idx} 
                                    {...app} 
                                    onActionClick={() => setPreviewUrl(app.href)}
                                />
                            ))}
                        </div>
                    </div>
                ))}
            </main>
            
            <Dialog open={!!previewUrl} onOpenChange={() => setPreviewUrl(null)}>
                <DialogContent className="max-w-5xl h-[90vh] flex flex-col p-0 gap-0 dark:bg-slate-950">
                    <DialogHeader className="p-4 border-b dark:border-slate-800 flex-row items-center justify-between">
                         <DialogTitle className="text-white">App Preview</DialogTitle>
                         <DialogDescription className="text-slate-400">{previewUrl}</DialogDescription>
                    </DialogHeader>
                    <div className="flex-1 w-full h-full bg-gray-100 dark:bg-slate-800">
                        {previewUrl && <iframe src={previewUrl} className="w-full h-full border-0" title="App Preview" />}
                    </div>
                </DialogContent>
            </Dialog>


            <footer className="max-w-7xl mx-auto px-4 py-12 border-t border-slate-200 dark:border-slate-800 text-center">
                <div className="flex items-center justify-center gap-2 mb-4">
                    <BrainCircuit className="size-5 text-indigo-600" />
                    <span className="font-bold uppercase tracking-tighter text-sm">Sovereign OS Staging Environment</span>
                </div>
                <p className="text-xs text-slate-500">&copy; 2025 Sovereign Universe. All protocols engaged.</p>
            </footer>

            <Dialog open={isFamilyModalOpen} onOpenChange={setIsFamilyModalOpen}>
                <DialogContent className="sm:max-w-4xl p-0">
                    <DialogHeader className="p-8 pb-4">
                        <DialogTitle>
                            <div className="flex items-center gap-3 mb-2">
                                <Users className="size-8 text-indigo-500" />
                                <h2 className="text-2xl font-bold">Family Shared Protocols</h2>
                            </div>
                        </DialogTitle>
                         <DialogDescription className="text-slate-500 dark:text-slate-400 !mt-2">
                            Identity-based rules and capabilities defining how family tiers interact with shared infrastructure.
                        </DialogDescription>
                    </DialogHeader>
                    <div className="p-8 pt-0 max-h-[80vh] overflow-y-auto">
                        <div className="space-y-10">
                            <div className="grid md:grid-cols-2 gap-8">
                                <div className="space-y-6">
                                    <div className="flex items-center gap-3 border-b border-slate-100 dark:border-slate-800 pb-3">
                                        <User className="size-5 text-indigo-500" />
                                        <h3 className="font-black uppercase text-sm tracking-widest">Adult Protocols</h3>
                                    </div>
                                    <ul className="space-y-2">
                                        <ProtocolItem>Full access to create, edit, and delete calendar events.</ProtocolItem>
                                        <ProtocolItem>Moderate and delete posts in the Kids Social Zone.</ProtocolItem>
                                        <ProtocolItem>Full read/write/delete access to the family Media Vault.</ProtocolItem>
                                        <ProtocolItem>Authorized to initiate secure family-wide broadcasts.</ProtocolItem>
                                    </ul>
                                </div>
                                <div className="space-y-6">
                                    <div className="flex items-center gap-3 border-b border-slate-100 dark:border-slate-800 pb-3">
                                        <Baby className="size-5 text-indigo-500" />
                                        <h3 className="font-black uppercase text-sm tracking-widest">Kid Protocols</h3>
                                    </div>
                                    <ul className="space-y-2">
                                        <ProtocolItem>Read-only access to master calendar events.</ProtocolItem>
                                        <ProtocolItem>Permission to create posts; deletion limited to own content.</ProtocolItem>
                                        <ProtocolItem allowed={false}>Social posts require AI moderation before broadcast.</ProtocolItem>
                                        <ProtocolItem>Access to tier-approved directory paths in Media Vault.</ProtocolItem>
                                    </ul>
                                </div>
                            </div>
                            
                            <div className="space-y-6">
                                <div className="flex items-center gap-3">
                                    <Info className="size-6 text-cyan-500" />
                                    <h3 className="font-black uppercase text-sm tracking-widest">Family Prefix (Registration)</h3>
                                </div>
                                <div className="p-6 bg-slate-50 dark:bg-slate-800/40 rounded-2xl border border-slate-200 dark:border-slate-700 flex items-center justify-center text-center">
                                    <div>
                                        <p className="font-mono text-4xl font-black text-slate-300 dark:text-slate-600 tracking-widest">???</p>
                                        <p className="text-xs font-bold text-slate-400 dark:text-slate-500 uppercase mt-2">Awaiting Full Family Registry</p>
                                    </div>
                                </div>
                            </div>


                            <div className="p-8 bg-slate-50 dark:bg-slate-800/40 rounded-2xl border border-slate-200 dark:border-slate-700">
                                <h3 className="font-black uppercase text-xs tracking-widest mb-6 text-slate-500">Family Roster (Provisioning Stage)</h3>
                                <div className="flex flex-wrap gap-8 justify-center sm:justify-start">
                                    {[1, 2, 3, 4, 5].map((i) => (
                                        <div key={i} className="flex flex-col items-center gap-3 group">
                                            <div className="w-20 h-20 rounded-full bg-white dark:bg-slate-900 border-2 border-dashed border-slate-300 dark:border-slate-700 flex items-center justify-center text-slate-300 transition-colors group-hover:border-indigo-400">
                                                <UserPlus className="size-8" />
                                            </div>
                                            <span className="text-[10px] font-bold uppercase text-slate-400">Slot {i}: Unassigned</span>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="space-y-6">
                                <div className="flex items-center gap-3">
                                    <KeyRound className="size-6 text-cyan-500" />
                                    <h3 className="font-black uppercase text-sm tracking-widest">Core Service Tokens</h3>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <TokenItem icon={Radio} label="Live Studio" idFormat="[FAM]-[USR]" />
                                    <TokenItem icon={FolderKanban} label="Media Vault" idFormat="[FAM]-ID" />
                                    <TokenItem icon={Anchor} label="Home Anchor" idFormat="[FAM]-[DEV]" />
                                    <TokenItem icon={Phone} label="Sovereign Comms" idFormat="[FAM]-ID" />
                                </div>
                            </div>
                        </div>
                    </div>
                </DialogContent>
            </Dialog>

            <Dialog open={isAdultProfileModalOpen} onOpenChange={setIsAdultProfileModalOpen}>
                <DialogContent className="sm:max-w-4xl p-0">
                     <DialogHeader className="p-8 pb-4">
                        <DialogTitle>
                            <div className="flex items-center gap-3 mb-2">
                                <User className="size-8 text-indigo-500" />
                                <h2 className="text-2xl font-bold">Adult Identity Vault</h2>
                            </div>
                        </DialogTitle>
                        <DialogDescription className="text-slate-500 dark:text-slate-400 !mt-2">
                            This is the master template for an adult profile, showing all required fields and assigned core service tokens.
                        </DialogDescription>
                    </DialogHeader>
                    <div className="p-8 pt-0 max-h-[80vh] overflow-y-auto">
                        <AdultProfileModalContent />
                    </div>
                </DialogContent>
            </Dialog>
            
            <Dialog open={isKidProfileModalOpen} onOpenChange={setIsKidProfileModalOpen}>
                <DialogContent className="sm:max-w-4xl p-0">
                    <DialogHeader className="p-8 pb-4">
                        <DialogTitle>
                            <div className="flex items-center gap-3 mb-2">
                                <Baby className="size-8 text-pink-500" />
                                <h2 className="text-2xl font-bold">Kid Identity Vault (Read-Only)</h2>
                            </div>
                        </DialogTitle>
                        <DialogDescription className="text-slate-500 dark:text-slate-400 !mt-2">
                            This is a child's profile template. It is managed by a linked parent or guardian account.
                        </DialogDescription>
                    </DialogHeader>
                    <div className="p-8 pt-0 max-h-[80vh] overflow-y-auto">
                        <KidProfileModalContent />
                    </div>
                </DialogContent>
            </Dialog>


            <Dialog open={isSystemModalOpen} onOpenChange={setIsSystemModalOpen}>
                <DialogContent className="sm:max-w-4xl p-0">
                    <DialogHeader className="p-8 pb-4">
                        <DialogTitle>
                            <div className="flex items-center gap-3 mb-2">
                                <Server className="size-8 text-indigo-500" />
                                <h2 className="text-2xl font-bold">System Protocols & Creator Stamps</h2>
                            </div>
                        </DialogTitle>
                        <DialogDescription className="text-slate-500 dark:text-slate-400 !mt-2">
                            Global governance rules for content safety, creator validation, and cinematic enhancements.
                        </DialogDescription>
                    </DialogHeader>
                    <div className="p-8 pt-0 max-h-[80vh] overflow-y-auto">
                        <div className="space-y-12">
                            <div className="grid md:grid-cols-2 gap-12">
                                <div className="space-y-6">
                                    <div className="flex items-center gap-3 border-b border-slate-100 dark:border-slate-800 pb-3">
                                        <ShieldCheck className="size-5 text-indigo-500" />
                                        <h3 className="font-black uppercase text-sm tracking-widest">Content Moderation</h3>
                                    </div>
                                    <ul className="space-y-6">
                                        <li className="flex gap-4">
                                            <div className="p-2 bg-amber-100 dark:bg-amber-900/30 rounded-lg h-fit"><Timer className="size-5 text-amber-600" /></div>
                                            <div>
                                                <p className="font-bold text-sm mb-1">15-Second Live Delay</p>
                                                <p className="text-xs text-slate-500">Live streams buffered for AI threat/safety analysis.</p>
                                            </div>
                                        </li>
                                        <li className="flex gap-4">
                                            <div className="p-2 bg-red-100 dark:bg-red-900/30 rounded-lg h-fit"><VideoOff className="size-5 text-red-600" /></div>
                                            <div>
                                                <p className="font-bold text-sm mb-1">Automatic Content Veto</p>
                                                <p className="text-xs text-slate-500">Instant kill-switch for detected explicit or harmful material.</p>
                                            </div>
                                        </li>
                                        <li className="flex gap-4">
                                            <div className="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg h-fit"><Globe className="size-5 text-blue-600" /></div>
                                            <div>
                                                <p className="font-bold text-sm mb-1">Sovereign Intranet</p>
                                                <p className="text-xs text-slate-500">All external content is re-served locally; child profiles never access the raw internet.</p>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                                <div className="space-y-6">
                                    <div className="flex items-center gap-3 border-b border-slate-100 dark:border-slate-800 pb-3">
                                        <Award className="size-5 text-indigo-500" />
                                        <h3 className="font-black uppercase text-sm tracking-widest">Creator Stamps</h3>
                                    </div>
                                    <ul className="space-y-6">
                                        <li className="flex gap-4">
                                            <div className="p-2 bg-green-100 dark:bg-green-900/30 rounded-lg h-fit">
                                                <ShieldCheck className="size-5 text-green-600" />
                                            </div>
                                            <div>
                                                <p className="font-bold text-sm mb-1">Kid-Safe Creator</p>
                                                <p className="text-xs text-slate-500">
                                                    Badge awarded to adults who consistently produce content that passes all child safety protocols.
                                                </p>
                                            </div>
                                        </li>
                                        <li className="flex gap-4">
                                            <div className="p-2 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg h-fit"><Star className="size-5 text-yellow-600" /></div>
                                            <div>
                                                <p className="font-bold text-sm mb-1">Universe Contributor</p>
                                                <p className="text-xs text-slate-500">For high-usage template or asset contributions.</p>
                                            </div>
                                        </li>
                                        <li className="flex gap-4 opacity-50 italic">
                                            <div className="p-2 bg-slate-100 dark:bg-slate-800 rounded-lg h-fit"><HardHat className="size-5 text-slate-500" /></div>
                                            <div>
                                                <p className="font-bold text-sm mb-1">Protocol Architect</p>
                                                <p className="text-xs text-slate-500">Access granted to governance rule configuration.</p>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div className="p-8 bg-indigo-600 rounded-2xl text-white shadow-xl shadow-indigo-500/20">
                                <div className="flex items-center gap-3 mb-6">
                                    <Palette className="size-6" />
                                    <h3 className="font-black uppercase text-sm tracking-widest">Cinematic Plugins</h3>
                                </div>
                                <div className="grid md:grid-cols-2 gap-8">
                                    <div className="bg-white/10 p-4 rounded-xl backdrop-blur-sm">
                                        <p className="font-bold text-sm mb-2">Portal Entry FX Library</p>
                                        <p className="text-xs text-indigo-100 opacity-80 leading-relaxed">Visual transitions between workspace environments and family zones.</p>
                                    </div>
                                    <div className="bg-white/10 p-4 rounded-xl backdrop-blur-sm">
                                        <p className="font-bold text-sm mb-2">System Aura Tones</p>
                                        <p className="text-xs text-indigo-100 opacity-80 leading-relaxed">Ambient soundscapes synchronized across shared devices for unity.</p>
                                    </div>
                                </div>
                            </div>
                            <div className="pt-8 border-t border-slate-200 dark:border-slate-700">
                                 <div className="flex items-center gap-3 mb-2">
                                     <div className="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg h-fit"><Globe className="size-5 text-blue-600" /></div>
                                     <h3 className="font-black uppercase text-sm tracking-widest text-slate-600 dark:text-slate-300">Sovereign Intranet</h3>
                                 </div>
                                 <ul className="space-y-4 text-sm text-slate-500 pl-4">
                                     <ProtocolItem>All external content is re-served locally; child profiles never access the raw internet.</ProtocolItem>
                                     <ProtocolItem>The child's "internet" experience dynamically expands or contracts based on behavioral integrity, not arbitrary time limits.</ProtocolItem>
                                     <ProtocolItem allowed={false}>Peer discovery is permanently disabled for child profiles. The social graph is fixed by parental control.</ProtocolItem>
                                 </ul>
                            </div>
                        </div>
                    </div>
                </DialogContent>
            </Dialog>
        </div>
        </TooltipProvider>
    );
}
