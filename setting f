
'use client';

import React, { useState, useEffect, useMemo, useCallback, useRef } from 'react';
import { 
  Shield, Activity, Database, Lock, Eye, Zap, 
  Users, Terminal, Cpu, MessageSquare, Heart, 
  Star, Globe, Radio, Mic, ScanFace, Satellite, 
  Share2, ShieldCheck, Waves, Layout, Layers,
  Compass, BellRing, Smartphone, Navigation,
  Thermometer, ShieldAlert, AlertTriangle, History, ArrowLeft, User as UserIcon, Settings, X, Anchor,
  ShoppingBag, Rocket, User
} from 'lucide-react';
import { initializeApp, getApps, getApp } from 'firebase/app';
import { 
  getFirestore, collection, onSnapshot, doc, 
  query, addDoc, serverTimestamp, deleteDoc, orderBy
} from 'firebase/firestore';
import { 
  getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged 
} from 'firebase/auth';
import { motion, AnimatePresence } from 'framer-motion';
import Link from 'next/link';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';
import { cn } from '@/lib/utils';


// --- Configuration ---
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

// --- Corrected Firebase Initialization ---
let app;
if (!getApps().length) {
  try {
      if (Object.keys(firebaseConfig).length > 0) {
        app = initializeApp(firebaseConfig);
      }
  } catch (e) {
    console.error("Firebase initialization failed:", e);
  }
} else {
  app = getApp();
}

const db = app ? getFirestore(app) : null;
const auth = app ? getAuth(app) : null;
const appId = typeof __app_id !== 'undefined' ? __app_id : 'sovereign-audit-engine-v1';

// --- NEW Biometric Card Component ---
const BiometricCard = ({ member, onUserClick }) => {
  const isAdult = member.role === 'Guardian';
  const stampText = isAdult ? 'Adult Certified' : 'Child Protected';
  const stampColor = isAdult ? 'border-blue-400 text-blue-400' : 'border-pink-400 text-pink-400';
  const Icon = isAdult ? UserIcon : Rocket;

  return (
    <div className="relative p-2 pr-4 bg-white/5 rounded-2xl border border-transparent hover:border-blue-500/20 flex items-center gap-3 transition-all group">
      <div 
        className="absolute top-2 right-2 px-2 py-0.5 border-2 rounded-full text-[8px] font-black tracking-widest uppercase transition-all duration-300 group-hover:bg-white/10 group-hover:scale-110"
        style={{ transform: isAdult ? 'rotate(5deg)' : 'rotate(-5deg)' }}
      >
        <div className={stampColor}>{stampText}</div>
      </div>
      <button onClick={() => onUserClick(member)} className="w-8 h-8 rounded-full bg-blue-900/40 flex items-center justify-center font-bold text-sm cursor-pointer hover:scale-110 transition-transform">
        {member.name[0]}
      </button>
      <div className="flex-1">
        <p className="font-bold text-xs">{member.name}</p>
        <p className="text-[9px] text-gray-500 uppercase font-medium">{member.role}</p>
      </div>
      <div className="w-24">
        <div className="flex items-center gap-1.5">
          <div className="flex-1 h-1 bg-gray-700 rounded-full overflow-hidden">
            <div className="h-full bg-blue-500" style={{ width: `${member.confidence}%` }} />
          </div>
          <span className="text-[10px] w-10 text-right font-mono">{member.confidence.toFixed(1)}%</span>
        </div>
      </div>
      <div className="flex gap-4 text-gray-600 pl-4 border-l border-white/5 group-hover:text-blue-400 transition-colors">
        <ScanFace size={16} className={member.confidence > 95 ? 'text-blue-400' : 'text-gray-600'} />
        <Mic size={16} className={member.confidence > 90 ? 'text-blue-400' : 'text-gray-600'} />
        <Waves size={16} className="text-blue-400" />
        <Satellite size={16} className="text-blue-400" />
      </div>
      <div className="flex items-center gap-2 pl-4 border-l border-white/5">
        <button onClick={() => onUserClick(member)} className="p-1 text-gray-600 hover:text-white transition-colors" title="View Profile">
          <Icon size={16} />
        </button>
        <Link href="/shared-app/family-pebbles/setting" passHref>
          <button className="p-1 text-gray-600 hover:text-white transition-colors" title="Personal Settings">
            <Settings size={16} />
          </button>
        </Link>
      </div>
    </div>
  );
};


export default function App() {
  const [activeLayer, setActiveLayer] = useState('sentinel');
  const [user, setUser] = useState(null);
  const [pebblesThinking, setPebblesThinking] = useState(false);
  const [logs, setLogs] = useState([]);
  const [hardwareStatus, setHardwareStatus] = useState({
    faceId: 'ACTIVE',
    voice: 'LISTENING',
    sonar: 'SCANNING',
    satellite: 'LOCKED',
    beacon: 'EMITTING',
    g6: 'ULTRA-WIDE'
  });
  
  const [isProfileModalOpen, setIsProfileModalOpen] = useState(false);
  const [profileModalUrl, setProfileModalUrl] = useState('');


  const mockFamilyMembers = useMemo(() => [
    { id: 1, name: "Parent 01", role: 'Guardian', confidence: 99.8, status: 'Verified' },
    { id: 2, name: "Parent 02", role: 'Guardian', confidence: 99.7, status: 'Verified' },
    { id: 3, name: "Child 01", role: 'Dependent', confidence: 98.2, status: 'Verified' },
    { id: 4, name: "Child 02", role: 'Dependent', confidence: 97.5, status: 'Pending Recalibration' },
    { id: 5, name: "Awaiting User...", role: 'Unassigned', confidence: 0, status: 'Offline' },
    { id: 6, name: "Awaiting User...", role: 'Unassigned', confidence: 0, status: 'Offline' }
  ], []);

  // Auth Initialization
  useEffect(() => {
    if (!auth) return;
    const initAuth = async () => {
      try {
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth Error:", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // Firestore Data Listener
  useEffect(() => {
    if (!user || !db) return;
    
    const auditRef = collection(db, 'artifacts', appId, 'public', 'data', 'mer_events');
    const q = query(auditRef, orderBy('timestamp', 'desc'));
    
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const docs = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data(),
        timestamp: doc.data().timestamp?.toDate ? doc.data().timestamp.toDate() : new Date()
      }));
      setLogs(docs);
    }, (err) => console.error("Firestore Error:", err));

    return () => unsubscribe();
  }, [user, db]);

  // Hardware Simulation Loop
  useEffect(() => {
    const interval = setInterval(() => {
      setHardwareStatus(prev => ({
        ...prev,
        sonar: Math.random() > 0.5 ? 'SCANNING' : 'OBJECT_DETECTED',
        satellite: Math.random() > 0.8 ? 'SEARCHING' : 'LOCKED'
      }));
    }, 4000);
    return () => clearInterval(interval);
  }, []);
  
  const handleUserClick = (member) => {
    if (member.role === 'Unassigned') return;
    const url = member.role === 'Guardian' 
      ? '/shared-app/family-pebbles/user-client-app-blueprints/adults' 
      : '/shared-app/family-pebbles/user-client-app-blueprints/kids';
    setProfileModalUrl(url);
    setIsProfileModalOpen(true);
  };


  const triggerPebbles = () => {
    setPebblesThinking(true);
    setTimeout(() => setPebblesThinking(false), 2400);
  };

  const PlaceholderView = ({ title, icon: Icon, children = null }) => (
    <div className="flex flex-col items-center justify-center h-full p-10 text-center text-white/20">
      {children ? children : (
        <>
          <Icon size={48} className="mb-4"/>
          <h3 className="text-xl font-black uppercase text-white/40">{title}</h3>
          <p className="text-sm">This section is being built.</p>
        </>
      )}
    </div>
  );

  return (
    <div className="flex h-screen w-screen bg-[#020202] text-[#e2e8f0] font-mono selection:bg-blue-500/30 overflow-hidden">
      
      {/* GLOBAL SIDE NAVIGATION */}
      <div className="w-20 border-r border-white/5 flex flex-col items-center py-8 gap-8 bg-black z-40">
        <Link href="/admin/dashboard/pedlle-tts/client-app-blueprints/internal-content" passHref>
            <div className="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center shadow-[0_0_20px_rgba(37,99,235,0.3)] border border-white/10 cursor-pointer">
                <Zap size={24} className="text-white fill-white" />
            </div>
        </Link>
        
        <nav className="flex flex-col gap-4">
          <NavButton active={activeLayer === 'sentinel'} onClick={() => setActiveLayer('sentinel')} icon={<ScanFace size={22}/>} />
          <NavButton active={activeLayer === 'social'} onClick={() => setActiveLayer('social')} icon={<Share2 size={22}/>} />
          <NavButton active={activeLayer === 'pebbles'} onClick={() => setActiveLayer('pebbles')} icon={<Star size={22}/>} />
          <NavButton active={activeLayer === 'admin'} onClick={() => setActiveLayer('admin')} icon={<Terminal size={22}/>} />
        </nav>

        <div className="mt-auto flex flex-col items-center gap-4">
          <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse shadow-[0_0_10px_#22c55e]" />
          <span className="text-[10px] font-black text-white/10 [writing-mode:vertical-rl] tracking-widest uppercase">6G_ACTIVE</span>
        </div>
      </div>

      {/* MAIN ENGINE AREA */}
      <main className="flex-1 flex flex-col min-w-0 overflow-hidden relative">
        
        {/* SHARED HEADER */}
        <header className="h-20 border-b border-white/5 flex items-center justify-between px-10 bg-[#050505] z-30">
          <div className="flex items-center gap-4">
             <Link href="/admin/dashboard/pedlle-tts/client-app-blueprints/internal-content" passHref>
                <div className="cursor-pointer text-white/40 hover:text-white transition-colors">
                    <ArrowLeft size={24} />
                </div>
            </Link>
            <div className="flex flex-col">
                <h1 className="text-xs font-black tracking-[0.3em] uppercase flex items-center gap-3">
                PEBBLES AUDITING <span className="text-white/20">|</span> {activeLayer.toUpperCase()}
                </h1>
                <div className="flex items-center gap-2 mt-1">
                <div className="w-2 h-2 rounded-full bg-blue-500 animate-pulse" />
                <span className="text-[9px] text-blue-400 font-bold uppercase tracking-widest">
                    {user ? `Session: ${user.uid.slice(0, 8)}...` : "Establishing Handshake..."}
                </span>
                </div>
            </div>
          </div>

          <div className="flex items-center gap-4">
             <HardwareBadge icon={<Satellite size={12}/>} status={hardwareStatus.satellite} color="blue" />
             <div onClick={triggerPebbles} className="cursor-pointer group relative ml-4">
                <div className={`w-12 h-12 rounded-full border-2 transition-all flex items-center justify-center ${pebblesThinking ? 'border-blue-500 animate-spin' : 'border-white/10 group-hover:border-white/30'}`}>
                  <Star size={20} className={pebblesThinking ? 'text-blue-500' : 'text-white/40'} />
                </div>
                <div className="absolute -top-1 -right-1 w-4 h-4 bg-blue-600 rounded-full border-2 border-black flex items-center justify-center text-[8px] font-bold">!</div>
             </div>
          </div>
        </header>

        <div className="flex-1 overflow-y-auto relative scrollbar-hide">
          <AnimatePresence mode="wait">
            
            {activeLayer === 'sentinel' && (
              <motion.div 
                key="sentinel" initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: 20 }}
                className="p-10"
              >
                 <div className="bg-[#0c0c0c] border border-white/5 rounded-[40px] p-10 relative overflow-hidden">
                  <div className="absolute top-0 right-0 p-10 opacity-5"><ScanFace size={240} /></div>
                  <h2 className="text-xl font-black uppercase mb-8 flex items-center gap-3">
                    <ShieldCheck className="text-blue-500" /> Biometric Sentinel Grid
                  </h2>
                  <div className="space-y-2">
                    {mockFamilyMembers.map((member) => (
                      <BiometricCard key={member.id} member={member} onUserClick={handleUserClick} />
                    ))}
                  </div>
                </div>
              </motion.div>
            )}

            {activeLayer === 'social' && <motion.div key="social" initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -20 }} className="h-full"><PlaceholderView title="Social Ecosystem" icon={Share2} /></motion.div>}
            
            {activeLayer === 'pebbles' && (
              <motion.div key="pebbles" initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -20 }} className="h-full p-4 md:p-8">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 h-full">
                  <div className="bg-black/30 border border-white/10 rounded-2xl overflow-hidden h-full">
                    <iframe src="/shared-app/family-pebbles" className="w-full h-full border-none" title="Family Pebble"></iframe>
                  </div>
                  <div className="bg-black/30 border border-white/10 rounded-2xl overflow-hidden h-full">
                     <iframe src="/login/registration/admin/dashboard/audit-login/audit-journal/user-family/dashboard/peddle-tts" className="w-full h-full border-none" title="PEDLLE TTS"></iframe>
                  </div>
                </div>
              </motion.div>
            )}

            {activeLayer === 'admin' && (
              <motion.div 
                key="admin" 
                initial={{ opacity: 0, y: 20 }} 
                animate={{ opacity: 1, y: 0 }} 
                exit={{ opacity: 0, y: -20 }}
                className="p-4 md:p-8 space-y-8 h-full"
              >
                  <div className="space-y-8 h-full">
                      <div className="h-1/2 bg-black/30 border border-white/10 rounded-2xl overflow-hidden">
                          <iframe src="/admin/dashboard/ignition-dashboard" className="w-full h-full border-none" title="Ignition Dashboard" />
                      </div>
                      <div className="h-1/2 bg-black/30 border border-white/10 rounded-2xl overflow-hidden">
                          <iframe src="/shared-app/family-anchor-map" className="w-full h-full border-none" title="Family Anchor Map" />
                      </div>
                  </div>
              </motion.div>
            )}

          </AnimatePresence>
        </div>

        <footer className="h-12 border-t border-white/5 bg-black px-10 flex items-center justify-between z-30">
          <div className="flex gap-8">
            <span className="text-[9px] font-black text-white/30 uppercase tracking-[0.2em] flex items-center gap-2">
              <Globe size={12} /> GLOBAL_AUDIT: <span className="text-blue-500">ENFORCED</span>
            </span>
            <span className="text-[9px] font-black text-white/30 uppercase tracking-[0.2em] flex items-center gap-2">
              <Database size={12} /> SOUL_CLOUD: <span className="text-purple-500">SYNCING</span>
            </span>
          </div>
          <div className="text-[9px] font-black text-white/10 uppercase tracking-widest">
            Sovereign_Habitat_OS // (c) 2024 Audit Engine
          </div>
        </footer>
      </main>

      <AnimatePresence>
        {pebblesThinking && (
          <motion.div 
            initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}
            className="fixed inset-0 z-[100] pointer-events-none flex flex-col items-center justify-center bg-blue-900/5 backdrop-blur-[2px]"
          >
            <div className="w-32 h-32 rounded-full border-4 border-blue-500/20 border-t-blue-500 animate-spin flex items-center justify-center">
               <Star size={40} className="text-blue-500 animate-pulse" />
            </div>
            <div className="mt-8 text-[12px] font-black uppercase text-blue-400 tracking-[1em] animate-pulse">Pebbles_is_Auditing</div>
          </motion.div>
        )}
      </AnimatePresence>

      <Dialog open={isProfileModalOpen} onOpenChange={setIsProfileModalOpen}>
        <DialogContent className="max-w-4xl h-[90vh] flex flex-col p-0 gap-0 dark:bg-zinc-950 border-blue-500/30">
          <DialogHeader className="p-4 border-b dark:border-zinc-800 flex-row items-center justify-between">
              <DialogTitle className="text-white">User Profile</DialogTitle>
              <DialogDescription className="text-zinc-500">{profileModalUrl}</DialogDescription>
              <button onClick={() => setIsProfileModalOpen(false)} className="p-1 rounded-full text-zinc-500 hover:text-white hover:bg-zinc-800">
                <X size={16} />
              </button>
          </DialogHeader>
          <div className="flex-1 overflow-y-auto">
              <iframe src={profileModalUrl} className="w-full h-full border-none"/>
          </div>
        </DialogContent>
      </Dialog>


      <style dangerouslySetInnerHTML={{ __html: `
        .scrollbar-hide::-webkit-scrollbar { display: none; }
      `}} />
    </div>
  );
}

// --- Sub-Components ---

function NavButton({ active, onClick, icon }) {
  return (
    <button onClick={onClick} className={`p-4 rounded-2xl transition-all ${active ? 'text-blue-400 bg-white/5 border border-white/10 shadow-[0_0_15px_rgba(255,255,255,0.05)]' : 'text-white/20 hover:text-white'}`}>
      {icon}
    </button>
  );
}

function HardwareBadge({ icon, status, color }) {
  const themes = {
    blue: 'text-blue-400 bg-blue-500/10 border-blue-500/20',
    purple: 'text-purple-400 bg-purple-500/10 border-purple-500/20',
    green: 'text-green-400 bg-green-500/10 border-green-500/20'
  };
  return (
    <div className={`px-4 py-2 rounded-xl border flex items-center gap-3 ${themes[color]}`}>
      {icon}
      <span className="text-[9px] font-black uppercase tracking-tighter">{status}</span>
    </div>
  );
}
