'use client';

import React, { useState, useEffect, useRef, useMemo } from 'react';
import { 
  Shield, Zap, X, Search, User, Plus, Heart, 
  Calendar as CalendarIcon, Edit3, 
  Phone, MessageSquare, LayoutGrid, CloudSun, MapPin, 
  Users, AppWindow, Mic, Send, Activity, BrainCircuit,
  Terminal, Sparkles, Globe, ToyBrick, Music, Home, School, HelpCircle, Wallet, Star, Anchor, Map, FileText, Sheet, Calculator, Camera, Video, Clock, Banknote, Power, VideoIcon, Disc, FolderKanban, Radio, Palette,
  ArrowLeft, RotateCw, Briefcase, PiggyBank, Cpu
} from 'lucide-react';
import { simpleSpeak } from '@/ai/flows/tts-flow';
import Link from 'next/link';
import { motion, AnimatePresence } from 'framer-motion';

// --- APP DATA (Extracted from blueprints page) ---
const allApps = [
    { href: '/kids/kids-app/socialpost-view', icon: ToyBrick, title: 'Social App', description: 'The isolated social zone for kids.', category: 'kids' },
    { href: '/kids/kids-app/kids-video-music', icon: Music, title: 'Kids\' Music & Video', description: 'Filtered long-form video and music.', category: 'kids' },
    { href: '/kids-app/kids-hub', icon: Home, title: 'Kids Hub', description: 'The main dashboard for kids.', category: 'kids' },
    { href: '/kids-app/my-school', icon: School, title: 'My School', description: 'Tools for homework and learning.', category: 'kids' },
    { href: '/kids-app/my-kids-pebble', icon: BrainCircuit, title: 'My Kids Pebble', description: 'The core AI node for kids.', category: 'kids' },
    { href: '/kids-app/kids-message', icon: MessageSquare, title: 'Kids Message', description: 'Send messages to family members.', category: 'kids' },
    { href: '/kids-app/kids-homework-helper', icon: HelpCircle, title: 'Kids Homework Helper', description: 'AI-powered help for school work.', category: 'kids' },
    { href: '/kids-app/kids-my-chat', icon: MessageSquare, title: 'Kids My Chat', description: 'A private chat for kids.', category: 'kids' },
    { href: '/kids-app/kids-contact', icon: User, title: 'Kids Contact', description: 'A list of approved contacts.', category: 'kids' },
    { href: '/kids-app/my-personal-bank', icon: Wallet, title: 'My Personal Bank', description: 'View your personal bank account.', category: 'kids' },
    { href: '/kids-app/my-spikes-point-store', icon: Star, title: 'My Spikes Point Store', description: 'Redeem your Spike Points for rewards.', category: 'kids' },
    { href: '/shared-app/family-pebbles', icon: BrainCircuit, title: 'Family Pebble', description: 'Core AI node for shared knowledge.', category: 'shared' },
    { href: '/shared-app/family-anchor-map', icon: Anchor, title: 'Family Anchor Map', description: 'Live map of all connected family devices.', category: 'shared' },
    { href: '/shared-app/travinling-planing', icon: Map, title: 'Traveling Planning', description: 'Plan your family trips and adventures.', category: 'shared' },
    { href: '/shared-app/word-processor', icon: FileText, title: 'Word Processor', description: 'Shared document editor for the family.', category: 'shared' },
    { href: '/shared-app/spreadsheet', icon: Sheet, title: 'Spreadsheet', description: 'Family budgets, lists, and more.', category: 'shared' },
    { href: '/shared-app/calculator', icon: Calculator, title: 'Calculator', description: 'Quick maths for the family.', category: 'shared' },
    { href: '/shared-app/social-posting', icon: MessageSquare, title: 'Social Posting', description: 'Create and share posts with your family.', category: 'shared' },
    { href: '/shared-app/ar-camera', icon: Camera, title: 'AR Camera', description: 'Augmented reality filters and effects.', category: 'shared' },
    { href: '/shared-app/video-posting', icon: Video, title: 'Video Posting', description: 'Share video moments with your family.', category: 'shared' },
    { href: '/shared-app/Shared-Calendar', icon: CalendarIcon, title: 'Shared Calendar', description: 'Central family scheduling app.', category: 'shared' },
    { href: '/Family-Shared/clock-setting', icon: Clock, title: 'Clock', description: 'Holographic clock customization.', category: 'shared' },
    { href: '/family-shared/spike-store', icon: Banknote, title: 'Spike Store', description: 'Spike Points reward system.', category: 'shared' },
    { href: '/family-shared/family-banking', icon: Power, title: 'Family Banking', description: 'Shared family financial tools.', category: 'shared' },
    { href: '/family-shared/live-video-recording', icon: VideoIcon, title: 'Live Video Recording', description: 'Record and share live video.', category: 'shared' },
    { href: '/family-shared/my-tuner', icon: Disc, title: 'MyTuner', description: 'Tune in to family broadcasts.', category: 'shared' },
    { href: '/family-shared/phone-pad', icon: Phone, title: 'Phone Pad', description: 'Isolated phone pad for secure calls.', category: 'shared' },
    { href: '/family-shared/family-chat', icon: MessageSquare, title: 'Family Chat', description: 'Secure messaging for the whole family.', category: 'shared' },
    { href: '/family-shared/media-vault', icon: FolderKanban, title: 'Media Vault', description: 'Shared photos, videos, and docs.', category: 'shared' },
    { href: '/shared-app/video-creator', icon: Video, title: 'Video Studio', description: 'Create and edit family videos.', category: 'shared' },
    { href: '/shared-app/audio-studio', icon: Music, title: 'Audio Studio', description: 'Record podcasts and music.', category: 'shared' },
    { href: '/shared-app/live-studio', icon: Radio, title: 'Live Studio', description: 'DJ booth and live radio.' },
    { href: '/shared-app/art-studio', icon: Palette, title: 'Art Studio', description: 'Digital painting and drawing tools.' }
];

const App = () => {
  // --- UI & Navigation State ---
  const [isOsMode, setIsOsMode] = useState(false);
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const [activeStage, setActiveStage] = useState(1);
  const [activeBrowserUrl, setActiveBrowserUrl] = useState(null);
  const [isReloading, setIsReloading] = useState(false);
  const [isCameraModalOpen, setIsCameraModalOpen] = useState(false);
  const [isMapModalOpen, setIsMapModalOpen] = useState(false);
  const [isPhoneModalOpen, setIsPhoneModalOpen] = useState(false);
  const [isMessageModalOpen, setIsMessageModalOpen] = useState(false);
  const [isContactsModalOpen, setIsContactsModalOpen] = useState(false);
  const [isInstallHubOpen, setIsInstallHubOpen] = useState(false);
  const [isClockModalOpen, setIsClockModalOpen] = useState(false);
  const [isCalendarModalOpen, setIsCalendarModalOpen] = useState(false);
  const [isNotesModalOpen, setIsNotesModalOpen] = useState(false);
  const [isQuickActionModalOpen, setIsQuickActionModalOpen] = useState(false);
  const [quickActionUrl, setQuickActionUrl] = useState('');
  const [isHealthModalOpen, setIsHealthModalOpen] = useState(false);
  const [isPedlleTtsModalOpen, setIsPedlleTtsModalOpen] = useState(false);


  // --- Neural / AI State ---
  const [mood, setMood] = useState('neutral');
  const [input, setInput] = useState('');
  const [chatBubble, setChatBubble] = useState('How can I help you today?');
  const [history, setHistory] = useState([]);
  const [isListening, setIsListening] = useState(false);
  const [isProcessing, setIsProcessing] = useState(false);
  const audioRef = useRef<HTMLAudioElement | null>(null);

  // --- Mascot & Refs ---
  const [mascotPosition, setMascotPosition] = useState(null);
  const [mousePos, setMousePos] = useState({ x: 0, y: 0 });
  const pressTimer = useRef(null);
  const dragItem = useRef();
  const recognitionRef = useRef(null);
  const historyRef = useRef([]);

  useEffect(() => {
    setMascotPosition({ x: window.innerWidth - 120, y: window.innerHeight - 250 });
  }, []);

  // --- Voice Systems Initialization ---
  useEffect(() => {
    if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) return;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      setInput(transcript);
      handleNeuralQuery(transcript);
    };
    recognition.onend = () => setIsListening(false);
    recognitionRef.current = recognition;
  }, []);

  const toggleVoice = () => {
    if (isListening) {
      recognitionRef.current?.stop();
    } else {
      setIsListening(true);
      setMood('listening');
      recognitionRef.current?.start();
    }
  };

  const speak = async (text) => {
    setMood('speaking');
    try {
        const { media } = await simpleSpeak(text, { voice: 'Puck' });
        if (media && audioRef.current) {
            audioRef.current.src = media;
            audioRef.current.play();
            audioRef.current.onended = () => {
              setMood('neutral');
            };
        } else {
           setMood('neutral');
        }
    } catch (error) {
        console.error("TTS Error:", error);
        setMood('alert');
        setChatBubble("Oops, I got a little glitch!");
    }
  };

  // --- Neural Engine (The "Super Smart" Search) ---
  const handleNeuralQuery = async (queryOverride = null) => {
    const query = queryOverride || input;
    if (!query.trim() || isProcessing) return;

    setIsProcessing(true);
    setMood('thinking');
    setChatBubble('Thinking of a fun answer...');
    setInput('');

    try {
      const aiText = `This is a simulated response to: "${query}". I'm a kid-friendly AI!`;
      const newHistory = [...historyRef.current, { role: 'user', text: query }, { role: 'assistant', text: aiText }];
      historyRef.current = newHistory;
      setHistory(newHistory);
      setChatBubble(aiText);
      await speak(aiText);

      if (query.toLowerCase().includes("search for")) {
        setActiveBrowserUrl(`https://www.bing.com/search?q=${encodeURIComponent(query.replace("search for", ""))}&adlt=strict`);
      }
    } catch (err) {
      setChatBubble("System error: AI core destabilized.");
      setMood('alert');
    } finally {
      setIsProcessing(false);
    }
  };

  // --- UI Interactivity ---
  const handlePointerDown = (e) => {
    pressTimer.current = setTimeout(() => {
      const newOsMode = !isOsMode;
      setIsOsMode(newOsMode);
      if (newOsMode) setIsMenuOpen(true);
      setChatBubble(newOsMode ? "Adventure Mode Engaged!" : "Switching to Phone Mode.");
      pressTimer.current = null;
    }, 1200);

    const clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
    const clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : 0);
    dragItem.current = { startX: clientX, startY: clientY, initialX: mascotPosition.x, initialY: mascotPosition.y };
  };

  const handlePointerUp = () => {
    if (pressTimer.current) {
      clearTimeout(pressTimer.current);
      pressTimer.current = null;
      const newMenuState = !isMenuOpen;
      setIsMenuOpen(newMenuState);
      if (!newMenuState) {
        setActiveBrowserUrl(null);
      }
    }
    dragItem.current = null;
  };

  const eyeTransform = useMemo(() => {
    if (!mascotPosition) return {};
    const dx = mousePos.x - mascotPosition.x;
    const dy = mousePos.y - mascotPosition.y;
    const angle = Math.atan2(dy, dx);
    const dist = Math.min(4, Math.sqrt(dx*dx + dy*dy) / 100);
    return { transform: `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)` };
  }, [mousePos, mascotPosition]);
  
  
  const handleReload = () => {
    setIsReloading(true);
    const iframes = [
      "camera-iframe", "map-iframe", "install-hub-iframe", "clock-iframe", 
      "calendar-iframe", "notes-iframe", "quick-action-iframe", "health-iframe", "pedlle-tts-iframe"
    ];
    let reloaded = false;
    for (const id of iframes) {
      const iframe = document.getElementById(id) as HTMLIFrameElement;
      if (iframe) {
          iframe.src = iframe.src;
          reloaded = true;
          break;
      }
    }
    setTimeout(() => setIsReloading(false), 1000);
  };
  
  const closeAllModals = () => {
    setIsCameraModalOpen(false);
    setIsMapModalOpen(false);
    setIsInstallHubOpen(false);
    setIsClockModalOpen(false);
    setIsCalendarModalOpen(false);
    setIsNotesModalOpen(false);
    setIsQuickActionModalOpen(false);
    setIsHealthModalOpen(false);
    setIsPedlleTtsModalOpen(false);
  };

  const anyAppModalOpen = isCameraModalOpen || isMapModalOpen || isInstallHubOpen || isClockModalOpen || isCalendarModalOpen || isNotesModalOpen || isQuickActionModalOpen || isHealthModalOpen || isPedlleTtsModalOpen;
  
  const openQuickAction = (url: string) => {
    setQuickActionUrl(url);
    setIsQuickActionModalOpen(true);
  }

  return (
    <div 
      className={`fixed inset-0 transition-all duration-1000 overflow-hidden font-sans select-none
        ${isOsMode ? 'bg-[#050510]' : 'bg-transparent'}`} 
      onMouseMove={(e) => {
        setMousePos({ x: e.clientX, y: e.clientY });
        if (!dragItem.current || !mascotPosition) return;
        setMascotPosition({
          x: dragItem.current.initialX + (e.clientX - dragItem.current.startX),
          y: dragItem.current.initialY + (e.clientY - dragItem.current.startY)
        });
      }}
    >
      <audio ref={audioRef} />
      {/* BACKGROUND - OS Mode Only */}
      {isOsMode && (
        <div className="absolute inset-0 z-0 pointer-events-none">
          <div className="absolute inset-0 bg-gradient-to-br from-indigo-950/40 via-black to-purple-950/40 animate-pulse" />
          <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] rounded-full blur-[120px] opacity-10 bg-indigo-500 animate-slow-spin" />
        </div>
      )}

      {/* STATUS BAR */}
      {(isOsMode || isMenuOpen) && (
        <div className="absolute top-0 left-0 right-0 p-8 flex justify-between items-center z-[60] animate-in slide-in-from-top-full duration-500">
          <div className="flex gap-4">
            <div className="px-4 py-2 bg-white/5 backdrop-blur-md rounded-full border border-white/10 flex items-center gap-2 text-green-400 text-[10px] font-black uppercase tracking-widest">
              <Activity size={14} className="animate-pulse" /> 6G Connected
            </div>
          </div>
          <div className="flex gap-2 items-center">
            <span className="text-[10px] font-mono opacity-40 uppercase tracking-widest hidden sm:inline">Neural Link: {mood}</span>
            <div className={`${isOsMode ? 'text-white/40' : 'text-slate-900/40'} font-mono text-xs`}>
              {new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
            </div>
             <button onClick={() => setIsHealthModalOpen(true)} className="w-10 h-10 rounded-full bg-white/5 backdrop-blur-md border border-white/10 flex items-center justify-center cursor-pointer hover:border-pink-400 transition-colors" title="My Health">
                <Heart size={18} className="text-white/70" />
            </button>
            <button onClick={() => setIsPedlleTtsModalOpen(true)} className="w-10 h-10 rounded-full bg-white/5 backdrop-blur-md border border-white/10 flex items-center justify-center cursor-pointer hover:border-cyan-400 transition-colors" title="Go to PEDLLE TTS Engine">
              <Cpu size={18} className="text-white/70" />
            </button>
            <Link href="/shared-app/family-pebbles/user-client-app-blueprints/kids">
              <span className="w-10 h-10 rounded-full bg-white/5 backdrop-blur-md border border-white/10 flex items-center justify-center cursor-pointer hover:border-blue-400 transition-colors" title="Go to Profile Settings">
                  <User size={18} className="text-white/70" />
              </span>
            </Link>
          </div>
        </div>
      )}

      {/* MAIN INTERFACE */}
      {isMenuOpen && (activeStage !== null) && (
        <>
          {/* SIDE DOCK */}
          <div className="absolute left-8 top-1/2 -translate-y-1/2 flex flex-col gap-6 z-50 animate-in slide-in-from-left-full duration-700">
            {['Mom', 'Dad'].map((name, i) => (
              <div key={name}  onClick={() => setIsMessageModalOpen(true)} className={`w-12 h-12 rounded-full border-2 border-white/20 flex items-center justify-center shadow-xl transition-all hover:scale-110 cursor-pointer ${i === 0 ? 'bg-blue-600' : 'bg-pink-600'}`}>
                <User size={20} className="text-white" />
              </div>
            ))}
            <div 
              onClick={() => setIsContactsModalOpen(true)}
              className="w-12 h-12 rounded-full border-2 border-dashed border-white/20 flex items-center justify-center shadow-xl transition-all hover:scale-110 hover:border-white/50 cursor-pointer bg-white/10">
              <Plus size={20} className="text-white/70" />
            </div>
          </div>

          {/* PAGE CONTENT CONTAINER */}
          <div className="absolute inset-0 flex flex-col items-center justify-center px-6 z-40 pointer-events-none">
            <div className="w-full max-w-5xl pointer-events-auto flex flex-col items-center gap-12">
              
              {/* STAGE SELECTOR */}
              <div className="flex justify-center gap-4">
                {[0, 1, 2].map(i => (
                  <button 
                    key={i}
                    onClick={() => setActiveStage(i)}
                    className={`h-2 rounded-full transition-all duration-500 ${activeStage === i ? 'bg-indigo-500 w-12' : 'bg-white/20 w-2'}`}
                  />
                ))}
              </div>

              {/* STAGE CONTENT RENDERING */}
              <div className="w-full min-h-[500px] flex items-center justify-center transition-all duration-500">
                {activeStage === 0 && <StagePersonal 
                    mode={isOsMode} 
                    onClockClick={() => setIsClockModalOpen(true)}
                    onCalendarClick={() => setIsCalendarModalOpen(true)}
                    onNotesClick={() => setIsNotesModalOpen(true)}
                    onQuickAction={openQuickAction}
                  />}
                {activeStage === 1 && (
                   <StageSearch 
                    input={input} 
                    setInput={setInput} 
                    handleSearch={(e) => { e.preventDefault(); handleNeuralQuery(); }} 
                    mode={isOsMode} 
                    isListening={isListening}
                    toggleVoice={toggleVoice}
                    isProcessing={isProcessing}
                    chatBubble={chatBubble}
                    history={history}
                    onPhoneClick={() => setIsPhoneModalOpen(true)}
                    onMessageClick={() => setIsMessageModalOpen(true)}
                    onCameraClick={() => setIsCameraModalOpen(true)}
                    onMapClick={() => setIsMapModalOpen(true)}
                  />
                )}
                {activeStage === 2 && <StageInstall mode={isOsMode} onInstallClick={() => setIsInstallHubOpen(true)} />}
              </div>
            </div>
          </div>
        </>
      )}

      {/* FLOATING MASCOT */}
       {mascotPosition && (
        <div 
          className="fixed z-[100] transition-transform duration-300"
          style={{ left: mascotPosition.x, top: mascotPosition.y }}
          onMouseDown={handlePointerDown}
          onTouchStart={handlePointerDown}
          onMouseUp={handlePointerUp}
          onTouchEnd={handlePointerUp}
        >
          <div className={`w-20 h-20 backdrop-blur-3xl border-2 flex flex-col items-center justify-center cursor-pointer transition-all duration-700
            ${isOsMode ? 'bg-white/10 border-white/20 scale-110 shadow-2xl' : 'bg-black/90 border-white/10 scale-90'}
            rounded-[40%_60%_70%_30%/45%_45%_55%_55%] hover:scale-105 active:scale-90`}
          >
            <div className="flex gap-3">
               <div className="w-2 h-4 bg-black rounded-full overflow-hidden border border-white/5"><div className={`w-1 h-2 rounded-full blur-[1px] mt-1 ml-0.5 transition-colors ${isOsMode ? 'bg-cyan-400' : 'bg-slate-400'}`} style={eyeTransform} /></div>
               <div className="w-2 h-4 bg-black rounded-full overflow-hidden border border-white/5"><div className={`w-1 h-2 rounded-full blur-[1px] mt-1 ml-0.5 transition-colors ${isOsMode ? 'bg-cyan-400' : 'bg-slate-400'}`} style={eyeTransform} /></div>
            </div>
            {(mood === 'speaking' || mood === 'listening') && (
              <div className="flex gap-0.5 absolute bottom-4">
                 {[...Array(4)].map((_, i) => (
                   <div key={i} className="w-1 h-2 bg-cyan-400 rounded-full animate-bounce" style={{ animationDelay: `${i*0.1}s` }} />
                 ))}
              </div>
            )}
          </div>
          {!isMenuOpen && (<div className={`absolute bottom-full left-1/2 -translate-x-1/2 mb-6 w-48 p-4 rounded-3xl rounded-bl-none shadow-2xl text-[10px] font-black transition-all duration-500 border-2 ${isOsMode ? 'bg-white text-slate-900 border-white' : 'bg-black/95 text-white border-white/10'}`}>{chatBubble.length > 50 ? chatBubble.substring(0, 50) + "..." : chatBubble}<div className="absolute -bottom-2 left-0 w-4 h-4 bg-inherit border-b-2 border-l-2 border-inherit transform rotate-45" /></div>)}
        </div>
      )}

      {/* BROWSER PORTAL */}
      {activeBrowserUrl && isMenuOpen && (<div className="absolute inset-10 z-[200] bg-white rounded-[3rem] shadow-2xl overflow-hidden flex flex-col animate-in zoom-in-95 duration-500"><div className="p-4 bg-slate-50 border-b flex justify-between items-center"><div className="flex items-center gap-2 text-green-600 font-bold uppercase text-xs tracking-widest"><Shield size={16} /> Secure Portal</div><button onClick={() => setActiveBrowserUrl(null)} className="p-2 hover:bg-red-50 text-red-500 rounded-full transition-colors"><X size={24} /></button></div><iframe src={activeBrowserUrl} className="flex-1 w-full border-none" title="Safe Search" /></div>)}
      
      {/* FRAMELESS IFRAME MODAL FOR PHONE/MESSAGES/CONTACTS */}
      <AnimatePresence>
        {(isPhoneModalOpen || isMessageModalOpen || isContactsModalOpen) && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-0 md:p-6" >
            <motion.div 
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={() => {
                setIsPhoneModalOpen(false);
                setIsMessageModalOpen(false);
                setIsContactsModalOpen(false);
              }}
              className="absolute inset-0 bg-black/70 backdrop-blur-xl cursor-pointer"
            />
            <motion.div 
              initial={{ opacity: 0, scale: 0.9, y: 20 }}
              animate={{ opacity: 1, scale: 1, y: 0 }}
              exit={{ opacity: 0, scale: 0.95, y: 10 }}
              transition={{ type: "spring", damping: 25, stiffness: 350 }}
              className="relative w-full max-w-[400px] h-full md:h-[850px] bg-transparent border-none overflow-hidden"
              onClick={(e) => e.stopPropagation()}
            >
              <iframe 
                src={
                  isPhoneModalOpen ? "/family-shared/phone-pad" :
                  isMessageModalOpen ? "/kids-app/kids-message" :
                  "/kids-app/kids-contact"
                }
                className="w-full h-full border-none"
                title={
                  isPhoneModalOpen ? "Sovereign Phone Pad" :
                  isMessageModalOpen ? "Sovereign Kids Messenger" :
                  "Sovereign Kids Contacts"
                }
              />
              <button 
                  onClick={() => {
                    setIsPhoneModalOpen(false);
                    setIsMessageModalOpen(false);
                    setIsContactsModalOpen(false);
                  }}
                  className="absolute top-6 right-6 p-2 rounded-full bg-white/5 hover:bg-white/10 text-white/40 hover:text-white transition-colors"
                >
                  <X size={24} />
              </button>
            </motion.div>
          </div>
        )}
      </AnimatePresence>

      <AnimatePresence>
        {anyAppModalOpen && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-6">
            <motion.div 
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              onClick={closeAllModals}
              className="absolute inset-0 bg-black/70 backdrop-blur-2xl cursor-default"
            />
            <motion.div 
              initial={{ opacity: 0, scale: 0.95, y: 30 }}
              animate={{ opacity: 1, scale: 1, y: 0 }}
              exit={{ opacity: 0, scale: 0.95, y: 20 }}
              transition={{ type: "spring", damping: 25, stiffness: 350 }}
              className="relative w-full max-w-6xl h-[90vh] bg-[#0c0c0c] border border-white/10 rounded-[2.5rem] shadow-[0_30px_100px_rgba(0,0,0,0.8)] overflow-hidden flex flex-col"
            >
               <div className="flex items-center justify-between px-6 pt-6">
                <div className="flex items-center gap-2">
                  <button 
                    onClick={closeAllModals}
                    className="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-white/60 hover:text-white transition-all active:scale-90"
                    title="Back"
                  >
                    <ArrowLeft size={16} />
                  </button>
                  <button 
                    onClick={handleReload}
                    className="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-white/60 hover:text-white transition-all active:scale-90"
                    title="Reload"
                  >
                    <RotateCw size={16} className={isReloading ? "animate-spin text-blue-400" : ""} />
                  </button>
                </div>

                <div className="px-4 py-1.5 bg-white/5 border border-white/10 rounded-full text-[10px] font-mono text-slate-400">
                  {isCameraModalOpen && "/shared-app/live-video-recording"}
                  {isMapModalOpen && "/shared-app/family-anchor-map"}
                  {isInstallHubOpen && "/admin/dashboard/pedlle-tts/client-app-blueprints"}
                  {isClockModalOpen && "/Family-Shared/clock-setting"}
                  {isCalendarModalOpen && "/shared-app/Shared-Calendar"}
                  {isNotesModalOpen && "/admin/dashboard/pedlle-tts/family-crm"}
                  {isHealthModalOpen && "/kids-app/my-health"}
                  {isPedlleTtsModalOpen && "/admin/dashboard/pedlle-tts"}
                  {isQuickActionModalOpen && quickActionUrl}
                </div>

                <button 
                  onClick={closeAllModals}
                  className="p-2 rounded-xl bg-white/5 hover:bg-white/10 text-white/40 hover:text-white transition-colors"
                >
                  <X size={16} />
                </button>
              </div>
              <div className="mt-4 h-[1px] w-full bg-gradient-to-r from-transparent via-white/10 to-transparent" />
              <div className="flex-1 mt-4 rounded-b-[2.5rem] overflow-hidden">
                <iframe
                    id={
                        isCameraModalOpen ? "camera-iframe" :
                        isMapModalOpen ? "map-iframe" :
                        isInstallHubOpen ? "install-hub-iframe" :
                        isClockModalOpen ? "clock-iframe" :
                        isCalendarModalOpen ? "calendar-iframe" :
                        isNotesModalOpen ? "notes-iframe" :
                        isHealthModalOpen ? "health-iframe" :
                        isPedlleTtsModalOpen ? "pedlle-tts-iframe" :
                        "quick-action-iframe"
                    }
                    src={
                        isCameraModalOpen ? "/shared-app/live-video-recording" : 
                        isMapModalOpen ? "/shared-app/family-anchor-map" :
                        isInstallHubOpen ? "/admin/dashboard/pedlle-tts/client-app-blueprints" :
                        isClockModalOpen ? "/Family-Shared/clock-setting" :
                        isCalendarModalOpen ? "/shared-app/Shared-Calendar" :
                        isNotesModalOpen ? "/admin/dashboard/pedlle-tts/family-crm" :
                        isHealthModalOpen ? "/kids-app/my-health" :
                        isPedlleTtsModalOpen ? "/admin/dashboard/pedlle-tts" :
                        quickActionUrl
                    }
                    className="w-full h-full border-none"
                    title="OS Modal"
                />
              </div>
            </motion.div>
          </div>
        )}
      </AnimatePresence>

      <style dangerouslySetInnerHTML={{ __html: `
        @keyframes slow-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-slow-spin { animation: slow-spin 30s linear infinite; }
      `}} />
    </div>
  );
};

// --- STAGE 0: PERSONAL PORTFOLIO ---
const StagePersonal = ({ mode, onClockClick, onCalendarClick, onNotesClick, onQuickAction }) => {
  const [time, setTime] = useState(new Date());
  useEffect(() => { const timer = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(timer); }, []);
  const days = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
  const date = time.getDate();
  const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
  
  const quickActions = [
      { label: "Personal Bank", icon: PiggyBank, url: '/kids-app/my-personal-bank'},
      { label: "Homework Helper", icon: HelpCircle, url: '/kids-app/kids-homework-helper'},
      { label: "Spike Store", icon: Star, url: '/kids-app/my-spikes-point-store'},
      { label: "My School", icon: School, url: '/kids-app/my-school'},
  ];

  return (
    <div className="w-full max-w-4xl space-y-6 animate-in fade-in zoom-in-95 duration-700">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div 
          onClick={onClockClick}
          className={`col-span-1 p-8 rounded-[3rem] border flex flex-col items-center justify-center transition-all cursor-pointer ${mode ? 'bg-white/5 border-white/10 text-white' : 'bg-white border-slate-200 shadow-xl text-slate-800'}`}
        >
          <h1 className="text-5xl font-black tracking-tighter">
            {time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
          </h1>
          <p className="text-xs font-bold uppercase tracking-widest opacity-40 mt-1">{time.toLocaleDateString([], { month: 'long', day: 'numeric', year: 'numeric' })}</p>
        </div>
        <div className={`col-span-1 p-8 rounded-[3rem] border flex flex-col justify-center transition-all ${mode ? 'bg-white/5 border-white/10 text-white' : 'bg-white border-slate-200 shadow-xl text-slate-800'}`}>
           <div className="flex items-center gap-2 text-indigo-500">
             <CloudSun size={32} />
             <span className="text-3xl font-black">72Â°</span>
           </div>
           <div className="flex items-center gap-1 opacity-40 text-[10px] font-bold uppercase tracking-widest mt-1">
             <MapPin size={10} /> PALO ALTO, CA
           </div>
        </div>
        <div className={`p-6 rounded-[3rem] border flex flex-col justify-center transition-all space-y-2 ${mode ? 'bg-white/5 border-white/10 text-white' : 'bg-white border-slate-200 shadow-xl text-slate-800'}`}>
           <span className="text-[10px] font-black uppercase tracking-widest opacity-40 mb-2 text-indigo-500">Quick Actions</span>
            {quickActions.map(action => (
                <button key={action.label} onClick={() => onQuickAction(action.url)} className="flex items-center gap-3 w-full p-3 rounded-2xl bg-indigo-500/10 text-indigo-300 font-black uppercase text-xs tracking-widest hover:bg-indigo-500/20 hover:text-white transition-all">
                    <action.icon size={18} /> {action.label}
                </button>
            ))}
        </div>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div onClick={onCalendarClick} className={`p-8 rounded-[3rem] border transition-all cursor-pointer ${mode ? 'bg-white/5 border-white/10 text-white' : 'bg-white border-slate-200 shadow-xl text-slate-800'}`}>
          <div className="flex items-center justify-between mb-6">
            <div className="flex items-center gap-3">
              <CalendarIcon size={24} className="text-indigo-500" />
              <h2 className="font-black text-xl uppercase tracking-tighter">My Month</h2>
            </div>
            <span className="text-[10px] font-black opacity-40 uppercase tracking-widest">{monthNames[time.getMonth()]}</span>
          </div>
          <div className="grid grid-cols-7 gap-2">
            {days.map((d, i) => <div key={`${d}-${i}`} className="text-center text-[10px] font-black opacity-30">{d}</div>)}
            {Array.from({ length: 31 }).map((_, i) => (<div key={i} className={`aspect-square flex items-center justify-center rounded-xl text-xs font-bold transition-all ${i + 1 === date ? 'bg-indigo-500 text-white scale-110 shadow-lg' : 'hover:bg-indigo-500/10'} ${i + 1 > 28 ? 'opacity-20' : ''}`}>{i + 1}</div>))}
          </div>
        </div>
        <div onClick={onNotesClick} className={`p-8 rounded-[3rem] border transition-all cursor-pointer ${mode ? 'bg-white/5 border-white/10 text-white' : 'bg-white border-slate-200 shadow-xl text-slate-800'}`}>
          <div className="flex items-center gap-3 mb-6">
            <Edit3 size={24} className="text-pink-500" />
            <h2 className="font-black text-xl uppercase tracking-tighter">My Notes</h2>
          </div>
          <textarea placeholder="What are we doing today?" className="w-full h-32 bg-transparent border-2 border-dashed border-indigo-500/10 rounded-2xl p-4 text-xs font-bold focus:outline-none focus:border-indigo-500/30 transition-all resize-none pointer-events-none" readOnly />
        </div>
      </div>
    </div>
  );
};


// --- STAGE 1: SEARCH & NEURAL HUB ---
const StageSearch = ({ input, setInput, handleSearch, mode, isListening, toggleVoice, isProcessing, chatBubble, history, onPhoneClick, onMessageClick, onCameraClick, onMapClick }) => {
  const comms = [
    { id: 'phone', icon: <Phone size={28} />, label: "Phone", action: onPhoneClick },
    { id: 'message', icon: <MessageSquare size={28} />, label: "Message", action: onMessageClick },
    { id: 'camera', icon: <Camera size={28} />, label: "Camera", action: onCameraClick },
    { id: 'map', icon: <Map size={28} />, label: "Map", action: onMapClick }
  ];

  return (
    <div className="w-full flex flex-col items-center gap-12 animate-in fade-in slide-in-from-bottom-12 duration-700">
      
      <div className="w-full max-w-2xl text-center mb-4">
         <div className={`inline-block px-10 py-6 rounded-[2.5rem] border backdrop-blur-3xl shadow-2xl transition-all ${mode ? 'bg-white/5 border-white/10 text-indigo-100/90' : 'bg-white border-slate-100 text-slate-800'}`}>
            <p className="text-xl font-light leading-relaxed">{chatBubble}</p>
         </div>
      </div>

      <div className="w-full max-w-2xl relative">
          <form onSubmit={handleSearch} className="relative group">
            <div className="absolute -inset-0.5 bg-gradient-to-r from-cyan-500/20 to-indigo-600/20 rounded-3xl blur opacity-0 group-hover:opacity-100 transition duration-500" />
            <div className="relative flex items-center bg-white/[0.03] backdrop-blur-2xl border border-white/10 rounded-3xl p-2 pl-6">
              <input 
                type="text"
                value={input}
                onChange={(e) => setInput(e.target.value)}
                placeholder={isListening ? "Listening..." : "Ask me anything..."}
                className="flex-1 bg-transparent py-4 text-sm focus:outline-none placeholder:text-white/20"
              />
              <button 
                type="button" 
                onClick={toggleVoice}
                className={`p-4 rounded-2xl transition-all ${isListening ? 'bg-cyan-500 text-black scale-110 shadow-lg shadow-cyan-500/40' : 'bg-white/5 text-white/40 hover:bg-white/10'}`}
              >
                <Mic size={20} className={isListening ? 'animate-pulse' : ''} />
              </button>
              <button 
                type="submit"
                disabled={isProcessing}
                className="p-4 bg-indigo-600 hover:bg-indigo-500 rounded-2xl ml-2 transition-all disabled:opacity-50"
              >
                {isProcessing ? <Activity size={20} className="animate-spin" /> : <Send size={18} />}
              </button>
            </div>
          </form>

        <div className="flex justify-center gap-3 mt-6">
           <div className={`flex items-center gap-2 px-4 py-2 rounded-full border text-[9px] font-black uppercase tracking-widest ${mode ? 'bg-white/5 border-white/10 text-white/40' : 'bg-slate-50 border-slate-200 text-slate-400'}`}>
              <Zap size={10} className="text-amber-500" /> Neural Link Active
           </div>
           <div className={`flex items-center gap-2 px-4 py-2 rounded-full border text-[9px] font-black uppercase tracking-widest ${mode ? 'bg-white/5 border-white/10 text-white/40' : 'bg-slate-50 border-slate-200 text-slate-400'}`}>
              <Globe size={10} className="text-cyan-500" /> 6G Slim
           </div>
        </div>
      </div>

      <div className="grid grid-cols-4 gap-12 mt-4">
        {comms.map((item) => (
            <div key={item.id} onClick={item.action} className="flex flex-col items-center gap-4 group cursor-pointer">
              <div className={`w-24 h-24 rounded-[2rem] flex items-center justify-center transition-all group-hover:scale-110 group-hover:-translate-y-2 shadow-2xl border-b-[6px] border-black/20 bg-slate-800 text-white`}>
                {item.icon}
              </div>
              <span className={`text-[12px] font-black uppercase tracking-widest transition-opacity group-hover:opacity-100 ${mode ? 'text-white/60 opacity-40' : 'text-slate-500 opacity-60'}`}>
                {item.label}
              </span>
            </div>
        ))}
      </div>

      {history.length > 0 && (
         <div className={`mt-8 px-6 py-3 rounded-2xl border text-[10px] font-mono flex items-center gap-3 ${mode ? 'bg-white/5 border-white/5 text-white/20' : 'bg-slate-50 border-slate-100 text-slate-400'}`}>
            <Terminal size={14} />
            <span>Memory Loaded: {history[history.length-1].text.substring(0, 40)}...</span>
         </div>
      )}
    </div>
  );
};


// --- STAGE 2: INSTALL SPACE ---
const StageInstall = ({ mode, onInstallClick }) => (
  <div className="w-full flex flex-col items-center gap-6 animate-in fade-in zoom-in-95 duration-1000">
    <button 
      onClick={onInstallClick}
      className={`w-40 h-40 rounded-[3rem] border-4 border-dashed flex flex-col items-center justify-center cursor-pointer hover:border-indigo-500 hover:bg-indigo-500/5 transition-all group ${mode ? 'border-white/10' : 'border-slate-200'}`}
    >
      <Plus size={48} className={`transition-transform group-hover:rotate-90 ${mode ? 'text-white/20' : 'text-slate-300'}`} />
      <span className={`mt-4 text-[10px] font-black uppercase tracking-[0.2em] ${mode ? 'text-white/20' : 'text-slate-400'}`}>Install Hub</span>
    </button>
    <div className={`text-[10px] font-black uppercase tracking-widest opacity-30 ${mode ? 'text-white' : 'text-slate-900'}`}>
      Multi-modal App Expansion
    </div>
  </div>
);

export default App;
