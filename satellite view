
'use client';

import React, { useEffect, useRef, useState, useMemo, useCallback } from 'react';
import { useFirebase, useCollection, useMemoFirebase } from '@/firebase';
import { collection, onSnapshot, query } from 'firebase/firestore';
import Link from 'next/link';
import { ArrowLeft, Users, Zap, GitBranch, Radio, Satellite as SatelliteIcon, Activity, Database, ShieldCheck, Maximize2, Minimize2, Navigation, Crosshair } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { cn } from '@/lib/utils';
import * as THREE from 'three';
import maplibregl, { Map as MapLibreMap, Marker, Popup } from 'maplibre-gl';
import 'maplibre-gl/dist/maplibre-gl.css';

export default function SatelliteViewPage() {
    const { firestore } = useFirebase();
    const hasInitialized = useRef(false);
    const [userCount, setUserCount] = React.useState({ live: 0, total: 0 });
    const [networkLog, setNetworkLog] = useState([]);

    const universesQuery = useMemoFirebase(() => (!firestore ? null : query(collection(firestore, 'familyCores'))), [firestore]);
    const { data: familyCoresData } = useCollection(universesQuery);

    const familyNodes = useMemo(() => {
        if (!familyCoresData) return [];
        return familyCoresData.map(core => ({
            id: core.id,
            name: core.familyName || 'Unnamed Family',
            location: core.jurisdiction ? `${core.jurisdiction.province}, ${core.jurisdiction.country}` : 'Unknown Location',
            lat: core.lat || 46.4917,
            lng: core.lng || -80.9930,
            color: `#${core.id.substring(0, 6)}`,
            cities: [{ name: core.jurisdiction?.province || 'City', status: 'Optimal', pop: 'N/A' }],
            integrity: Math.random() * 0.1 + 0.9,
        }));
    }, [familyCoresData]);
    
    const threeContainerRef = useRef<HTMLDivElement>(null);
    const mapContainerRef = useRef<HTMLDivElement>(null);
    
    const [hoveredNode, setHoveredNode] = useState(familyNodes[0] || null);
    const [zoomLevel, setZoomLevel] = useState(500);
    const [isDetailView, setIsDetailView] = useState(false);

    const sceneRef = useRef<THREE.Scene | null>(null);
    const cameraRef = useRef<THREE.PerspectiveCamera | null>(null);
    const rendererRef = useRef<THREE.WebGLRenderer | null>(null);
    const globeGroupRef = useRef<THREE.Group | null>(null);
    const cloudsRef = useRef<THREE.Mesh | null>(null);
    const satellitesGroupRef = useRef<THREE.Group | null>(null);
    const mapRef = useRef<MapLibreMap | null>(null);
    
    const mouse = useMemo(() => new THREE.Vector2(), []);
    const raycaster = useMemo(() => new THREE.Raycaster(), []);
    
    useEffect(() => {
        if (!hoveredNode && familyNodes.length > 0) {
            setHoveredNode(familyNodes[0]);
        }
    }, [familyNodes, hoveredNode]);

    useEffect(() => {
        if (!firestore) return;
        const usersCol = collection(firestore, 'users');
        const unsubscribe = onSnapshot(usersCol, (snapshot) => {
            const total = snapshot.size;
            const live = Math.floor(total * (Math.random() * 0.2 + 0.8));
            setUserCount({ total, live });
        });
        return () => unsubscribe();
    }, [firestore]);
    
    useEffect(() => {
        const logInterval = setInterval(() => {
            const messages = ["Handshake ACK", "Packet Verified", "TruePath Sync", "Beacon Received", "Integrity Check PASS", "Node Ping", "Data Relay OK"];
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            const fromNode = `N${Math.floor(Math.random()*900)+100}`;
            const toNode = `N${Math.floor(Math.random()*900)+100}`;
            setNetworkLog(prev => [{ msg: `${randomMessage}: ${fromNode} <> ${toNode}`, time: new Date().toLocaleTimeString() }, ...prev.slice(0, 10)]);
        }, 3000);
        return () => clearInterval(logInterval);
    }, []);

    useEffect(() => {
        if (hasInitialized.current || !threeContainerRef.current || !mapContainerRef.current) return;
        
        let animationFrameId: number;
        
        const scene = new THREE.Scene();
        sceneRef.current = scene;
        
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 4000);
        camera.position.z = 500;
        cameraRef.current = camera;

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        threeContainerRef.current.appendChild(renderer.domElement);
        rendererRef.current = renderer;

        const map = new maplibregl.Map({
            container: mapContainerRef.current,
            style: `https://api.maptiler.com/maps/dataviz-dark/style.json?key=${process.env.NEXT_PUBLIC_MAPTILER_KEY || 'get-your-own-key'}`,
            center: [-79.38, 43.65],
            zoom: 2,
        });
        mapRef.current = map;
        
        map.on('load', () => {
            familyNodes.forEach(node => {
                const el = document.createElement('div');
                el.className = "w-3 h-3 rounded-full border-2 border-white cursor-pointer marker-pulse";
                el.style.backgroundColor = node.color;
                const popup = new Popup({ closeButton: false, closeOnClick: false }).setLngLat([node.lng, node.lat]).setHTML(`<div style="font-family: sans-serif; font-size: 12px; color: white; background: #111827; padding: 5px 10px; border-radius: 8px;"><strong style="color:${node.color};">${node.name}</strong><br>${node.location}<br>Integrity: ${(node.integrity * 100).toFixed(1)}%</div>`);
                const marker = new Marker({element: el}).setLngLat([node.lng, node.lat]).setPopup(popup).addTo(map);
                el.addEventListener('mouseenter', () => marker.togglePopup());
                el.addEventListener('mouseleave', () => marker.togglePopup());
            });
        });

        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const sun = new THREE.DirectionalLight(0xffffff, 1.2);
        sun.position.set(500, 300, 500);
        scene.add(sun);

        const globeGroup = new THREE.Group();
        globeGroupRef.current = globeGroup;
        scene.add(globeGroup);

        const loader = new THREE.TextureLoader();
        const textureUrl = 'https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg';
        const specUrl = 'https://threejs.org/examples/textures/planets/earth_specular_2048.jpg';
        const cloudUrl = 'https://threejs.org/examples/textures/planets/earth_clouds.png';
        
        const earthGeo = new THREE.SphereGeometry(150, 64, 64);
        const earthMat = new THREE.MeshPhongMaterial({ map: loader.load(textureUrl), specularMap: loader.load(specUrl), specular: new THREE.Color('grey'), shininess: 10 });
        const earth = new THREE.Mesh(earthGeo, earthMat);
        globeGroup.add(earth);
        
        const cloudGeo = new THREE.SphereGeometry(151, 64, 64);
        const cloudMat = new THREE.MeshPhongMaterial({ map: loader.load(cloudUrl), transparent: true, opacity: 0.2 });
        const clouds = new THREE.Mesh(cloudGeo, cloudMat);
        cloudsRef.current = clouds;
        globeGroup.add(clouds);

        const glowGeo = new THREE.SphereGeometry(155, 64, 64);
        const glowMat = new THREE.ShaderMaterial({ transparent: true, side: THREE.BackSide, uniforms: { glowColor: { value: new THREE.Color(0x00f2ff) }}, vertexShader: `varying vec3 vNormal; void main() { vNormal = normalize( normalMatrix * normal ); gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 ); }`, fragmentShader: `uniform vec3 glowColor; varying vec3 vNormal; void main() { float intensity = pow( 0.7 - dot( vNormal, vec3( 0.0, 0.0, 1.0 ) ), 4.0 ); pc_fragColor = vec4( glowColor, intensity ); }`});
        globeGroup.add(new THREE.Mesh(glowGeo, glowMat));

        const starGeo = new THREE.BufferGeometry();
        const starPos = [];
        for(let i=0; i<8000; i++) starPos.push((Math.random()-0.5)*3000, (Math.random()-0.5)*3000, (Math.random()-0.5)*3000);
        starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
        scene.add(new THREE.Points(starGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 1.2 })));

        const satGroup = new THREE.Group();
        satellitesGroupRef.current = satGroup;
        scene.add(satGroup);
        
        const posOnGlobe = (lat: number, lng: number, radius: number) => {
          const phi = (90 - lat) * (Math.PI / 180);
          const theta = (lng + 180) * (Math.PI / 180);
          return new THREE.Vector3(-radius * Math.sin(phi) * Math.cos(theta), radius * Math.cos(phi), radius * Math.sin(phi) * Math.sin(theta));
        };

        familyNodes.forEach(node => {
          const pos = posOnGlobe(node.lat, node.lng, 150);
          const nodeMarker = new THREE.Group();
          nodeMarker.position.copy(pos);
          nodeMarker.lookAt(new THREE.Vector3(0,0,0));
          nodeMarker.userData = { data: node }; 
          nodeMarker.name = "family_node";
          const dot = new THREE.Mesh(new THREE.SphereGeometry(2, 12, 12), new THREE.MeshBasicMaterial({ color: node.color }));
          nodeMarker.add(dot);
          const ring = new THREE.Mesh(new THREE.RingGeometry(3, 4, 32), new THREE.MeshBasicMaterial({ color: node.color, transparent: true, opacity: 0.8, side: THREE.DoubleSide }));
          ring.userData.isPulse = true;
          nodeMarker.add(ring);
          globeGroup.add(nodeMarker);
        });

        if (familyNodes.length >= 2) {
            const startPos = posOnGlobe(familyNodes[0].lat, familyNodes[0].lng, 151);
            const endPos = posOnGlobe(familyNodes[1].lat, familyNodes[1].lng, 151);
            const midPoint = new THREE.Vector3().addVectors(startPos, endPos).multiplyScalar(0.5).normalize().multiplyScalar(165);
            const curve = new THREE.QuadraticBezierCurve3(startPos, midPoint, endPos);
            const points = curve.getPoints(50);
            const curveGeometry = new THREE.BufferGeometry().setFromPoints(points);
            const lineMaterial = new THREE.LineBasicMaterial({ color: new THREE.Color('#ffffff'), linewidth: 2, transparent: true, opacity: 0.7 });
            globeGroup.add(new THREE.Line(curveGeometry, lineMaterial));
        }

        let isMouseDown = false; let startX = 0; let startY = 0;
        let targetRotationY = globeGroup.rotation.y;
        let targetRotationX = globeGroup.rotation.x;

        const handleWheel = (e: WheelEvent) => {
          if (!cameraRef.current || !globeGroupRef.current) return;
          camera.position.z += e.deltaY * 0.5;
          camera.position.z = Math.max(180, Math.min(camera.position.z, 1000));
          setZoomLevel(camera.position.z);
          const detailView = camera.position.z < 250;
          setIsDetailView(detailView);
          
          if(detailView && mapRef.current) {
            const euler = new THREE.Euler().setFromQuaternion(globeGroup.quaternion, 'YXZ');
            const centerLng = -THREE.MathUtils.radToDeg(euler.y) + 180;
            const centerLat = THREE.MathUtils.radToDeg(euler.x);
            map.setCenter([centerLng, centerLat]);
          }

          const mapZoomLevel = 1 - ( (camera.position.z - 180) / (1000-180) );
          if (mapRef.current) map.setZoom(mapZoomLevel * 5);
        };
        const handleMouseDown = (e: MouseEvent) => { isMouseDown = true; startX = e.clientX; startY = e.clientY; };
        const handleMouseUp = (e: MouseEvent) => { 
            isMouseDown = false;
            // Click to Focus logic
            if (Math.abs(e.clientX - startX) < 5 && Math.abs(e.clientY - startY) < 5) {
                if(hoveredNode) {
                    const nodePos = posOnGlobe(hoveredNode.lat, hoveredNode.lng, 1);
                    const euler = new THREE.Euler(Math.atan2(nodePos.y, Math.sqrt(nodePos.x * nodePos.x + nodePos.z * nodePos.z)), -Math.atan2(nodePos.z, -nodePos.x), 0, 'YXZ');
                    targetRotationX = euler.x;
                    targetRotationY = euler.y;
                }
            }
        };
        const handleMouseMove = (e: MouseEvent) => {
          mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
          mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
          if(isMouseDown && globeGroupRef.current) {
            const deltaX = e.clientX - startX; const deltaY = e.clientY - startY;
            targetRotationY += deltaX * 0.005; 
            targetRotationX += deltaY * 0.005;
            targetRotationX = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, targetRotationX));
            startX = e.clientX; startY = e.clientY;
          }
        };
        const handleResize = () => { if (!rendererRef.current || !cameraRef.current) return; camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); };
        window.addEventListener('resize', handleResize);
        window.addEventListener('wheel', handleWheel);
        window.addEventListener('mousedown', handleMouseDown);
        window.addEventListener('mouseup', handleMouseUp);
        window.addEventListener('mousemove', handleMouseMove);

        const animate = () => {
          animationFrameId = requestAnimationFrame(animate);
          if (globeGroupRef.current) {
            globeGroup.rotation.x += (targetRotationX - globeGroup.rotation.x) * 0.1;
            globeGroup.rotation.y += (targetRotationY - globeGroup.rotation.y) * 0.1;
          }

          if(!isMouseDown && globeGroupRef.current && !hoveredNode) {
            targetRotationY += 0.0005;
          }
          if(satellitesGroupRef.current) satellitesGroupRef.current.rotation.y += 0.001;
          if(cloudsRef.current) cloudsRef.current.rotation.y += 0.0001;
          
          if(globeGroupRef.current) {
              globeGroupRef.current.children.forEach(group => {
                if(group instanceof THREE.Group && group.name === "family_node") { group.children.forEach(c => { if(c.userData.isPulse) { c.scale.multiplyScalar(1.02); (c as THREE.Mesh<THREE.RingGeometry, THREE.MeshBasicMaterial>).material.opacity -= 0.02; if(c.scale.x > 4) { c.scale.set(1,1,1); (c as THREE.Mesh<THREE.RingGeometry, THREE.MeshBasicMaterial>).material.opacity = 0.8; } } }); }
              });
          }

          if(cameraRef.current) {
              raycaster.setFromCamera(mouse, cameraRef.current);
              const familyNodeMeshes = globeGroupRef.current?.children.filter(c => c.name === "family_node") || [];
              const hits = raycaster.intersectObjects(familyNodeMeshes, true);
              let found = null;
              if(hits.length > 0) { 
                let curr = hits[0].object; 
                while(curr.parent && !curr.userData.data) curr = curr.parent; 
                if(curr.userData.data) found = curr.userData.data; 
              }
              if (found) {
                setHoveredNode(found);
              }
          }
          if(rendererRef.current && sceneRef.current && cameraRef.current) rendererRef.current.render(sceneRef.current, cameraRef.current);
        };

        animate();
        hasInitialized.current = true;
        return () => { cancelAnimationFrame(animationFrameId); window.removeEventListener('resize', handleResize); window.removeEventListener('wheel', handleWheel); window.removeEventListener('mousedown', handleMouseDown); window.removeEventListener('mouseup', handleMouseUp); window.removeEventListener('mousemove', handleMouseMove); map?.remove(); if (threeContainerRef.current) threeContainerRef.current.innerHTML = ''; };
    }, [familyNodes]); 

    useEffect(() => {
        if (!satellitesGroupRef.current || !hasInitialized.current) return;
        
        const satellitesNeeded = Math.floor(userCount.total) + 1;
        
        while (satellitesGroupRef.current.children.length < satellitesNeeded) {
            const body = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 4), new THREE.MeshStandardMaterial({ color: 0xeeeeee, metalness: 0.8, roughness: 0.2 }));
            const panel1 = new THREE.Mesh(new THREE.BoxGeometry(8, 2, 0.1), new THREE.MeshStandardMaterial({ color: 0x0055aa, metalness: 1, emissive: 0x002244 }));
            panel1.position.x = 5;
            const panel2 = panel1.clone();
            panel2.position.x = -5;
            
            const satellite = new THREE.Group();
            satellite.add(body, panel1, panel2);

            const r = 180 + Math.random() * 40;
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.acos((Math.random() * 2) - 1);
            satellite.position.set(r * Math.cos(theta) * Math.sin(phi), r * Math.sin(theta) * Math.sin(phi), r * Math.cos(phi));
            satellite.lookAt(globeGroupRef.current?.position || new THREE.Vector3(0,0,0));
            satellitesGroupRef.current.add(satellite);
        }
        
        while (satellitesGroupRef.current.children.length > satellitesNeeded && satellitesGroupRef.current.children.length > 1) {
            satellitesGroupRef.current.remove(satellitesGroupRef.current.children[0]);
        }
    }, [userCount.total]);

    return (
        <div className="w-full h-screen bg-[#01030a] text-white font-sans overflow-hidden cursor-move">
            <style jsx global>{`
                body { margin: 0; background-color: #000205; color: #e6edf3; font-family: 'Inter', sans-serif; overflow: hidden; }
                canvas { display: block; }
                .maplibregl-canvas { display: block !important; }
            `}</style>

            <div ref={mapContainerRef} className="absolute inset-0 z-0" />
            <div ref={threeContainerRef} className="absolute inset-0 z-10" />

            <div className="absolute inset-x-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2 z-20 pointer-events-none"> <Crosshair size={48} className="text-white/20" /> </div>

            {/* TOP HUD */}
            <div className="absolute top-0 left-0 w-full p-10 flex justify-between items-start pointer-events-none z-30">
                <div className="space-y-1 pointer-events-auto">
                    <Link href="/admin/dashboard">
                         <Button variant="outline" className="backdrop-blur-md bg-black/30">
                            <ArrowLeft className="mr-2 h-4 w-4" /> Back to Dashboard
                        </Button>
                    </Link>
                </div>
                 <div className="pointer-events-auto flex gap-4">
                    <div className="bg-black/40 backdrop-blur-xl border border-white/10 p-5 rounded-2xl text-center">
                        <p className="text-[9px] text-slate-500 font-bold uppercase mb-1">Signal Strength</p>
                        <p className="text-2xl font-black mono text-white">-42<span className="text-xs text-yellow-500">dBm</span></p>
                    </div>
                     <div className="bg-black/40 backdrop-blur-xl border border-white/10 p-5 rounded-2xl text-center">
                        <p className="text-[9px] text-slate-500 font-bold uppercase mb-1">Live Users</p>
                        <p className="text-2xl font-black mono text-emerald-400">{userCount.live.toLocaleString()}</p>
                    </div>
                </div>
            </div>

            {/* LEFT TELEMETRY */}
            <div className="absolute left-10 top-1/2 -translate-y-1/2 space-y-4 pointer-events-none z-30">
                {[
                    { icon: Zap, label: "Power Grid", val: "NOMINAL", color: "text-yellow-400" },
                    { icon: GitBranch, label: "TruePath", val: "SYNCHED", color: "text-blue-400" },
                    { icon: ShieldCheck, label: "Safety Wall", val: "ENABLED", color: "text-emerald-400" },
                    { icon: Radio, label: "Deep Link", val: "ENCRYPTED", color: "text-pink-500" }
                ].map((item, i) => (
                    <div key={i} className="bg-black/40 backdrop-blur-xl border border-white/5 p-5 rounded-2xl w-56 pointer-events-auto hover:bg-black/60 transition-all border-l-4 hover:border-l-pink-500">
                        <div className="flex items-center gap-3 mb-1"><item.icon size={16} className="text-slate-500" /><span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{item.label}</span></div>
                        <div className={`text-sm font-mono font-black ${item.color}`}>{item.val}</div>
                    </div>
                ))}
                 <div className="bg-black/40 backdrop-blur-xl border border-white/5 p-5 rounded-2xl w-56 pointer-events-auto">
                    <h3 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Network Log</h3>
                    <div className="space-y-1 font-mono text-[9px]">
                        {networkLog.map((log, i) => (
                            <p key={i} className="text-slate-500 truncate"><span className="text-slate-600">{log.time}:</span> {log.msg}</p>
                        ))}
                    </div>
                </div>
            </div>

            {/* DYNAMIC HOVER/DETAIL CARD */}
            <div className="absolute right-10 top-1/2 -translate-y-1/2 z-30 pointer-events-auto">
                <div className="bg-black/60 backdrop-blur-3xl border border-white/10 p-8 rounded-[40px] shadow-2xl w-[400px] border-r-8"
                    style={{ borderColor: hoveredNode ? hoveredNode.color : '#ffffff10'}}>
                    <div className="flex justify-between items-start mb-6"><div className="w-12 h-12 bg-white/5 p-3 rounded-full mr-4"><Navigation size={24} className="text-white w-full h-full" /></div><div><span className="text-xs font-bold text-pink-500 uppercase tracking-widest">{hoveredNode?.location || "Global Scan"}</span><h2 className="text-4xl font-black text-white italic tracking-tighter">{hoveredNode?.name || "Global Mesh"}</h2></div></div>
                    <div className="space-y-6">
                        <div>
                            <p className="text-[10px] uppercase text-slate-500 font-bold mb-3 tracking-widest">Active City Distribution</p>
                            <div className="grid grid-cols-2 gap-3">
                            {(hoveredNode?.cities || []).map((city: any, i: number) => (<div key={i} className="bg-white/5 p-3 rounded-xl border border-white/5"><div className="flex justify-between items-center mb-1"><span className="text-xs font-bold">{city.name}</span><div className="w-1.5 h-1.5 rounded-full bg-emerald-500" /></div><div className="flex justify-between text-[9px] text-slate-400 font-mono"><span>{city.pop}</span><span className="text-emerald-500">{city.status}</span></div></div>))}
                            {!hoveredNode && <p className="text-xs text-slate-500 italic">No node selected. Hover over a point on the globe.</p>}
                            </div>
                        </div>
                        <div className="p-4 bg-pink-500/5 border border-pink-500/20 rounded-2xl"><div className="flex justify-between items-center mb-2"><span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Integrity Index</span><span className="text-xl font-black text-pink-500">{(hoveredNode?.integrity * 100 || 98).toFixed(1)}%</span></div><div className="w-full h-1.5 bg-white/5 rounded-full overflow-hidden"><div className="h-full bg-pink-500" style={{ width: `${(hoveredNode?.integrity * 100 || 98)}%` }} /></div></div>
                    </div>
                </div>
            </div>

            {/* ZOOM HINT */}
            <div className="absolute bottom-10 left-1/2 -translate-x-1/2 flex items-center gap-6 bg-black/40 backdrop-blur-xl px-8 py-4 rounded-full border border-white/10 z-30 pointer-events-none">
                <div className="flex items-center gap-2"><Minimize2 size={16} className="text-slate-500" /><span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Global View</span></div>
                <div className="w-48 h-1 bg-white/10 rounded-full relative overflow-hidden"><div className="absolute top-0 left-0 h-full bg-cyan-400 transition-all duration-300" style={{ width: `${((1000 - zoomLevel) / 820) * 100}%` }} /></div>
                <div className="flex items-center gap-2"><Maximize2 size={16} className="text-slate-500" /><span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Core Detail</span></div>
            </div>

            <div className="absolute bottom-10 right-10 z-30"><p className="text-[9px] font-mono text-slate-600 uppercase tracking-[0.5em]">Engine: Sovereign-VR // Real World 1:1 Mapping</p></div>
        </div>
    );
}

